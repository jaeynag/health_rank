<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Health Rank - Step42 (Fixed)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#0f1115; --card:#141826; --card2:#1b1f2a; --line:#2a3040;
    --txt:#eaeaf0; --mut:#8e93b5; --accent:#4c5cff; --accent2:#cfd3ff;
    --danger:#ff4c6a; --good:#36d399;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--txt)}
  .page{max-width:480px;margin:0 auto;padding:12px 12px 100px} /* Nav space */
  
  /* Utils */
  .section{margin:12px 0}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .card.active{border-color:rgba(76,92,255,.5)}
  .row{display:flex;gap:8px;align-items:center}
  .row.between{justify-content:space-between}
  .muted{color:var(--mut);font-size:12px}
  .divider{height:1px;background:var(--line);margin:12px 0;opacity:.5}
  .hidden{display:none !important}

  /* Buttons & Inputs */
  .btn{background:var(--card2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px;text-align:center;user-select:none;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.ghost{background:var(--card);border-color:var(--line)}
  .btn.small{padding:8px 12px;font-size:12px}
  .btn.danger{background:rgba(255,76,106,.14);border-color:rgba(255,76,106,.40);color:#ffd0d8}
  .input{width:100%;padding:12px;border-radius:12px;border:1px solid #23283a;background:rgba(255,255,255,.03);color:var(--txt);outline:none;font-size:16px}
  .input:focus{border-color:var(--accent)}
  .pill{padding:4px 10px;border-radius:99px;border:1px solid var(--line);font-size:12px;background:var(--card2);display:inline-block}
  
  /* Calendar */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-dow .cal-cell{color:var(--mut);font-size:11px;text-align:center;border:none;background:transparent;min-height:auto;padding:4px 0}
  .cal-cell{
    border:1px solid rgba(42,48,64,.7);background:rgba(255,255,255,.02);
    border-radius:10px;padding:6px 4px;min-height:54px;
    display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;
  }
  .cal-cell.today{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
  .cal-day{font-weight:900;font-size:13px}
  .cal-sub{font-size:10px;color:var(--accent2);width:100%;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  
  /* Exercise Accordion (Original Style) */
  .ex-card{margin-top:10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03);overflow:hidden}
  .ex-head{padding:12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;background:var(--card)}
  .ex-title{font-weight:900}
  .ex-sub{font-size:11px;color:var(--mut);margin-top:2px}
  .ex-body{border-top:1px solid var(--line);background:rgba(0,0,0,.1)}
  .ex-body.collapsed{display:none}

  /* Set Row & Swipe */
  .swipe{position:relative;overflow:hidden;border-bottom:1px solid rgba(255,255,255,.05);touch-action:pan-y}
  .swipe:last-child{border-bottom:none}
  .swipe-actions{position:absolute;top:0;right:0;bottom:0;width:80px;background:rgba(255,76,106,.2);display:flex;align-items:center;justify-content:center;color:#ff4c6a;font-weight:bold;font-size:12px;z-index:0}
  .swipe-front{position:relative;z-index:1;padding:12px;background:var(--card);transition:transform .2s ease;display:flex;justify-content:space-between;align-items:center}
  .swipe.open .swipe-front{transform:translateX(-80px)}
  .swipe-front.done{background:rgba(54,211,153,.08)}
  .swipe-front.done .set-val{color:var(--good)}
  
  .set-idx{width:30px;color:var(--mut);font-size:12px}
  .set-val{font-weight:900;font-variant-numeric:tabular-nums}
  .live-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);margin-right:8px;display:inline-block;opacity:0}
  .swipe-front.active .live-dot{opacity:1;animation:pulse 1.5s infinite}
  @keyframes pulse{0%{opacity:.5;transform:scale(1)}50%{opacity:1;transform:scale(1.5)}100%{opacity:.5;transform:scale(1)}}

  /* Overlays */
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;padding:16px}
  .overlay.show{display:flex}
  .drawer{width:100%;max-width:420px;background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;max-height:85vh}
  .drawer-head{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;background:var(--card2)}
  .drawer-body{padding:16px;overflow-y:auto;flex:1}
  
  /* Chips */
  .chipline{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  .chip{padding:8px 14px;border-radius:99px;border:1px solid var(--line);background:var(--card2);color:var(--mut);font-size:13px;cursor:pointer}
  .chip.active{background:rgba(76,92,255,.2);border-color:var(--accent);color:var(--accent2);font-weight:bold}
  
  /* Keypad */
  .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:12px}
  .key{background:var(--card2);border:1px solid var(--line);padding:14px;border-radius:10px;text-align:center;font-size:18px;font-weight:bold;cursor:pointer;user-select:none}
  .key:active{background:rgba(255,255,255,.1)}
  
  /* Toast */
  #toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:rgba(76,92,255,.95);color:#fff;padding:12px 24px;border-radius:30px;font-size:14px;font-weight:bold;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:opacity .3s;white-space:nowrap}
  #toast.show{opacity:1}

  /* Screens */
  .screen{display:none}
  .screen.active{display:block}
  
  /* Stat Bar for Detail */
  .stat-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:13px}
  .stat-bar-bg{flex:1;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
  .stat-bar-fill{height:100%;background:var(--accent)}
</style>
</head>
<body>

<div id="toast"></div>

<div id="screen-auth" class="screen active">
  <div class="page" style="display:flex;flex-direction:column;justify-content:center;min-height:80vh">
    <div class="card" style="padding:24px">
      <h2 style="margin:0 0 8px">Health Rank</h2>
      <p class="muted" style="margin:0 0 20px">로그인</p>
      <input type="text" id="authId" class="input" style="margin-bottom:10px" placeholder="아이디">
      <input type="password" id="authPw" class="input" style="margin-bottom:20px" placeholder="비밀번호">
      <div class="btn primary" id="btnLogin">로그인</div>
      <div class="muted" style="margin-top:12px;text-align:center" id="authMsg"></div>
    </div>
  </div>
</div>

<div id="screen-main" class="screen">
  <div class="page">
    <div class="row between" style="margin-bottom:12px">
      <div style="font-weight:900;font-size:18px">오늘</div>
      <div class="muted" id="clock">00:00</div>
    </div>

    <div class="section card">
      <div class="row between">
        <div>
          <div class="muted">내 티어</div>
          <div style="font-weight:900;font-size:24px;margin-top:4px" id="tierName">Unranked</div>
        </div>
        <div style="text-align:right">
          <div class="pill" id="tierScore">0 pt</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="btn primary" id="btnStartWork">운동 시작하기</div>
    </div>

    <div class="section card">
      <div class="row between" style="margin-bottom:12px">
        <div class="muted" id="calMonth">2025. 12</div>
        <div class="row">
          <div class="btn small ghost" id="calPrev">&lt;</div>
          <div class="btn small ghost" id="calNext">&gt;</div>
        </div>
      </div>
      <div class="cal-grid cal-dow">
        <div class="cal-cell">일</div><div class="cal-cell">월</div><div class="cal-cell">화</div><div class="cal-cell">수</div>
        <div class="cal-cell">목</div><div class="cal-cell">금</div><div class="cal-cell">토</div>
      </div>
      <div class="cal-grid" id="calBody" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<div id="screen-work" class="screen">
  <div class="page">
    <div class="card" style="position:sticky;top:12px;z-index:10;border-color:var(--accent);margin-bottom:12px">
      <div class="row between">
        <div class="row">
          <div class="live-dot" style="opacity:1;background:var(--danger)"></div>
          <div style="font-weight:900">운동 진행 중</div>
        </div>
        <div class="pill" id="workTimer">00:00:00</div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div class="btn primary" style="flex:1" id="btnAddPopup">종목 추가</div>
        <div class="btn danger" style="width:80px" id="btnEndWork">종료</div>
      </div>
    </div>

    <div id="exerciseList">
      <div class="muted" style="text-align:center;padding:40px 0">운동을 추가해주세요.</div>
    </div>
  </div>
</div>

<div class="overlay" id="overlayAdd">
  <div class="drawer">
    <div class="drawer-head">
      <div class="drawer-title">종목 추가</div>
      <div class="btn small ghost" onclick="closeOverlay('overlayAdd')">닫기</div>
    </div>
    <div class="drawer-body">
      <div class="muted" style="margin-bottom:8px">부위 선택</div>
      <div class="chipline" id="partChips">
        </div>
      
      <div class="muted" style="margin-bottom:8px;margin-top:12px">종목명</div>
      <input type="text" class="input" id="exNameInput" placeholder="예: 벤치프레스">
      
      <div class="btn primary" style="margin-top:20px" id="btnConfirmAdd">추가하기</div>
    </div>
  </div>
</div>

<div class="overlay" id="overlaySet">
  <div class="drawer">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="setTitle">1세트</div>
        <div class="muted" id="setSub" style="font-size:11px">-</div>
      </div>
      <div class="btn small ghost" onclick="closeOverlay('overlaySet')">닫기</div>
    </div>
    <div class="drawer-body">
      <div id="stepWeight">
        <div style="text-align:center;margin:10px 0">
          <div class="muted">무게 (KG)</div>
          <div style="font-size:36px;font-weight:900" id="valWeight">20</div>
        </div>
        <div class="kbd" id="kbdWeight"></div>
        <div class="btn primary" style="margin-top:20px" id="btnNextReps">다음 (횟수)</div>
      </div>
      <div id="stepReps" class="hidden">
        <div style="text-align:center;margin:10px 0">
          <div class="muted">횟수</div>
          <div style="font-size:36px;font-weight:900" id="valReps">10</div>
        </div>
        <div class="kbd" id="kbdReps"></div>
        <div class="row" style="margin-top:20px;gap:10px">
          <div class="btn ghost" style="flex:1" id="btnPrevWeight">이전</div>
          <div class="btn primary" style="flex:2" id="btnSaveSet">저장</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlayDetail">
  <div class="drawer">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="detailDate">날짜</div>
        <div class="muted">부위별 볼륨 (높은순)</div>
      </div>
      <div class="btn small ghost" onclick="closeOverlay('overlayDetail')">닫기</div>
    </div>
    <div class="drawer-body" id="detailBody"></div>
  </div>
</div>

<script>
// --- State & Config ---
const PARTS = ['가슴','등','하체','어깨','팔','복근','유산소'];
let state = {
  user: null,
  lastSelectedPart: '가슴', // Remember last choice
  workout: {
    active: false,
    startTime: null,
    list: [] // {id, part, name, sets:[{kg,reps,done}]}
  },
  calendar: {
    year: new Date().getFullYear(),
    month: new Date().getMonth()+1,
    data: {} // Mock Data
  }
};

// --- Helper Funcs ---
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const pad = n => n.toString().padStart(2,'0');

function showToast(msg) {
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function openOverlay(id) { $(`#${id}`).classList.add('show'); }
function closeOverlay(id) { $(`#${id}`).classList.remove('show'); }

// --- Auth & Init ---
$('#btnLogin').onclick = () => {
  const id = $('#authId').value;
  if(!id) return alert('아이디를 입력하세요.');
  const user = { id: 'u1', nick: '헬창꿈나무' };
  localStorage.setItem('hr_user', JSON.stringify(user));
  loginSuccess(user, false);
};

function checkSession() {
  const s = localStorage.getItem('hr_user');
  if(s) loginSuccess(JSON.parse(s), true);
  else $('#screen-auth').classList.add('active');
}

function loginSuccess(user, isAuto) {
  state.user = user;
  $('#screen-auth').classList.remove('active');
  $('#screen-main').classList.add('active');
  
  $('#tierName').textContent = 'Silver';
  $('#tierScore').textContent = '1250 pt';
  
  generateMockData();
  renderCalendar();
  
  if(isAuto) {
    showToast(`이전 로그인한 '${user.nick}'님으로 자동 로그인 됐습니다.`);
  }
}

// --- Main Screen ---
$('#btnStartWork').onclick = () => {
  state.workout.active = true;
  state.workout.startTime = Date.now();
  state.workout.list = [];
  startTimer();
  renderWorkoutList();
  
  $('#screen-main').classList.remove('active');
  $('#screen-work').classList.add('active');
};

let timerInt;
function startTimer() {
  if(timerInt) clearInterval(timerInt);
  const tick = () => {
    const diff = Math.floor((Date.now() - state.workout.startTime)/1000);
    const h = Math.floor(diff/3600);
    const m = Math.floor((diff%3600)/60);
    const s = diff%60;
    $('#workTimer').textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
  };
  timerInt = setInterval(tick, 1000);
  tick();
}

// --- Workout Logic (Original List Style) ---
$('#btnEndWork').onclick = () => {
  if(!confirm('운동을 종료하시겠습니까?')) return;
  
  // Save Mock
  const k = getTodayKey();
  let d = state.calendar.data[k] || {parts:{}, vol:0};
  state.workout.list.forEach(ex => {
    ex.sets.forEach(s => {
      const v = s.kg * s.reps;
      d.vol += v;
      d.parts[ex.part] = (d.parts[ex.part]||0) + v;
    });
  });
  state.calendar.data[k] = d;
  
  state.workout.active = false;
  clearInterval(timerInt);
  $('#screen-work').classList.remove('active');
  $('#screen-main').classList.add('active');
  renderCalendar();
  showToast('운동이 저장되었습니다.');
};

// Add Exercise Button -> Popup
$('#btnAddPopup').onclick = () => {
  // Render Chips
  const box = $('#partChips');
  box.innerHTML = '';
  PARTS.forEach(p => {
    const chip = document.createElement('div');
    chip.className = `chip ${p === state.lastSelectedPart ? 'active' : ''}`;
    chip.textContent = p;
    chip.onclick = () => {
      state.lastSelectedPart = p;
      $$('#partChips .chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
    };
    box.appendChild(chip);
  });
  
  $('#exNameInput').value = '';
  openOverlay('overlayAdd');
  $('#exNameInput').focus();
};

$('#btnConfirmAdd').onclick = () => {
  const name = $('#exNameInput').value.trim();
  if(!name) return alert('종목명을 입력하세요.');
  
  state.workout.list.push({
    id: Date.now(),
    part: state.lastSelectedPart,
    name: name,
    sets: []
  });
  closeOverlay('overlayAdd');
  renderWorkoutList();
};

// Render Exercise Cards (Accordion)
function renderWorkoutList() {
  const con = $('#exerciseList');
  con.innerHTML = '';
  if(state.workout.list.length === 0) {
    con.innerHTML = `<div class="muted" style="text-align:center;padding:40px 0">운동을 추가해주세요.</div>`;
    return;
  }
  
  state.workout.list.forEach((ex, idx) => {
    const card = document.createElement('div');
    card.className = 'ex-card';
    
    // Header
    const head = document.createElement('div');
    head.className = 'ex-head';
    head.innerHTML = `
      <div>
        <div class="ex-title">${ex.name}</div>
        <div class="ex-sub">${ex.part} · ${ex.sets.length}세트</div>
      </div>
      <div class="btn small primary" onclick="event.stopPropagation(); addSet(${idx})">+ 세트</div>
    `;
    
    // Body
    const body = document.createElement('div');
    body.className = 'ex-body';
    
    ex.sets.forEach((s, sIdx) => {
      const swipe = document.createElement('div');
      swipe.className = 'swipe';
      
      // Swipe Actions (Delete)
      const act = document.createElement('div');
      act.className = 'swipe-actions';
      act.textContent = '삭제';
      act.onclick = () => { ex.sets.splice(sIdx,1); renderWorkoutList(); };
      
      // Front Content
      const front = document.createElement('div');
      front.className = `swipe-front ${s.done ? 'done' : ''}`;
      front.innerHTML = `
        <div class="row">
          <div class="live-dot"></div>
          <div class="set-idx">${sIdx+1}</div>
          <div class="set-val">${s.kg}kg x ${s.reps}</div>
        </div>
        <div class="muted" style="font-size:11px">${s.done ? '완료' : '진행전'}</div>
      `;
      
      // Swipe Logic
      let tx = 0;
      front.ontouchstart = e => { tx = e.touches[0].clientX; };
      front.ontouchend = e => {
        if(tx - e.changedTouches[0].clientX > 50) swipe.classList.add('open');
        else swipe.classList.remove('open');
      };
      front.onclick = () => {
        // Toggle Done
        if(!swipe.classList.contains('open')) {
          s.done = !s.done;
          renderWorkoutList();
        }
      };

      swipe.append(act, front);
      body.appendChild(swipe);
    });

    // Accordion Toggle
    head.onclick = () => {
      body.classList.toggle('collapsed');
    };
    
    card.append(head, body);
    con.appendChild(card);
  });
}

// --- Set Input (Keypad) ---
let currentExIdx = null;
let tempSet = {kg:20, reps:10};

window.addSet = (idx) => {
  currentExIdx = idx;
  const ex = state.workout.list[idx];
  // Copy last set
  if(ex.sets.length > 0) tempSet = {...ex.sets[ex.sets.length-1], done:false};
  
  $('#setTitle').textContent = `${ex.sets.length+1}세트`;
  $('#setSub').textContent = ex.name;
  
  $('#stepWeight').classList.remove('hidden');
  $('#stepReps').classList.add('hidden');
  updateSetVal();
  openOverlay('overlaySet');
};

function updateSetVal() {
  $('#valWeight').textContent = tempSet.kg;
  $('#valReps').textContent = tempSet.reps;
}

// Draw Keypads
const drawKeys = (id, keys, cb) => {
  const b = $(id); b.innerHTML = '';
  keys.forEach(k => {
    const d = document.createElement('div');
    d.className = 'key';
    d.textContent = k;
    d.onclick = () => cb(k);
    b.appendChild(d);
  });
};

drawKeys('#kbdWeight', ['-5','-1','+1','+5','C','←'], k => {
  if(k==='C') tempSet.kg = 0;
  else if(k==='←') tempSet.kg = Math.floor(tempSet.kg/10);
  else tempSet.kg += parseInt(k);
  if(tempSet.kg<0) tempSet.kg=0;
  updateSetVal();
});

drawKeys('#kbdReps', ['-5','-1','+1','+5','10','12'], k => {
  tempSet.reps += parseInt(k);
  if(tempSet.reps<1) tempSet.reps=1;
  updateSetVal();
});

$('#btnNextReps').onclick = () => {
  $('#stepWeight').classList.add('hidden');
  $('#stepReps').classList.remove('hidden');
};
$('#btnPrevWeight').onclick = () => {
  $('#stepReps').classList.add('hidden');
  $('#stepWeight').classList.remove('hidden');
};
$('#btnSaveSet').onclick = () => {
  if(currentExIdx !== null) {
    state.workout.list[currentExIdx].sets.push({...tempSet});
    renderWorkoutList();
    closeOverlay('overlaySet');
  }
};


// --- Calendar Logic ---
function getTodayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function generateMockData() {
  const y = state.calendar.year, m = state.calendar.month;
  for(let i=1; i<25; i++) {
    if(Math.random()>.4) {
      state.calendar.data[`${y}-${pad(m)}-${pad(i)}`] = {
        vol: Math.floor(Math.random()*10000),
        parts: { '가슴': 5000, '삼두': 2000, '어깨': 1500 } // Simply hardcoded for demo
      };
    }
  }
}

function renderCalendar() {
  const y = state.calendar.year, m = state.calendar.month;
  $('#calMonth').textContent = `${y}. ${pad(m)}`;
  
  const fDay = new Date(y, m-1, 1).getDay();
  const lDate = new Date(y, m, 0).getDate();
  const b = $('#calBody'); b.innerHTML = '';
  
  for(let i=0; i<fDay; i++) b.appendChild(document.createElement('div'));
  
  for(let d=1; d<=lDate; d++) {
    const k = `${y}-${pad(m)}-${pad(d)}`;
    const data = state.calendar.data[k];
    const el = document.createElement('div');
    el.className = 'cal-cell';
    
    const today = new Date();
    if(today.getFullYear()===y && today.getMonth()+1===m && today.getDate()===d) el.classList.add('today');
    
    let sub = '';
    if(data) {
      // Find Max
      const sorted = Object.entries(data.parts).sort((a,b)=>b[1]-a[1]);
      if(sorted.length>0) sub = `<div class="cal-sub">${sorted[0][0]}</div>`;
      el.onclick = () => openCalDetail(k, data);
    }
    
    el.innerHTML = `<div class="cal-day">${d}</div>${sub}`;
    b.appendChild(el);
  }
}

$('#calPrev').onclick = () => {
  state.calendar.month--;
  if(state.calendar.month<1){state.calendar.month=12;state.calendar.year--;}
  renderCalendar();
};
$('#calNext').onclick = () => {
  state.calendar.month++;
  if(state.calendar.month>12){state.calendar.month=1;state.calendar.year++;}
  renderCalendar();
};

function openCalDetail(date, data) {
  $('#detailDate').textContent = date;
  const b = $('#detailBody'); b.innerHTML = '';
  
  const sorted = Object.entries(data.parts).sort((a,b)=>b[1]-a[1]);
  if(sorted.length===0) return;
  
  const max = sorted[0][1];
  
  sorted.forEach(([p, v]) => {
    const row = document.createElement('div');
    row.innerHTML = `
      <div class="row between" style="margin-bottom:4px;font-size:13px">
        <span style="font-weight:bold">${p}</span>
        <span class="muted">${v.toLocaleString()} kg</span>
      </div>
      <div class="stat-bar-bg">
        <div class="stat-bar-fill" style="width:${(v/max)*100}%"></div>
      </div>
      <div style="height:12px"></div>
    `;
    b.appendChild(row);
  });
  openOverlay('overlayDetail');
}

// Clock
setInterval(() => {
  const d = new Date();
  $('#clock').textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
}, 1000);

// Init
checkSession();

</script>
</body>
</html>
