<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Health Rank - Today (Step1.1)</title>
<style>
  :root{
    --bg:#0f1115; --card:#141826; --card2:#1b1f2a; --line:#2a3040;
    --txt:#eaeaf0; --mut:#8e93b5; --accent:#4c5cff; --accent2:#cfd3ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--txt)}
  .page{max-width:480px;margin:0 auto;padding:12px;padding-bottom:24px}
  .header{position:sticky;top:0;background:var(--bg);padding:6px 0;border-bottom:1px solid #1f2430;z-index:20}

  /* Ticker */
  .ticker-wrap{overflow:hidden;white-space:nowrap;border-radius:10px}
  .ticker-touch{cursor:pointer}
  .ticker{
    display:inline-block;
    padding-left:100%;
    animation: marquee 18s linear infinite;
    will-change:transform;
  }
  .ticker span{
    display:inline-block;
    margin-right:24px;
    color:var(--accent2);
    animation:pulse 1.6s ease-in-out infinite;
  }
  .paused .ticker{animation-play-state:paused}
  .paused .ticker span{animation-play-state:paused}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  @keyframes pulse{0%,100%{opacity:.85;text-shadow:none}50%{opacity:1;text-shadow:0 0 6px rgba(120,140,255,.6)}}

  /* UI */
  .section{margin:12px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .row.between{justify-content:space-between}
  .muted{color:var(--mut);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .btn{background:var(--card2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px;text-align:center;user-select:none}
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.ghost{background:var(--card);border-color:var(--line)}
  .btn.small{padding:8px 10px;border-radius:12px}
  .btn.disabled{opacity:.45;pointer-events:none}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);user-select:none}
  .pill.tap{cursor:pointer}
  .divider{height:1px;background:var(--line);margin:10px 0;opacity:.8}

  /* Exercise card */
  .ex-title{font-weight:700}
  .timer{font-variant-numeric:tabular-nums;letter-spacing:.06em}
  .timer.paused{opacity:.85}
  .hint{font-size:12px;color:var(--mut)}
  .collapse{display:none}
  .ex-card.completed .details{display:none}
  .ex-card.completed .collapse{display:block}
  .sets-placeholder{margin-top:8px;border-top:1px dashed var(--line);padding-top:8px;color:var(--mut);font-size:12px}

  /* Overlay */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:center;padding:12px;z-index:60}
  .overlay.show{display:flex}
  .drawer{width:min(480px,100%);margin-top:56px;background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .drawer-title{font-weight:800}
  .drawer-sub{color:var(--mut);font-size:12px;margin-top:2px}
  .drawer-body{max-height:70vh;overflow:auto}
  .rank-row{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed var(--line)}
  .rank-left{display:flex;gap:10px;align-items:center;min-width:0}
  .rank-badge{width:28px;text-align:center;color:var(--accent2)}
  .rank-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .rank-val{color:var(--txt)}

  /* Weight keypad */
  .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .key{padding:14px;border-radius:12px;background:var(--card2);border:1px solid var(--line);text-align:center;user-select:none}
  .key.disabled{opacity:.4;pointer-events:none}
  .big{font-size:28px;letter-spacing:.08em;font-variant-numeric:tabular-nums}
  .center{text-align:center}
</style>
</head>
<body>
<div class="page" id="app">
  <div class="header">
    <div class="ticker-wrap ticker-touch" id="tickerWrap" title="ëˆ„ë¥´ë©´ Top10">
      <div class="ticker" id="ticker">
        <span>í•˜ì²´ ğŸ¥‡ jaeyang 8,420kg</span>
        <span>í•˜ì²´ ğŸ¥ˆ userB 7,980kg</span>
        <span>í•˜ì²´ ğŸ¥‰ userC 7,450kg</span>
      </div>
    </div>
  </div>

  <!-- Part picker -->
  <div class="section card" id="partCard">
    <div class="row between">
      <div>
        <div class="muted">ì˜¤ëŠ˜ ìš´ë™</div>
        <div style="font-weight:800;margin-top:2px">ë¶€ìœ„ ì„ íƒ</div>
      </div>
      <div class="pill">ê¸°ë³¸: ì›¨ì´íŠ¸</div>
    </div>
    <div class="divider"></div>
    <div class="grid" id="partGrid">
      <div class="btn" data-part="ê°€ìŠ´">ê°€ìŠ´</div>
      <div class="btn" data-part="ë“±">ë“±</div>
      <div class="btn" data-part="í•˜ì²´">í•˜ì²´</div>
      <div class="btn" data-part="ì–´ê¹¨">ì–´ê¹¨</div>
      <div class="btn" data-part="íŒ”">íŒ”</div>
      <div class="btn" data-part="ë³µê·¼">ë³µê·¼</div>
      <div class="btn primary" data-part="ìœ ì‚°ì†Œ">ìœ ì‚°ì†Œ</div>
    </div>
  </div>

  <!-- Selected part + exercises -->
  <div class="section card" id="workCard" style="display:none">
    <div class="row between">
      <div class="row" style="gap:10px">
        <div class="btn small ghost" id="backBtn" title="ë¶€ìœ„ ë‹¤ì‹œ ì„ íƒ">â†</div>
        <div>
          <div class="muted">ì„ íƒ ë¶€ìœ„</div>
          <div style="font-weight:900" id="selectedPart">-</div>
        </div>
      </div>
      <div class="muted" id="todaySmall"></div>
    </div>
    <div class="divider"></div>

    <div id="exerciseList"></div>

    <div class="divider"></div>
    <div class="row">
      <div class="btn ghost" style="flex:0.38" id="addPartBtn">ë¶€ìœ„ ì¶”ê°€</div>
      <div class="btn ghost" style="flex:0.62" id="addExerciseBtn">ì¢…ëª© ì¶”ê°€</div>
    </div>
  </div>

  <div class="section">
    <div class="btn" id="endBtn">ìš´ë™ ì¢…ë£Œ</div>
  </div>
</div>

<!-- Top10 overlay -->
<div class="overlay" id="overlayTop10" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="Top10">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="top10Title">Top 10 Â· í•˜ì²´(ì˜¤ëŠ˜)</div>
        <div class="drawer-sub">ê°™ì€ ì²´ê¸‰ Â· ì„±ë³„ Â· ë¶€ìœ„ ê¸°ì¤€</div>
      </div>
      <div class="btn ghost small" id="closeTop10">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body" id="top10Body"></div>
  </div>
</div>

<!-- Add exercise prompt -->
<div class="overlay" id="overlayPrompt" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ì¢…ëª© ì¶”ê°€">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">ì¢…ëª© ì¶”ê°€</div>
        <div class="drawer-sub" id="promptSub">ì„ íƒ ë¶€ìœ„ì— ì¢…ëª©ì„ ì¶”ê°€í•´</div>
      </div>
      <div class="btn ghost small" id="closePrompt">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body" style="padding:12px">
      <input type="text" id="exerciseName" placeholder="ì˜ˆ) ë²¤ì¹˜í”„ë ˆìŠ¤"
        style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0c0e13;color:var(--txt);outline:none;">
      <div class="row" style="margin-top:12px">
        <div class="btn primary" style="flex:1" id="confirmAdd">ì¶”ê°€</div>
      </div>
      <div class="hint" style="margin-top:10px">ì¢…ëª© ì¶”ê°€ ìˆœê°„ì— íƒ€ì´ë¨¸ê°€ ì‹œì‘ë¼.</div>
    </div>
  </div>
</div>

<!-- Weight keypad overlay -->
<div class="overlay" id="overlayWeight" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ë¬´ê²Œ ì…ë ¥">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">ë¬´ê²Œ ì…ë ¥</div>
        <div class="drawer-sub" id="weightSub">-</div>
      </div>
      <div class="btn ghost small" id="closeWeight">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body" style="padding:12px">
      <div class="center">
        <div class="muted">í˜„ì¬ ë¬´ê²Œ</div>
        <div class="big"><span id="weightVal">0.0</span> <span class="pill">KG</span></div>
      </div>
      <div class="row" style="justify-content:center;margin:10px 0">
        <div class="pill tap" id="incBtn">ì¦</div>
        <div class="pill tap" id="decBtn">ê°</div>
      </div>
      <div class="kbd">
        <div class="key" id="barKey">BAR</div>
        <div class="key" data-d="0.25">0.25</div>
        <div class="key" data-d="0.5">0.5</div>
        <div class="key" data-d="1">1</div>
        <div class="key" data-d="2.5">2.5</div>
        <div class="key" data-d="5">5</div>
        <div class="key" data-d="10">10</div>
        <div class="key" data-d="20">20</div>
        <div class="key" id="backKey">â†</div>
      </div>
      <div class="hint" style="margin-top:10px">â† ê¸¸ê²Œ ëˆ„ë¥´ë©´ ì „ì²´ ì·¨ì†Œ</div>
    </div>
  </div>
</div>

<script>
  const qs=(s,el=document)=>el.querySelector(s);
  const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
  const pad=n=>String(n).padStart(2,'0');
  function fmtHMS(ms){
    ms=Math.max(0,ms);
    const s=Math.floor(ms/1000);
    const h=Math.floor(s/3600);
    const m=Math.floor((s%3600)/60);
    const ss=s%60;
    return `${pad(h)}:${pad(m)}:${pad(ss)}`;
  }

  const state = {
    selectedPart:null,
    exercises:[], // {id, part, name, createdAt, paused, pauseAt, pausedMs, completed, activeMs, weightKg, barUsed, weightHist:[]}
    weightMode: "inc",
  };

  // Top10
  const app = qs('#app');
  const tickerWrap = qs('#tickerWrap');
  const overlayTop10 = qs('#overlayTop10');
  const closeTop10 = qs('#closeTop10');
  const top10Body = qs('#top10Body');
  const top10Title = qs('#top10Title');
  const sampleTop10 = Array.from({length:10}, (_,i)=>({rank:i+1,name:`user${String.fromCharCode(65+i)}`,vol:(8420- i*240).toLocaleString()+"kg"}));
  function renderTop10(){
    top10Body.innerHTML="";
    for(const r of sampleTop10){
      const row=document.createElement('div');
      row.className="rank-row";
      row.innerHTML = `
        <div class="rank-left">
          <div class="rank-badge">${r.rank}</div>
          <div class="rank-name">${r.name}</div>
        </div>
        <div class="rank-val">${r.vol}</div>
      `;
      top10Body.appendChild(row);
    }
  }
  function openTop10(){
    top10Title.textContent = `Top 10 Â· ${(state.selectedPart||"í•˜ì²´")}(ì˜¤ëŠ˜)`;
    renderTop10();
    app.classList.add('paused');
    overlayTop10.classList.add('show');
    overlayTop10.setAttribute('aria-hidden','false');
  }
  function closeTop10Fn(){
    overlayTop10.classList.remove('show');
    overlayTop10.setAttribute('aria-hidden','true');
    app.classList.remove('paused');
  }
  tickerWrap.addEventListener('click', openTop10);
  closeTop10.addEventListener('click', closeTop10Fn);
  overlayTop10.addEventListener('click', (e)=>{ if(e.target===overlayTop10) closeTop10Fn(); });

  // Navigation
  const partCard = qs('#partCard');
  const workCard = qs('#workCard');
  const selectedPartEl = qs('#selectedPart');
  const todaySmall = qs('#todaySmall');
  const exerciseList = qs('#exerciseList');
  const backBtn = qs('#backBtn');
  const addPartBtn = qs('#addPartBtn');
  const addExerciseBtn = qs('#addExerciseBtn');
  const endBtn = qs('#endBtn');

  function showPartPicker(){
    state.selectedPart=null;
    partCard.style.display="";
    workCard.style.display="none";
  }
  function showWork(part){
    state.selectedPart=part;
    selectedPartEl.textContent=part;
    todaySmall.textContent=new Date().toISOString().slice(0,10);
    partCard.style.display="none";
    workCard.style.display="";
    renderExercises();
  }
  qsa('#partGrid .btn').forEach(b=>b.addEventListener('click', ()=>showWork(b.dataset.part)));
  backBtn.addEventListener('click', showPartPicker);
  addPartBtn.addEventListener('click', showPartPicker);

  // Add exercise prompt
  const overlayPrompt = qs('#overlayPrompt');
  const closePrompt = qs('#closePrompt');
  const promptSub = qs('#promptSub');
  const exerciseName = qs('#exerciseName');
  const confirmAdd = qs('#confirmAdd');

  function openPrompt(){
    if(!state.selectedPart) return;
    promptSub.textContent = `ì„ íƒ ë¶€ìœ„: ${state.selectedPart}`;
    exerciseName.value="";
    overlayPrompt.classList.add('show');
    overlayPrompt.setAttribute('aria-hidden','false');
    setTimeout(()=>exerciseName.focus(),50);
  }
  function closePromptFn(){
    overlayPrompt.classList.remove('show');
    overlayPrompt.setAttribute('aria-hidden','true');
  }
  addExerciseBtn.addEventListener('click', openPrompt);
  closePrompt.addEventListener('click', closePromptFn);
  overlayPrompt.addEventListener('click', (e)=>{ if(e.target===overlayPrompt) closePromptFn(); });

  function addExercise(name){
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random();
    state.exercises.push({
      id, part:state.selectedPart, name,
      createdAt:Date.now(), paused:false, pauseAt:null, pausedMs:0,
      completed:false, activeMs:0,
      weightKg:0.0, barUsed:false, weightHist:[]
    });
    renderExercises();
  }
  confirmAdd.addEventListener('click', ()=>{
    const name=(exerciseName.value||"").trim();
    if(!name) return;
    closePromptFn();
    addExercise(name);
  });
  exerciseName.addEventListener('keydown', (e)=>{ if(e.key==="Enter") confirmAdd.click(); });

  // Weight keypad overlay
  const overlayWeight = qs('#overlayWeight');
  const closeWeight = qs('#closeWeight');
  const weightSub = qs('#weightSub');
  const weightVal = qs('#weightVal');
  const incBtn = qs('#incBtn');
  const decBtn = qs('#decBtn');
  const barKey = qs('#barKey');
  const backKey = qs('#backKey');

  let currentExId = null;

  function setMode(mode){
    state.weightMode = mode;
    incBtn.style.borderColor = (mode==="inc") ? "var(--accent)" : "var(--line)";
    decBtn.style.borderColor = (mode==="dec") ? "var(--accent)" : "var(--line)";
    incBtn.style.color = (mode==="inc") ? "var(--accent2)" : "var(--txt)";
    decBtn.style.color = (mode==="dec") ? "var(--accent2)" : "var(--txt)";
  }
  setMode("inc");

  function openWeight(ex){
    currentExId = ex.id;
    weightSub.textContent = `${ex.part} Â· ${ex.name}`;
    weightVal.textContent = ex.weightKg.toFixed(2).replace(/\.00$/,".0");
    barKey.classList.toggle('disabled', ex.barUsed);
    overlayWeight.classList.add('show');
    overlayWeight.setAttribute('aria-hidden','false');
  }
  function closeWeightFn(){
    overlayWeight.classList.remove('show');
    overlayWeight.setAttribute('aria-hidden','true');
    currentExId = null;
  }
  closeWeight.addEventListener('click', closeWeightFn);
  overlayWeight.addEventListener('click', (e)=>{ if(e.target===overlayWeight) closeWeightFn(); });

  incBtn.addEventListener('click', ()=>setMode("inc"));
  decBtn.addEventListener('click', ()=>setMode("dec"));

  function applyDelta(ex, delta){
    const signed = (state.weightMode==="inc") ? delta : -delta;
    ex.weightKg = Math.max(0, +(ex.weightKg + signed).toFixed(2));
    ex.weightHist.push({delta:signed, bar:false});
    weightVal.textContent = ex.weightKg.toFixed(2).replace(/\.00$/,".0");
  }

  qsa('.key[data-d]').forEach(k=>{
    k.addEventListener('click', ()=>{
      const ex = state.exercises.find(e=>e.id===currentExId);
      if(!ex) return;
      applyDelta(ex, parseFloat(k.dataset.d));
      renderExercises(false);
    });
  });

  barKey.addEventListener('click', ()=>{
    const ex = state.exercises.find(e=>e.id===currentExId);
    if(!ex || ex.barUsed) return;
    // BAR only once
    applyDelta(ex, 20);
    ex.barUsed = true;
    barKey.classList.add('disabled');
    renderExercises(false);
  });

  // backspace: tap undo last, longpress clear all
  let pressTimer = null;
  function undoLast(ex){
    const last = ex.weightHist.pop();
    if(!last) return;
    ex.weightKg = Math.max(0, +(ex.weightKg - last.delta).toFixed(2));
    // if last came from BAR, allow BAR again. we don't store bar marker separately now, but detect if abs(delta)==20 and barUsed
    if(Math.abs(last.delta)===20 && ex.barUsed){
      // If current weightHist contains any 20-from-bar? Hard to know; for prototype allow re-enable when we undo the first BAR press.
      ex.barUsed = false;
      barKey.classList.remove('disabled');
    }
    weightVal.textContent = ex.weightKg.toFixed(2).replace(/\.00$/,".0");
  }
  function clearAll(ex){
    ex.weightKg = 0;
    ex.weightHist = [];
    ex.barUsed = false;
    weightVal.textContent = "0.0";
    barKey.classList.remove('disabled');
  }

  backKey.addEventListener('pointerdown', ()=>{
    const ex = state.exercises.find(e=>e.id===currentExId);
    if(!ex) return;
    pressTimer = setTimeout(()=>{ clearAll(ex); renderExercises(false); }, 650);
  });
  backKey.addEventListener('pointerup', ()=>{
    const ex = state.exercises.find(e=>e.id===currentExId);
    if(!ex) return;
    if(pressTimer){
      clearTimeout(pressTimer);
      pressTimer = null;
      undoLast(ex);
      renderExercises(false);
    }
  });
  backKey.addEventListener('pointerleave', ()=>{
    if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; }
  });

  // Timers
  function getActiveMs(ex){
    if(ex.completed) return ex.activeMs;
    const now = Date.now();
    const pausedNow = ex.paused ? (now - ex.pauseAt) : 0;
    return (now - ex.createdAt) - ex.pausedMs - pausedNow;
  }

  function renderExercises(full=true){
    const list = state.exercises.filter(e=>e.part===state.selectedPart);
    if(full) exerciseList.innerHTML = "";

    if(state.selectedPart === "ìœ ì‚°ì†Œ"){
      if(full){
        const box=document.createElement('div');
        box.className="card";
        box.innerHTML = `<div class="row between"><div class="ex-title">ìœ ì‚°ì†Œ</div><div class="pill">ì•¼ì™¸ Â· ì‹¤ë‚´ (ì¶”í›„)</div></div>
          <div class="divider"></div><div class="muted">ìœ ì‚°ì†Œ ì…ë ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¶™ì¼ê²Œ.</div>`;
        exerciseList.appendChild(box);
      }
      return;
    }

    if(full && list.length===0){
      const empty=document.createElement('div');
      empty.className="muted";
      empty.style.padding="6px 2px";
      empty.textContent="ì¢…ëª©ì„ ì¶”ê°€í•´ì¤˜.";
      exerciseList.appendChild(empty);
      return;
    }

    if(full){
      for(const ex of list){
        const card=document.createElement('div');
        card.className="card ex-card" + (ex.completed ? " completed":"");
        card.dataset.id = ex.id;

        const timeText = fmtHMS(ex.completed ? ex.activeMs : getActiveMs(ex));

        card.innerHTML = `
          <div class="row between">
            <div>
              <div class="muted">${ex.part}</div>
              <div class="ex-title">${ex.name}</div>
            </div>
            <div class="pill tap timer ${ex.paused ? "paused":""}" data-action="timer" title="íƒ­: ì¼ì‹œì •ì§€/ì¬ê°œ">
              â± <span class="timer-val">${timeText}</span> ${ex.paused ? "â¸":""}
            </div>
          </div>

          <div class="details">
            <div class="sets-placeholder">STEP1.1: ë¬´ê²Œ ì…ë ¥ í‚¤íŒ¨ë“œë§Œ ë¨¼ì € ë¶™ì˜€ì–´. (ì„¸íŠ¸ ì €ì¥ì€ ë‹¤ìŒ ë‹¨ê³„)</div>
            <div class="row" style="margin-top:10px">
              <div class="btn ghost" style="flex:1" data-action="weight">ë¬´ê²Œ ì…ë ¥</div>
              <div class="btn ghost" style="flex:1" data-action="complete">ì¢…ëª© ì™„ë£Œ</div>
            </div>
          </div>

          <div class="collapse">
            <div class="divider"></div>
            <div class="row between">
              <div class="muted">ìš”ì•½</div>
              <div class="muted">íƒ­í•˜ë©´ í¼ì³ì§</div>
            </div>
            <div style="margin-top:6px">
              <div class="row between"><div>í›ˆë ¨ì‹œê°„</div><div class="timer">${fmtHMS(ex.activeMs)}</div></div>
              <div class="row between" style="margin-top:4px"><div class="muted">í˜„ì¬ ë¬´ê²Œ</div><div class="muted">${ex.weightKg.toFixed(2).replace(/\.00$/,".0")} kg</div></div>
            </div>
          </div>
        `;

        card.addEventListener('click', (ev)=>{
          const a = ev.target.closest('[data-action]');
          if(a){
            ev.preventDefault(); ev.stopPropagation();
            const action = a.dataset.action;
            if(action==="timer"){
              if(ex.completed) return;
              if(!ex.paused){ ex.paused=true; ex.pauseAt=Date.now(); }
              else { ex.paused=false; ex.pausedMs += (Date.now()-ex.pauseAt); ex.pauseAt=null; }
              renderExercises();
            }
            if(action==="weight"){
              openWeight(ex);
            }
            if(action==="complete"){
              if(ex.completed) return;
              const now=Date.now();
              const pausedExtra = ex.paused ? (now - ex.pauseAt) : 0;
              ex.activeMs = (now - ex.createdAt) - ex.pausedMs - pausedExtra;
              ex.completed=true;
              ex.paused=false; ex.pauseAt=null;
              renderExercises();
            }
            return;
          }
          // click collapsed to reopen (prototype)
          if(ex.completed){
            ex.completed=false;
            const now=Date.now();
            ex.createdAt = now - ex.activeMs;
            ex.pausedMs = 0; ex.activeMs = 0;
            renderExercises();
          }
        });

        exerciseList.appendChild(card);
      }
    } else {
      // lightweight updates (weights)
      // no-op; the UI will reflect on next render or close
    }
  }

  // tick visible timers
  setInterval(()=>{
    if(!state.selectedPart) return;
    const list = state.exercises.filter(e=>e.part===state.selectedPart && !e.completed);
    if(list.length===0) return;
    for(const ex of list){
      const card = qs(`.ex-card[data-id="${ex.id}"]`, exerciseList);
      if(!card) continue;
      const v = qs('.timer-val', card);
      if(v) v.textContent = fmtHMS(getActiveMs(ex));
    }
  }, 250);

  endBtn.addEventListener('click', ()=>{
    if(!confirm("ì˜¤ëŠ˜ ìš´ë™ì„ ì¢…ë£Œí• ê¹Œ? (ìš”ì•½ í™”ë©´ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ)")) return;
    alert("STEP1.1ì—ì„œëŠ” ì•„ì§ 'ì˜¤ëŠ˜ ìš”ì•½ í™”ë©´'ì´ ë¶™ê¸° ì „ì´ì•¼. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¶™ì¼ê²Œ.");
  });

  showPartPicker();
</script>
</body>
</html>
