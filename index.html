<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Health Rank - Today (Step1)</title>
<style>
  :root{
    --bg:#0f1115; --card:#141826; --card2:#1b1f2a; --line:#2a3040;
    --txt:#eaeaf0; --mut:#8e93b5; --accent:#4c5cff; --accent2:#cfd3ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--txt)}
  .page{max-width:480px;margin:0 auto;padding:12px;padding-bottom:24px}
  .header{position:sticky;top:0;background:var(--bg);padding:6px 0;border-bottom:1px solid #1f2430;z-index:20}

  /* Ticker */
  .ticker-wrap{overflow:hidden;white-space:nowrap;border-radius:10px}
  .ticker-touch{cursor:pointer}
  .ticker{
    display:inline-block;
    padding-left:100%;
    animation: marquee 18s linear infinite;
    will-change:transform;
  }
  .ticker span{
    display:inline-block;
    margin-right:24px;
    color:var(--accent2);
    animation:pulse 1.6s ease-in-out infinite;
  }
  .paused .ticker{animation-play-state:paused}
  .paused .ticker span{animation-play-state:paused}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  @keyframes pulse{0%,100%{opacity:.85;text-shadow:none}50%{opacity:1;text-shadow:0 0 6px rgba(120,140,255,.6)}}

  /* UI */
  .section{margin:12px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .row.between{justify-content:space-between}
  .muted{color:var(--mut);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .btn{background:var(--card2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px;text-align:center;user-select:none}
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.ghost{background:var(--card);border-color:var(--line)}
  .btn.small{padding:8px 10px;border-radius:12px}
  .btn.disabled{opacity:.45;pointer-events:none}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);user-select:none}
  .pill.tap{cursor:pointer}
  .divider{height:1px;background:var(--line);margin:10px 0;opacity:.8}

  /* Exercise card */
  .ex-title{font-weight:700}
  .timer{font-variant-numeric:tabular-nums;letter-spacing:.06em}
  .timer.paused{opacity:.85}
  .hint{font-size:12px;color:var(--mut)}
  .collapse{display:none}
  .ex-card.completed .details{display:none}
  .ex-card.completed .collapse{display:block}
  .sets-placeholder{margin-top:8px;border-top:1px dashed var(--line);padding-top:8px;color:var(--mut);font-size:12px}

  /* Overlay (Top10 + Prompt) */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:center;padding:12px;z-index:60}
  .overlay.show{display:flex}
  .drawer{width:min(480px,100%);margin-top:56px;background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .drawer-title{font-weight:800}
  .drawer-sub{color:var(--mut);font-size:12px;margin-top:2px}
  .drawer-body{max-height:60vh;overflow:auto}
  .rank-row{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed var(--line)}
  .rank-left{display:flex;gap:10px;align-items:center;min-width:0}
  .rank-badge{width:28px;text-align:center;color:var(--accent2)}
  .rank-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .rank-val{color:var(--txt)}
  .prompt-body{padding:12px}
  input[type="text"]{
    width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
    background:#0c0e13;color:var(--txt);outline:none;
  }
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:var(--card2);color:#fff;user-select:none;cursor:pointer;font-size:13px}
</style>
</head>
<body>
<div class="page" id="app">
  <div class="header">
    <div class="ticker-wrap ticker-touch" id="tickerWrap" title="ëˆ„ë¥´ë©´ Top10">
      <div class="ticker" id="ticker">
        <span id="t1">í•˜ì²´ ğŸ¥‡ jaeyang 8,420kg</span>
        <span id="t2">í•˜ì²´ ğŸ¥ˆ userB 7,980kg</span>
        <span id="t3">í•˜ì²´ ğŸ¥‰ userC 7,450kg</span>
      </div>
    </div>
  </div>

  <!-- Part picker -->
  <div class="section card" id="partCard">
    <div class="row between">
      <div>
        <div class="muted">ì˜¤ëŠ˜ ìš´ë™</div>
        <div style="font-weight:800;margin-top:2px">ë¶€ìœ„ ì„ íƒ</div>
      </div>
      <div class="pill">ê¸°ë³¸: ì›¨ì´íŠ¸</div>
    </div>
    <div class="divider"></div>
    <div class="grid" id="partGrid">
      <div class="btn" data-part="ê°€ìŠ´">ê°€ìŠ´</div>
      <div class="btn" data-part="ë“±">ë“±</div>
      <div class="btn" data-part="í•˜ì²´">í•˜ì²´</div>
      <div class="btn" data-part="ì–´ê¹¨">ì–´ê¹¨</div>
      <div class="btn" data-part="íŒ”">íŒ”</div>
      <div class="btn" data-part="ë³µê·¼">ë³µê·¼</div>
      <div class="btn primary" data-part="ìœ ì‚°ì†Œ">ìœ ì‚°ì†Œ</div>
    </div>
  </div>

  <!-- Selected part + exercises -->
  <div class="section card" id="workCard" style="display:none">
    <div class="row between">
      <div class="row" style="gap:10px">
        <div class="btn small ghost" id="backBtn" title="ë¶€ìœ„ ë‹¤ì‹œ ì„ íƒ">â†</div>
        <div>
          <div class="muted">ì„ íƒ ë¶€ìœ„</div>
          <div style="font-weight:900" id="selectedPart">-</div>
        </div>
      </div>
      <div class="muted" id="todaySmall"></div>
    </div>
    <div class="divider"></div>

    <div id="exerciseList"></div>

    <div class="divider"></div>
    <div class="row">
      <div class="btn ghost" style="flex:1" id="addPartBtn">+ ë¶€ìœ„ ì¶”ê°€</div>
      <div class="btn ghost" style="flex:1" id="addExerciseBtn">+ ì¢…ëª© ì¶”ê°€</div>
    </div>
  </div>

  <div class="section">
    <div class="btn" id="endBtn">ìš´ë™ ì¢…ë£Œ</div>
  </div>
</div>

<!-- Top10 overlay -->
<div class="overlay" id="overlayTop10" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="Top10">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="top10Title">Top 10 Â· í•˜ì²´(ì˜¤ëŠ˜)</div>
        <div class="drawer-sub">ê°™ì€ ì²´ê¸‰ Â· ì„±ë³„ Â· ë¶€ìœ„ ê¸°ì¤€</div>
      </div>
      <div class="btn ghost small" id="closeTop10">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body" id="top10Body"></div>
  </div>
</div>

<!-- Add exercise prompt -->
<div class="overlay" id="overlayPrompt" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ì¢…ëª© ì¶”ê°€">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">ì¢…ëª© ì¶”ê°€</div>
        <div class="drawer-sub" id="promptSub">ì„ íƒ ë¶€ìœ„ì— ì¢…ëª©ì„ ì¶”ê°€í•´</div>
      </div>
      <div class="btn ghost small" id="closePrompt">ë‹«ê¸°</div>
    </div>
    <div class="prompt-body">
      <input type="text" id="exerciseName" placeholder="ì˜ˆ) ë²¤ì¹˜í”„ë ˆìŠ¤"/>
      <div class="chips" id="chips"></div>
      <div class="row" style="margin-top:12px">
        <div class="btn primary" style="flex:1" id="confirmAdd">ì¶”ê°€</div>
      </div>
      <div class="hint" style="margin-top:10px">ì¢…ëª© ì¶”ê°€ ìˆœê°„ì— íƒ€ì´ë¨¸ê°€ ì‹œì‘ë˜ê³ , ì‹œê³„ë¥¼ íƒ­í•˜ë©´ ì¼ì‹œì •ì§€/ì¬ê°œë¼.</div>
    </div>
  </div>
</div>

<script>
  // ---- helpers
  const qs=(s,el=document)=>el.querySelector(s);
  const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
  const pad=n=>String(n).padStart(2,'0');
  function fmtHMS(ms){
    ms=Math.max(0,ms);
    const s=Math.floor(ms/1000);
    const h=Math.floor(s/3600);
    const m=Math.floor((s%3600)/60);
    const ss=s%60;
    return `${pad(h)}:${pad(m)}:${pad(ss)}`;
  }

  // ---- state
  const state = {
    selectedPart: null,
    exercises: [], // {id, part, name, createdAt, paused:false, pauseAt:null, pausedMs:0, completed:false, completedAt:null, activeMs:0}
    recentByPart: {
      "ê°€ìŠ´":["ë²¤ì¹˜í”„ë ˆìŠ¤","ì¸í´ë¼ì¸ ë²¤ì¹˜í”„ë ˆìŠ¤","ì²´ìŠ¤íŠ¸í”„ë ˆìŠ¤","í‘¸ì‰¬ì—…"],
      "ë“±":["ë«í’€ë‹¤ìš´","ë°”ë²¨ë¡œìš°","ì‹œí‹°ë“œë¡œìš°","í’€ì—…"],
      "í•˜ì²´":["ìŠ¤ì¿¼íŠ¸","ë ˆê·¸í”„ë ˆìŠ¤","ë ˆê·¸ìµìŠ¤í…ì…˜","ë ˆê·¸ì»¬"],
      "ì–´ê¹¨":["ì˜¤ë²„í—¤ë“œí”„ë ˆìŠ¤","ì‚¬ì´ë“œë ˆí„°ëŸ´ë ˆì´ì¦ˆ","ìˆ„ë”í”„ë ˆìŠ¤"],
      "íŒ”":["ë°”ë²¨ì»¬","ë¤ë²¨ì»¬","íŠ¸ë¼ì´ì…‰ìŠ¤í‘¸ì‹œë‹¤ìš´","ë”¥ìŠ¤"],
      "ë³µê·¼":["í¬ëŸ°ì¹˜","í–‰ì‰ë ˆê·¸ë ˆì´ì¦ˆ","í”Œë­í¬"],
      "ìœ ì‚°ì†Œ":["ëŸ¬ë‹","ì‚¬ì´í´","ê³„ë‹¨"]
    }
  };

  // ---- elements
  const app = qs('#app');
  const tickerWrap = qs('#tickerWrap');
  const overlayTop10 = qs('#overlayTop10');
  const closeTop10 = qs('#closeTop10');
  const top10Body = qs('#top10Body');
  const top10Title = qs('#top10Title');

  const partCard = qs('#partCard');
  const workCard = qs('#workCard');
  const selectedPartEl = qs('#selectedPart');
  const todaySmall = qs('#todaySmall');
  const exerciseList = qs('#exerciseList');
  const backBtn = qs('#backBtn');
  const addPartBtn = qs('#addPartBtn');
  const addExerciseBtn = qs('#addExerciseBtn');

  const overlayPrompt = qs('#overlayPrompt');
  const closePrompt = qs('#closePrompt');
  const promptSub = qs('#promptSub');
  const exerciseName = qs('#exerciseName');
  const chips = qs('#chips');
  const confirmAdd = qs('#confirmAdd');

  const endBtn = qs('#endBtn');

  // ---- ticker top10 (sample data)
  const sampleTop10 = [
    {rank:1,name:"jaeyang",vol:"8,420kg"},
    {rank:2,name:"userB",vol:"7,980kg"},
    {rank:3,name:"userC",vol:"7,450kg"},
    {rank:4,name:"userD",vol:"7,100kg"},
    {rank:5,name:"userE",vol:"6,980kg"},
    {rank:6,name:"userF",vol:"6,850kg"},
    {rank:7,name:"userG",vol:"6,700kg"},
    {rank:8,name:"userH",vol:"6,500kg"},
    {rank:9,name:"userI",vol:"6,320kg"},
    {rank:10,name:"userJ",vol:"6,100kg"},
  ];
  function renderTop10(){
    top10Body.innerHTML="";
    for(const r of sampleTop10){
      const row=document.createElement('div');
      row.className="rank-row";
      row.innerHTML = `
        <div class="rank-left">
          <div class="rank-badge">${r.rank}</div>
          <div class="rank-name">${r.name}</div>
        </div>
        <div class="rank-val">${r.vol}</div>
      `;
      top10Body.appendChild(row);
    }
  }
  function openTop10(){
    const p = state.selectedPart || "í•˜ì²´";
    top10Title.textContent = `Top 10 Â· ${p}(ì˜¤ëŠ˜)`;
    renderTop10();
    app.classList.add('paused');
    overlayTop10.classList.add('show');
    overlayTop10.setAttribute('aria-hidden','false');
  }
  function closeTop10Fn(){
    overlayTop10.classList.remove('show');
    overlayTop10.setAttribute('aria-hidden','true');
    app.classList.remove('paused');
  }
  tickerWrap.addEventListener('click', openTop10);
  closeTop10.addEventListener('click', closeTop10Fn);
  overlayTop10.addEventListener('click', (e)=>{ if(e.target===overlayTop10) closeTop10Fn(); });

  // ---- navigation
  function showPartPicker(){
    state.selectedPart = null;
    partCard.style.display = "";
    workCard.style.display = "none";
  }
  function showWork(part){
    state.selectedPart = part;
    selectedPartEl.textContent = part;
    todaySmall.textContent = new Date().toISOString().slice(0,10);
    partCard.style.display = "none";
    workCard.style.display = "";
    renderExercises();
  }
  qsa('#partGrid .btn').forEach(b=>{
    b.addEventListener('click', ()=> showWork(b.dataset.part));
  });
  backBtn.addEventListener('click', showPartPicker);
  addPartBtn.addEventListener('click', showPartPicker);

  // ---- add exercise prompt
  function openPrompt(){
    if(!state.selectedPart){ return; }
    promptSub.textContent = `ì„ íƒ ë¶€ìœ„: ${state.selectedPart}`;
    exerciseName.value = "";
    const list = state.recentByPart[state.selectedPart] || [];
    chips.innerHTML="";
    list.forEach(name=>{
      const c=document.createElement('div');
      c.className="chip";
      c.textContent=name;
      c.addEventListener('click', ()=>{ exerciseName.value=name; exerciseName.focus(); });
      chips.appendChild(c);
    });
    overlayPrompt.classList.add('show');
    overlayPrompt.setAttribute('aria-hidden','false');
    setTimeout(()=>exerciseName.focus(),50);
  }
  function closePromptFn(){
    overlayPrompt.classList.remove('show');
    overlayPrompt.setAttribute('aria-hidden','true');
  }
  addExerciseBtn.addEventListener('click', openPrompt);
  closePrompt.addEventListener('click', closePromptFn);
  overlayPrompt.addEventListener('click', (e)=>{ if(e.target===overlayPrompt) closePromptFn(); });

  function addExercise(name){
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random();
    const ex = {
      id, part: state.selectedPart, name,
      createdAt: Date.now(),
      paused:false, pauseAt:null, pausedMs:0,
      completed:false, completedAt:null, activeMs:0,
      sets: [] // step2
    };
    state.exercises.push(ex);

    // remember recent (simple)
    const arr = state.recentByPart[state.selectedPart] || (state.recentByPart[state.selectedPart]=[]);
    if(name && !arr.includes(name)){
      arr.unshift(name);
      if(arr.length>8) arr.pop();
    }
    renderExercises();
  }

  confirmAdd.addEventListener('click', ()=>{
    const name = (exerciseName.value || "").trim();
    if(!name) return;
    closePromptFn();
    addExercise(name);
  });
  exerciseName.addEventListener('keydown', (e)=>{
    if(e.key==="Enter"){ confirmAdd.click(); }
  });

  // ---- timers
  function getActiveMs(ex){
    if(ex.completed) return ex.activeMs;
    let now = Date.now();
    let paused = ex.paused ? (now - ex.pauseAt) : 0;
    return (now - ex.createdAt) - ex.pausedMs - paused;
  }
  function togglePause(ex){
    if(ex.completed) return;
    if(!ex.paused){
      ex.paused = True; // will be fixed below
    }
  }

  // ---- render
  function renderExercises(){
    const list = state.exercises.filter(e=>e.part===state.selectedPart);
    exerciseList.innerHTML = "";

    if(state.selectedPart === "ìœ ì‚°ì†Œ"){
      const box=document.createElement('div');
      box.className="card";
      box.innerHTML = `
        <div class="row between">
          <div class="ex-title">ìœ ì‚°ì†Œ</div>
          <div class="pill">ì•¼ì™¸ Â· ì‹¤ë‚´ (ì¶”í›„)</div>
        </div>
        <div class="divider"></div>
        <div class="muted">STEP1ì—ì„œëŠ” ì¢…ëª© íƒ€ì´ë¨¸ë¶€í„° ë¨¼ì € ê²€ì¦ ì¤‘.</div>
      `;
      exerciseList.appendChild(box);
      return;
    }

    if(list.length===0){
      const empty=document.createElement('div');
      empty.className="muted";
      empty.style.padding="6px 2px";
      empty.textContent="ì¢…ëª©ì„ ì¶”ê°€í•´ì¤˜.";
      exerciseList.appendChild(empty);
      return;
    }

    for(const ex of list){
      const card=document.createElement('div');
      card.className="card ex-card" + (ex.completed ? " completed":"");
      card.dataset.id = ex.id;

      const activeMs = ex.completed ? ex.activeMs : getActiveMs(ex);
      const timeText = fmtHMS(activeMs);

      card.innerHTML = `
        <div class="row between">
          <div>
            <div class="muted">${ex.part}</div>
            <div class="ex-title">${ex.name}</div>
          </div>
          <div class="pill tap timer ${ex.paused ? "paused":""}" data-action="timer" title="íƒ­: ì¼ì‹œì •ì§€/ì¬ê°œ">
            â± <span class="timer-val">${timeText}</span> ${ex.paused ? "â¸":""}
          </div>
        </div>

        <div class="details">
          <div class="sets-placeholder">ì„¸íŠ¸/ë¬´ê²Œ ì…ë ¥ì€ ë‹¤ìŒ ë‹¨ê³„(STEP2)ì—ì„œ ë¶™ì¼ê²Œ. ì§€ê¸ˆì€ íƒ€ì´ë¨¸ ë™ì‘ë¶€í„° ì¨ë´.</div>
          <div class="row" style="margin-top:10px">
            <div class="btn ghost" style="flex:1" data-action="complete">ì¢…ëª© ì™„ë£Œ</div>
          </div>
        </div>

        <div class="collapse">
          <div class="divider"></div>
          <div class="row between">
            <div class="muted">ìš”ì•½</div>
            <div class="muted">íƒ­í•˜ë©´ í¼ì³ì§</div>
          </div>
          <div style="margin-top:6px">
            <div class="row between"><div>í›ˆë ¨ì‹œê°„</div><div class="timer">${fmtHMS(ex.activeMs)}</div></div>
            <div class="row between" style="margin-top:4px"><div class="muted">ì´ ë³¼ë¥¨</div><div class="muted">- (STEP2)</div></div>
          </div>
        </div>
      `;

      card.addEventListener('click', (ev)=>{
        const actionEl = ev.target.closest('[data-action]');
        if(actionEl){
          const action = actionEl.dataset.action;
          if(action==="timer"){
            ev.preventDefault();
            ev.stopPropagation();
            if(ex.completed) return;
            // toggle pause/resume
            if(!ex.paused){
              ex.paused = true;
              ex.pauseAt = Date.now();
            } else {
              ex.paused = false;
              ex.pausedMs += (Date.now() - ex.pauseAt);
              ex.pauseAt = null;
            }
            renderExercises();
          }
          if(action==="complete"){
            ev.preventDefault();
            ev.stopPropagation();
            if(ex.completed) return;
            // finalize active time
            let now = Date.now();
            let pausedExtra = ex.paused ? (now - ex.pauseAt) : 0;
            ex.activeMs = (now - ex.createdAt) - ex.pausedMs - pausedExtra;
            ex.completed = true;
            ex.completedAt = now;
            ex.paused = false;
            ex.pauseAt = null;
            renderExercises();
          }
          return;
        }

        // click on collapsed card -> expand (re-open details) (simple toggle)
        if(ex.completed){
          ex.completed = false;
          // resume timer? no, keep completed time; restart from now as new session would be confusing.
          // For STEP1, re-open means "continue" - we will treat it as resuming with same createdAt, keeping elapsed.
          // We'll implement as: set createdAt = now - activeMs, pausedMs=0.
          const now = Date.now();
          ex.createdAt = now - ex.activeMs;
          ex.pausedMs = 0;
          ex.activeMs = 0;
          ex.completedAt = null;
          renderExercises();
        }
      });

      exerciseList.appendChild(card);
    }
  }

  // ---- tick timers
  setInterval(()=>{
    if(!state.selectedPart) return;
    const list = state.exercises.filter(e=>e.part===state.selectedPart && !e.completed);
    if(list.length===0) return;
    // update only visible timer values without full re-render
    for(const ex of list){
      const card = exerciseList.querySelector(`.ex-card[data-id="${ex.id}"]`);
      if(!card) continue;
      const v = card.querySelector('.timer-val');
      if(!v) continue;
      v.textContent = fmtHMS(getActiveMs(ex));
    }
  }, 250);

  // ---- end button (step1: simple confirm)
  endBtn.addEventListener('click', ()=>{
    if(!confirm("ì˜¤ëŠ˜ ìš´ë™ì„ ì¢…ë£Œí• ê¹Œ? (STEP1: ìš”ì•½ í™”ë©´ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ)")) return;
    alert("STEP1ì—ì„œëŠ” ì•„ì§ 'ì˜¤ëŠ˜ ìš”ì•½ í™”ë©´'ì´ ë¶™ê¸° ì „ì´ì•¼. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë¶™ì¼ê²Œ.");
  });

  // start at part picker
  showPartPicker();
</script>
</body>
</html>
