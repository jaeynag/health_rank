<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Health Rank - App (Step31)</title>
<style>
  :root{
    --bg:#0f1115; --card:#141826; --card2:#1b1f2a; --line:#2a3040;
    --txt:#eaeaf0; --mut:#8e93b5; --accent:#4c5cff; --accent2:#cfd3ff;
    --danger:#ff4c6a; --good:#36d399;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--txt)}
  .page{max-width:480px;margin:0 auto;padding:12px 12px 24px}
  .header{position:sticky;top:0;background:var(--bg);padding:6px 0 10px;border-bottom:1px solid #1f2430;z-index:20}

  /* Compact clock */
  .head-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
  .clock{
    flex:1;display:flex;align-items:center;justify-content:space-between;
    border:1px solid #23283a;border-radius:12px;
    background:rgba(255,255,255,.03);
    padding:10px 12px;
    user-select:none;
  }
  .clock .s{color:var(--mut);font-size:12px}
  .clock .t{font-variant-numeric:tabular-nums;letter-spacing:.08em;font-weight:900}

  /* Ticker */
  .tick-item{display:inline-flex;gap:8px;align-items:center}
  .tick-part{font-weight:900;color:#e7e9ff}
  .tick-rank{font-weight:900;color:var(--accent2)}
  .tick-loc{color:var(--mut)}
  .tick-nick{font-weight:900}
  .tick-vol{font-weight:900}
  .tick-sep{opacity:.35;margin:0 10px}
  .tick-medal{font-size:14px;line-height:1;transform:translateY(-1px)}

  .ticker-wrap{overflow:hidden;white-space:nowrap;border-radius:10px;background:rgba(255,255,255,.03);border:1px solid #23283a}
  .ticker-touch{cursor:pointer}
  .ticker{display:inline-block;padding-left:100%;animation: marquee 18s linear infinite;will-change:transform}
  .ticker.paused{animation-play-state:paused}
  .ticker span{display:inline-block;margin-right:24px;color:var(--accent2)}
  .ticker.paused span{}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  /* ticker: no extra effects */
/* UI */
  .section{margin:12px 0}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .card.ex-card.active{border-color:rgba(255,214,102,.24);box-shadow:0 0 0 1px rgba(255,214,102,.14) inset}

  .row{display:flex;gap:8px;align-items:center}
  .row.between{justify-content:space-between}
  .muted{color:var(--mut);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .btn{background:var(--card2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px;text-align:center;user-select:none}
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.good{background:rgba(54,211,153,.16);border-color:rgba(54,211,153,.35);color:#c9ffe9}
  .btn.ghost{background:var(--card);border-color:var(--line)}
  .btn.small{padding:8px 10px;border-radius:12px}
  .btn.danger{background:rgba(255,76,106,.14);border-color:rgba(255,76,106,.40);color:#ffd0d8}
  .input{width:100%;padding:12px;border-radius:12px;border:1px solid #23283a;background:rgba(255,255,255,.03);color:var(--txt);outline:none}
  .input:focus{border-color:rgba(76,92,255,.55)}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);user-select:none}
  .pill.tap{cursor:pointer}
  .time-paused{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.35)}
  .divider{height:1px;background:var(--line);margin:10px 0;opacity:.8}
  .hidden{display:none !important}

  /* Exercise accordion */
  .ex-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;cursor:pointer}
  .ex-title{font-weight:900}
  .ex-sub{color:var(--mut);font-size:12px;margin-top:2px}
  .ex-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .ex-vol{color:var(--mut);font-size:12px}
  .ex-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .ex-time{color:var(--mut);font-size:12px;font-variant-numeric:tabular-nums;letter-spacing:.04em}

  .ex-x{
    position:absolute;left:6px;top:6px;
    width:20px;height:20px;border-radius:8px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.04);
    color:#cfd3ff;
    font-weight:900;
    font-size:13px;
    line-height:1;
    user-select:none;
  }
  .ex-left{padding-left:22px}


  .part-label{margin:10px 0 6px;color:var(--mut);font-size:12px;letter-spacing:.02em}
  .part-label strong{color:var(--accent2)}

  /* Footer compare row */
  .compare{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .compare .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02);overflow:hidden}
  .compare .k{color:var(--mut);font-size:12px}
  .compare .v{font-weight:900;margin-top:4px;font-variant-numeric:tabular-nums}
  .compare .s{color:var(--mut);font-size:11px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Swipe row */
  .swipe{position:relative; overflow:hidden; border-radius:12px; margin:6px 0;background:var(--card); border:1px dashed rgba(42,48,64,.7); touch-action: pan-y;}
  .swipe-actions{position:absolute; top:0; right:0; bottom:0; width:86px;display:flex; align-items:center; justify-content:center; padding:8px;background:rgba(255,76,106,.12); border-left:1px solid rgba(255,76,106,.25); z-index:0; opacity:0; pointer-events:none; transition:opacity 120ms ease;}
  .swipe-front{position:relative; z-index:1; transform:translateX(0px);transition:transform 140ms ease-out; will-change:transform;background:var(--card); padding:10px 10px;}
  .swipe-front.done{background:linear-gradient(180deg, rgba(54,211,153,.18), rgba(54,211,153,.06)), var(--card); border:1px solid rgba(54,211,153,.22)}
  .swipe-front.done .set-no{color:#c9ffe9}
  .swipe-front.done .set-val{color:#c9ffe9}
  .swipe-front.done .set-vol{color:rgba(201,255,233,.85)}
  .check{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:99px;margin-right:6px;background:rgba(54,211,153,.22);border:1px solid rgba(54,211,153,.35);color:#c9ffe9;font-size:11px;font-weight:900;transform:translateY(-1px)}
  .set-row.live{padding:10px 10px;border:1px solid rgba(255,214,102,.35);background:rgba(255,214,102,.06);border-radius:12px}
  .live-dot{display:inline-block;width:8px;height:8px;border-radius:99px;background:var(--accent2);margin-right:6px;animation:livePulse 1.2s ease-in-out infinite}
  @keyframes livePulse{0%{transform:scale(1);opacity:.55}50%{transform:scale(1.7);opacity:1}100%{transform:scale(1);opacity:.55}}
  .prev-box{display:flex;flex-direction:column;gap:2px;white-space:normal;line-height:1.15}
  .prev-date{font-size:12px;opacity:.6}
  .prev-val{font-size:13px;opacity:.75;font-variant-numeric:tabular-nums}

  .swipe.open .swipe-front{transform:translateX(-86px)}
  .swipe.open .swipe-actions{opacity:1;pointer-events:auto}
  .set-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .set-row.done{opacity:.98}

  .set-left{display:flex;gap:10px;align-items:center;min-width:0;flex:1}
  .set-no{color:var(--mut);width:70px;flex:0 0 auto}
  .set-val{font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .set-vol{color:var(--mut);font-size:12px;flex:0 0 auto}
  .ghosttext{color:rgba(142,147,181,.85)}

  /* Overlays */
  .overlay{
    display:none;
    position:fixed;inset:0;
    background:rgba(0,0,0,.62);
    z-index:60;
    pointer-events:none;
  }
  .overlay.show{
    display:flex;
    align-items:flex-end;
    pointer-events:auto;
  }
  .overlay.center.show{align-items:center;}
  .overlay.center .drawer{margin-top:0;margin-bottom:0;}
  #overlayPrompt .drawer{width:min(520px,92vw);}

  .drawer{width:min(480px,100%);margin-top:56px;background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .drawer-title{font-weight:900}
  .drawer-sub{color:var(--mut);font-size:12px;margin-top:2px}
  .drawer-body{max-height:82vh;overflow:auto;padding:12px}

  .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .key{padding:14px;border-radius:12px;background:var(--card2);border:1px solid var(--line);text-align:center;user-select:none}
  .key.disabled{opacity:.4;pointer-events:none}
  .big{font-size:28px;letter-spacing:.08em;font-variant-numeric:tabular-nums}
  .center{text-align:center}

  input[type="text"],input[type="password"]{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0c0e13;color:var(--txt);outline:none;font-size:16px;}
  .chipline{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:var(--card2);color:#fff;user-select:none;cursor:pointer;font-size:13px}
  .chip.active{background:rgba(76,92,255,.18);border-color:rgba(76,92,255,.55);color:var(--accent2)}

  /* Summary overlay */
  .sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
  .sum-item{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02)}
  .sum-item .k{color:var(--mut);font-size:12px}
  .sum-item .v{font-weight:900;margin-top:2px}

  /* Top10 list */
  .top10-item{padding:10px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02);margin-top:8px}
  .top10-item .a{display:flex;justify-content:space-between;gap:10px}
  .top10-item .b{color:var(--mut);font-size:12px;margin-top:4px}

  /* Screens & bottom nav */
  .screen{display:none}
  .screen.active{display:block}
  .bottom-nav{
    position:fixed;left:10px;right:10px;bottom:12px;
    background:rgba(15,17,21,.92);
    border:1px solid #1f2430;
    border-radius:16px;
    padding:8px 10px calc(8px + env(safe-area-inset-bottom));
    z-index:30;
    box-shadow:0 10px 30px rgba(0,0,0,.45);
  }
  .bottom-nav .wrap{max-width:480px;margin:0 auto;display:flex;gap:8px}
  .navbtn{
    flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:2px;padding:10px 8px;border-radius:12px;
    border:1px solid #23283a;background:rgba(255,255,255,.03);
    color:var(--mut);font-weight:800;font-size:12px;
  }
  .navbtn.active{border-color:rgba(76,92,255,.55);color:var(--accent2);background:rgba(76,92,255,.10)}
  .navbtn .dot{width:6px;height:6px;border-radius:50%;background:transparent}
  .navbtn.active .dot{background:var(--accent)}
  /* leave space for nav */
  .page{padding-bottom:110px}


  /* Ticker motion (2x content) */
  #tickerWrap{overflow:hidden;white-space:nowrap;position:relative}
  #tickerLine{
    display:inline-block;
    padding-left:0;
    will-change:transform;
    animation: tickerScroll 18s linear infinite;
  }
  #tickerLine.paused{animation-play-state:paused}
  @keyframes tickerScroll{
    0%{ transform: translateX(0); }
    100%{ transform: translateX(-50%); }
  }


  /* Center overlay (start notice) */
  .overlay.center.show{align-items:center;justify-content:center;padding:16px}
  .overlay.center .drawer{margin-top:0;width:min(420px,92vw)}
  .overlay.center .drawer-body{max-height:72vh}

  /* Calendar */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-dow .cal-cell{color:var(--mut);font-size:11px;text-align:center;padding:4px 0;border:none;background:transparent;min-height:auto}
  .cal-cell{
    border:1px solid rgba(42,48,64,.7);
    background:rgba(255,255,255,.02);
    border-radius:12px;
    padding:8px 6px;
    min-height:54px;
    display:flex;
    flex-direction:column;
    gap:4px;
    overflow:hidden;
  }
  .cal-cell.blank{opacity:.18}
  .cal-day{font-weight:900;font-size:13px;font-variant-numeric:tabular-nums}
  .cal-sub{font-size:11px;color:rgba(207,211,255,.85);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cal-sub.muted{color:rgba(142,147,181,.75)}
  .cal-today{box-shadow:0 0 0 1px rgba(76,92,255,.40) inset;border-color:rgba(76,92,255,.55)}

  /* Calendar interaction */
  .cal-cell[data-cal-date]{cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
  .cal-selected{transform:scale(1.06);box-shadow:0 0 0 2px rgba(255,255,255,.16) inset}
  .cal-detail{border:1px dashed rgba(42,48,64,.7);border-radius:14px;padding:10px 10px;background:rgba(255,255,255,.02)}
  .cal-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(42,48,64,.75);background:rgba(255,255,255,.03)}

  /* Live dot: pulse only when set is active */
  .set-row.live .live-dot{animation:none;opacity:.55}
  .set-row.live.live-active .live-dot{animation:livePulse 1.2s ease-in-out infinite;opacity:1}

  /* Collapsed feel */
  .ex-card.collapsed{opacity:.88}
  .ex-right{display:flex;align-items:center;gap:10px;justify-content:flex-end}
  .chev{font-size:16px;opacity:.7;transform-origin:center;transition:transform .12s ease, opacity .12s ease}
  .ex-card.collapsed .chev{transform:rotate(-90deg);opacity:.9}


</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div id="errBanner" style="display:none;position:fixed;left:10px;right:10px;top:10px;z-index:9999;padding:10px 12px;border-radius:12px;background:rgba(255,80,80,.15);border:1px solid rgba(255,80,80,.45);color:#ffd9d9;font-weight:800;font-size:12px"></div>

<div class="page" id="app">

<div id="screen-auth" class="screen active">
  <div class="page">
    <div class="section card" id="authCard">
      <div class="row between">
        <div>
          <div class="h1">ë¡œê·¸ì¸</div>
          <div class="muted">ì•„ì´ë””/ë¹„ë²ˆìœ¼ë¡œ ë“¤ì–´ê°€ì.</div>
        </div>
      </div>
      <div class="divider"></div>

      <div class="label">ì•„ì´ë””</div>
      <input type="text" id="authId" placeholder="ì•„ì´ë””"/>

      <div class="label" style="margin-top:10px">ë¹„ë°€ë²ˆí˜¸</div>
      <input type="password" id="authPw" placeholder="ë¹„ë°€ë²ˆí˜¸"/>

      <div class="row" style="margin-top:12px">
        <div class="btn primary" id="btnLogin" style="flex:1">ë¡œê·¸ì¸</div>
        <div class="btn ghost" id="btnSignup" style="flex:1">íšŒì›ê°€ì…</div>
      </div>
      <div class="muted" id="authMsg" style="margin-top:10px;min-height:18px"></div>
    </div>

    <div class="section card" id="profileCard" style="display:none">
      <div class="row between">
        <div>
          <div class="h1">í”„ë¡œí•„</div>
          <div class="muted">ì²˜ìŒ í•œ ë²ˆë§Œ ì…ë ¥í•´ì¤˜.</div>
        </div>
      </div>
      <div class="divider"></div>

      <div class="label">ë‹‰ë„¤ì„</div>
      <input type="text" id="profNick" placeholder="ì˜ˆ) ì¬ì–‘"/>

      <div class="row" style="gap:10px;margin-top:10px">
        <div style="flex:1">
          <div class="label">ì„±ë³„</div>
          <div class="chipline" id="profSex">
            <div class="chip" data-sex="M">ë‚¨</div>
            <div class="chip" data-sex="F">ì—¬</div>
          </div>
        </div>
        <div style="flex:1">
          <div class="label">ëª¸ë¬´ê²Œ(kg)</div>
          <input type="text" id="profWeight" placeholder="ì˜ˆ) 78.5"/>
        </div>
      </div>

      <div class="row" style="gap:10px;margin-top:10px">
        <div style="flex:1">
          <div class="label">í‚¤(cm)</div>
          <input type="text" id="profHeight" placeholder="ì˜ˆ) 175"/>
        </div>
        <div style="flex:1">
          <div class="label">ì§€ì—­(ì„ íƒ)</div>
          <input type="text" id="profRegion" placeholder="ì˜ˆ) ì„œìš¸"/>
          <div class="btn small ghost" id="btnRegionAuto" style="margin-top:8px">í˜„ì¬ ìœ„ì¹˜ë¡œ ìë™ ì…ë ¥</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="btn primary" id="btnSaveProfile" style="flex:1">ì €ì¥í•˜ê³  ì‹œì‘</div>
      </div>
      <div class="muted" id="profMsg" style="margin-top:10px;min-height:18px"></div>
    </div>
  </div>
</div>


<div id="screen-today" class="screen">
  <div class="section card" id="partCard">
    <div class="row between">
      <div>
        <div class="muted">ì˜¤ëŠ˜ ìš´ë™</div>
        <div style="font-weight:900;margin-top:2px">ë¶€ìœ„ ì„ íƒ</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="grid" id="partGrid">
      <div class="btn" data-part="ê°€ìŠ´">ê°€ìŠ´</div>
      <div class="btn" data-part="ë“±">ë“±</div>
      <div class="btn" data-part="í•˜ì²´">í•˜ì²´</div>
      <div class="btn" data-part="ì–´ê¹¨">ì–´ê¹¨</div>
      <div class="btn" data-part="íŒ”">íŒ”</div>
      <div class="btn" data-part="ë³µê·¼">ë³µê·¼</div>
      <div class="btn" data-part="ìœ ì‚°ì†Œ">ìœ ì‚°ì†Œ</div>
    </div>
  </div>

  
  <div class="section card" id="calendarCard">
    <div class="row between">
      <div>
        <div class="muted">ë‹¬ë ¥</div>
        <div style="font-weight:900;margin-top:2px" id="calTitle">-</div>
      </div>
      <div class="muted">ìš´ë™í•œ ë¶€ìœ„ (ìµœëŒ€ 2ê°œ)</div>
    </div>
    <div class="divider"></div>
    <div class="cal-grid cal-dow" id="calDow"></div>
    <div class="cal-grid" id="calGrid" style="margin-top:6px"></div>
    <div class="cal-detail" id="calDetail" style="display:none;margin-top:10px">
      <div class="muted" id="calDetailTitle">-</div>
      <div class="cal-chips" id="calDetailChips"></div>
    </div>
  </div>
<div class="section card" id="workCard" style="display:none">
    <div class="row between">
      <div class="row" style="gap:10px">
        <div class="btn small ghost" id="backBtn" title="ë¶€ìœ„ ë‹¤ì‹œ ì„ íƒ">â†</div>
        <div>
          <div class="muted">ì§€ê¸ˆ ì¶”ê°€í•  ë¶€ìœ„</div>
          <div style="font-weight:900" id="selectedPart">-</div>
        </div>
      </div>
      
      <div style="text-align:right">
        <div class="muted" id="todaySmall"></div>
        <div class="muted" style="margin-top:4px;font-variant-numeric:tabular-nums">
          ì´ <span id="workTotal">00:00:00</span> / í›ˆë ¨ <span id="workTrain">00:00:00</span>
        </div>
      </div>
    </div>

    <div id="exerciseList" style="margin-top:10px"></div>

    <div class="divider"></div>
    <div class="row">
      <div class="btn ghost" style="flex:1" id="addExerciseBtn">ì¢…ëª© ì¶”ê°€</div>
    </div>

    <div class="divider"></div>
    <div class="row">
      <div class="btn danger" style="flex:1" id="endBtn">ìš´ë™ ì¢…ë£Œ</div>
    </div>
  </div>
</div>

<!-- Top10 overlay -->
<div class="overlay" id="overlayTop10" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="Top10">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">Top 10</div>
        <div class="drawer-sub">ë¶€ìœ„ë³„ ë³¼ë¥¨ ë­í‚¹ (ë°ëª¨)</div>
      </div>
      <div class="btn ghost small" id="closeTop10">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body" id="top10Body"></div>
  </div>
</div>

<!-- Add exercise overlay -->
<div class="overlay center" id="overlayPrompt" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ì¢…ëª© ì¶”ê°€">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">ì¢…ëª© ì¶”ê°€</div>
        <div class="drawer-sub" id="promptSub">-</div>
      </div>
      <div class="btn ghost small" id="closePrompt">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <input type="text" id="exerciseName" placeholder="ì˜ˆ) ìŠ¤ì¿¼íŠ¸"/>
      <div class="chipline" id="exerciseChips"></div>
      <div class="row" style="margin-top:12px">
        <div class="btn primary" style="flex:1" id="confirmAdd">ì¶”ê°€</div>
      </div>
    </div>
  </div>
</div>

<!-- Start overlay -->
<div class="overlay center" id="overlayStart" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ìš´ë™ ì‹œì‘ ì•ˆë‚´">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">ë°”ë¡œ ìš´ë™ ì‹œì‘</div>
        <div class="drawer-sub" id="startSub">-</div>
      </div>
      <div class="btn ghost small" id="closeStart">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <div class="card" style="padding:12px">
        <div style="font-weight:900" id="startCount">10ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</div>
        <div class="muted" style="margin-top:8px">ë°”ë¡œ ìš´ë™ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
        <div class="muted" style="margin-top:6px">- ë¬´ê²Œ ë° ë©ìŠ¤ëŠ” ì§„í–‰ ì™„ë£Œ í›„ ì…ë ¥ -</div>
      </div>
    </div>
  </div>
</div>

<!-- Set entry overlay -->
<div class="overlay" id="overlaySet" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ì„¸íŠ¸ ì…ë ¥">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="setTitle">1ì„¸íŠ¸ ì…ë ¥</div>
        <div class="drawer-sub" id="setSub">-</div>
      </div>
      <div class="btn ghost small" id="closeSet">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <div id="stepWeight">
        <div class="center">
          <div class="muted">ë¬´ê²Œ</div>
          <div class="big">
            <span id="setWeightVal">0.0</span>
            <span class="pill tap" id="unitToggle">KG</span>
          </div>
        </div>
        <div class="row" style="justify-content:center;margin:10px 0">
          <div class="pill tap" id="incBtn">ì¦</div>
          <div class="pill tap" id="decBtn">ê°</div>
        </div>
        <div id="kbdKg">
          <div class="kbd">
            <div class="key" id="barKey">BAR</div>
            <div class="key" data-d="0.25">0.25</div>
            <div class="key" data-d="0.5">0.5</div>
            <div class="key" data-d="1">1</div>
            <div class="key" data-d="2.5">2.5</div>
            <div class="key" data-d="5">5</div>
            <div class="key" data-d="10">10</div>
            <div class="key" data-d="20">20</div>
            <div class="key" id="backKey">â†</div>
          </div>
        </div>
        <div id="kbdLb" class="hidden">
          <div class="kbd">
            <div class="key" data-lb="1">1</div><div class="key" data-lb="2">2</div><div class="key" data-lb="3">3</div>
            <div class="key" data-lb="4">4</div><div class="key" data-lb="5">5</div><div class="key" data-lb="6">6</div>
            <div class="key" data-lb="7">7</div><div class="key" data-lb="8">8</div><div class="key" data-lb="9">9</div>
            <div class="key" data-lb=".">.</div><div class="key" data-lb="0">0</div><div class="key" id="lbBack">â†</div>
          </div>
          <div class="muted" style="margin-top:10px;text-align:center">LB ì…ë ¥ì€ ì§ì ‘ ìˆ«ìë¡œ. (ë‚´ë¶€ ê³„ì‚°ì€ KG)</div>
        </div>
        <div class="row" style="margin-top:14px">
          <div class="btn primary" style="flex:1;padding:16px" id="nextToReps">ë‹¤ìŒ</div>
        </div>
      </div>

      <div id="stepReps" class="hidden">
        <div class="center">
          <div class="muted">íšŸìˆ˜</div>
          <div class="big"><span id="setRepsVal">0</span> reps</div>
        </div>
        <div class="kbd" style="margin-top:10px">
          <div class="key" data-n="1">1</div><div class="key" data-n="2">2</div><div class="key" data-n="3">3</div>
          <div class="key" data-n="4">4</div><div class="key" data-n="5">5</div><div class="key" data-n="6">6</div>
          <div class="key" data-n="7">7</div><div class="key" data-n="8">8</div><div class="key" data-n="9">9</div>
          <div class="key" id="repsClear">C</div><div class="key" data-n="0">0</div><div class="key" id="repsBack">â†</div>
        </div>
        <div class="row" style="margin-top:14px;gap:10px">
          <div class="btn ghost" style="flex:0.35;padding:16px" id="backToWeight">ì´ì „</div>
          <div class="btn primary" style="flex:0.65;padding:16px" id="saveSetBtn">ì…ë ¥</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cardio entry overlay -->
<div class="overlay" id="overlayCardio" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ìœ ì‚°ì†Œ ê¸°ë¡">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="cardioTitle">ìœ ì‚°ì†Œ ê¸°ë¡</div>
        <div class="drawer-sub" id="cardioSub">-</div>
      </div>
      <div class="btn ghost small" id="closeCardio">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <div class="card" style="padding:12px">
        <div class="row between">
          <div>
            <div class="muted">êµ¬ë¶„</div>
            <div class="row" style="margin-top:6px">
              <div class="pill tap" id="cardioOutdoor">ì•¼ì™¸</div>
              <div class="pill tap" id="cardioIndoor">ì‹¤ë‚´</div>
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">í˜ì´ìŠ¤</div>
            <div style="font-weight:900;font-variant-numeric:tabular-nums" id="cardioPace">-</div>
          </div>
        </div>
        <div class="divider"></div>

        <div class="row" style="gap:10px">
          <div style="flex:1">
            <div class="muted">ê±°ë¦¬ (km)</div>
            <div class="big center" id="distVal">0</div>
          </div>
          <div style="flex:1">
            <div class="muted">ì‹œê°„</div>
            <div class="big center"><span id="minVal">0</span>m <span id="secVal">00</span>s</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="muted" style="margin-bottom:8px">ì…ë ¥</div>
        <div class="row" style="justify-content:center;margin-bottom:10px">
          <div class="pill tap" id="cardioFocusDist">ê±°ë¦¬</div>
          <div class="pill tap" id="cardioFocusTime">ì‹œê°„</div>
        </div>

        <div class="kbd" id="cardioKbd">
          <div class="key" data-c="1">1</div><div class="key" data-c="2">2</div><div class="key" data-c="3">3</div>
          <div class="key" data-c="4">4</div><div class="key" data-c="5">5</div><div class="key" data-c="6">6</div>
          <div class="key" data-c="7">7</div><div class="key" data-c="8">8</div><div class="key" data-c="9">9</div>
          <div class="key" id="cardioDot">.</div><div class="key" data-c="0">0</div><div class="key" id="cardioBack">â†</div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="btn primary" style="flex:1;padding:16px" id="saveCardio">ì…ë ¥</div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>


<div id="screen-summary" class="screen">
  <div class="page">
    <div class="section card">
      <div class="row between">
        <div>
          <div class="muted">ì˜¤ëŠ˜ ìš”ì•½</div>
          <div style="font-weight:900;margin-top:2px" id="sumDate">-</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row between">
        <div>
          <div class="muted">ì˜¤ëŠ˜ ì´ ë³¼ë¥¨</div>
          <div style="font-weight:900;font-size:22px" id="sumTotalVol2">0kg</div>
        </div>
        <div style="text-align:right">
          <div class="muted">ì´ìš´ë™ì‹œê°„</div>
          <div style="font-weight:900;font-size:22px" id="sumTotalTime2">00:00:00</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="muted">ë¶€ìœ„ë³„ ë³¼ë¥¨</div>
      <div class="sum-grid" id="sumParts2"></div>

      <div class="divider"></div>

      <div class="muted">ë¶€ìœ„ë³„ í›ˆë ¨ì‹œê°„</div>
      <div class="sum-grid" id="sumPartTimes2"></div>

      <div class="row" style="margin-top:12px">
        <div class="btn primary" style="flex:1;padding:16px" id="addMoreToday">ì˜¤ëŠ˜ ìš´ë™ ë”í•˜ê¸°</div>
      </div>
    </div>
  </div>
</div>

<div id="screen-rank" class="screen">
  <div class="section card">
    <div class="row between">
      <div>
        <div class="muted">ë­í‚¹</div>
        <div style="font-weight:900;margin-top:2px">Top 10</div>
      </div>
      <div class="pill" id="rankScope">ë‚´ ì²´ê¸‰ Â· ë‚´ ì„±ë³„</div>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:8px">
      <select class="btn" id="rankPart" style="flex:1;text-align:left">
        <option value="ê°€ìŠ´">ê°€ìŠ´</option>
        <option value="ë“±">ë“±</option>
        <option value="í•˜ì²´">í•˜ì²´</option>
        <option value="ì–´ê¹¨">ì–´ê¹¨</option>
        <option value="íŒ”">íŒ”</option>
        <option value="ë³µê·¼">ë³µê·¼</option>
      </select>
      <div class="btn" id="rankRefresh">ìƒˆë¡œê³ ì¹¨</div>
    </div>
    <div class="divider"></div>
    <div id="rankList"></div>
    <div class="divider"></div>
    <div class="row between">
      <div class="muted">ë‚´ ìœ„ì¹˜</div>
      <div style="font-weight:900" id="rankMe">-</div>
    </div>
  </div>
</div>

<div id="screen-more" class="screen">
  <div class="section card">
    <div class="row between">
      <div>
        <div class="muted">ë”ë³´ê¸°</div>
        <div style="font-weight:900;margin-top:2px">í”„ë¡œí•„ Â· ì„¤ì •</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="row between">
      <div>
        <div style="font-weight:900" id="meNick">-</div>
        <div class="muted" id="meMeta">-</div>
      </div>
      <div class="pill" id="editProfile">ìˆ˜ì •</div>
    </div>
    <div class="divider"></div>
    <div class="row between">
      <div>
        <div style="font-weight:900">í‘œì‹œ ë‹¨ìœ„</div>
        <div class="muted">ê¸°ë³¸ì€ kg</div>
      </div>
      <div class="row" style="gap:8px">
        <div class="pill tap" id="unitKg">KG</div>
        <div class="pill tap" id="unitLb">LB</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="row between">
      <div>
        <div style="font-weight:900">ë°ì´í„°</div>
        <div class="muted">ë¡œì»¬ ì €ì¥(ìƒˆë¡œê³ ì¹¨ ìœ ì§€)</div>
      </div>
      <div class="btn danger" id="resetAll">ì´ˆê¸°í™”</div>
    </div>
  </div>
</div>


<!-- Profile overlay -->
<div class="overlay" id="overlayProfile" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="í”„ë¡œí•„ ì„¤ì •">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">í”„ë¡œí•„ ì„¤ì •</div>
        <div class="drawer-sub">ì²˜ìŒ 1íšŒë§Œ í•˜ë©´ ë¼. (ì–¸ì œë“  ë”ë³´ê¸°ì—ì„œ ìˆ˜ì •)</div>
      </div>
      <div class="btn ghost small" id="closeProfile">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <div class="card" style="padding:12px">
        <div class="muted">ë‹‰ë„¤ì„</div>
        <input class="input" id="pfNick" placeholder="ì˜ˆ: jae" maxlength="16" />

        <div class="row" style="gap:8px;margin-top:10px">
          <div style="flex:1">
            <div class="muted">ì„±ë³„</div>
            <select class="input" id="pfSex">
              <option value="M">ë‚¨</option>
              <option value="F">ì—¬</option>
            </select>
          </div>
          <div style="flex:1">
            <div class="muted">í‚¤ (cm)</div>
            <input class="input" id="pfHeight" inputmode="numeric" placeholder="170" />
          </div>
        </div>

        <div class="row" style="gap:8px;margin-top:10px">
          <div style="flex:1">
            <div class="muted">ëª¸ë¬´ê²Œ (kg)</div>
            <input class="input" id="pfWeight" inputmode="decimal" placeholder="70.0" />
          </div>
          <div style="flex:1">
            <div class="muted">ì²´ê¸‰</div>
            <div class="big center" id="pfClass">-</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="muted">ìš´ë™ ì¥ì†Œ</div>
        <input class="input" id="pfGym" placeholder="ì˜ˆ: OOí—¬ìŠ¤" maxlength="40" />
        <div style="margin-top:10px">
          <div class="muted">ì§€ì—­ (ììœ ì…ë ¥)</div>
          <input class="input" id="pfRegion" placeholder="ì˜ˆ: ì„œìš¸ ê°•ë‚¨" maxlength="40" />
        </div>

        <div class="divider"></div>

        <div class="row" style="gap:10px">
          <div class="btn" id="pfCancel" style="flex:1">ë‚˜ì¤‘ì—</div>
          <div class="btn primary" id="pfSave" style="flex:2">ì €ì¥</div>
        </div>
        <div class="muted" style="margin-top:10px" id="pfWarn"></div>
      </div>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY="health_rank_today_v12c";

  // (ë””ë²„ê·¸) ì´ˆê¸° ë¡œë”© ì—ëŸ¬ê°€ ë‚˜ë©´ í™”ë©´ì— ë°”ë¡œ í‘œì‹œ
  (function(){
    const eb = document.getElementById('errBanner');
    const show = (msg)=>{
      if(!eb) return;
      eb.textContent = msg;
      eb.style.display = 'block';
    };
    window.addEventListener('error', (e)=>{
      try{ show('ì—ëŸ¬: ' + (e && e.message ? e.message : 'ì•Œ ìˆ˜ ì—†ìŒ')); }catch(_){}
    });
    window.addEventListener('unhandledrejection', (e)=>{
      try{
        const r = e && e.reason;
        show('ì—ëŸ¬: ' + (r && r.message ? r.message : String(r)));
      }catch(_){}
    });
  })();

  const qs=(s,el=document)=>el.querySelector(s);
  const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
  const safeParse=s=>{try{return JSON.parse(s)}catch{return null}};
  const fmtKg=x=>(+x||0).toFixed(2).replace(/\.00$/,".0");
  const kgToLb=kg=>kg*2.2046226218;
  const lbToKg=lb=>lb/2.2046226218;

  const HISTORY_KEY="health_rank_history_v1";
  const MAX_HISTORY_DAYS=365;
  const history={days:{}};

  function todayStr(){ return new Date().toISOString().slice(0,10); }
  function loadHistory(){
    const snap=safeParse(localStorage.getItem(HISTORY_KEY));
    if(snap && snap.days && typeof snap.days==="object") history.days = snap.days;
  }
  function cleanupHistory(){
    const keepAfter = Date.now() - MAX_HISTORY_DAYS*86400000;
    for(const ds of Object.keys(history.days||{})){
      const t = Date.parse(ds+"T00:00:00Z");
      if(isFinite(t) && t < keepAfter) delete history.days[ds];
    }
  }
  function saveHistory(){
    cleanupHistory();
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  }
  function logPartsForToday(parts){
    const ds=todayStr();
    const day = history.days[ds] || {parts:[], updatedAt:0};
    const list = Array.isArray(parts) ? parts : [parts];
    list.forEach(p=>{
      if(!p) return;
      if(!day.parts.includes(p)) day.parts.push(p);
    });
    day.updatedAt = Date.now();
    history.days[ds]=day;
    saveHistory();
  }
  loadHistory();


  function now(){ return Date.now(); }
  function pad(n){ return String(n).padStart(2,'0'); }
  function fmtHMS(ms){
    ms=Math.max(0, Math.floor(ms));
    const s=Math.floor(ms/1000);
    const h=Math.floor(s/3600);
    const m=Math.floor((s%3600)/60);
    const ss=s%60;
    return `${pad(h)}:${pad(m)}:${pad(ss)}`;
  }

  function weightClass(sex, w){
    const x = Number(w);
    if(!isFinite(x) || x<=0) return "-";
    // ë°ëª¨ ì²´ê¸‰ êµ¬ê°„ (ì›í•˜ë©´ ë°”ë¡œ ë°”ê¿”ì¤„ê²Œ)
    const men=[60,65,70,75,80,85,90,100];
    const women=[50,55,60,65,70,75];
    const arr = (sex==="F")?women:men;
    for(const t of arr){
      if(x<=t) return `~${t}kg`;
    }
    return `${arr[arr.length-1]}kg+`;
  }


  const state={
    selectedPart:null,
    exercises:[],
    weightMode:"inc",
    timers:{
      startedAt:null,
      endedAt:null,
      currentExId:null,
      currentExStartedAt:null,
      
    }
  };

  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const snap=safeParse(localStorage.getItem(STORAGE_KEY));
    if(!snap) return;
    if(typeof snap.selectedPart==="string") state.selectedPart=snap.selectedPart;
    if(Array.isArray(snap.exercises)) state.exercises=snap.exercises;
    if(snap.weightMode==="inc"||snap.weightMode==="dec") state.weightMode=snap.weightMode;
    if(snap.timers) state.timers = Object.assign(state.timers, snap.timers);
  }
  loadState();
  state.exercises.forEach(ex=>{
    if(typeof ex.activeMs!=="number") ex.activeMs=0;
    if(typeof ex.setPhase!=="string") ex.setPhase = "idle";
    if(state.timers.currentExId===ex.id && state.timers.currentExStartedAt && !state.timers.endedAt && !ex.isDone){
      ex.setPhase = "active";
    }
  });

  // Timers: start on first exercise add. Exercise timer runs from add until "ì¢…ëª©ì™„ë£Œ"
  function ensureStarted(forceNew=false){
    // forceNew=trueë©´, 'ìš´ë™ ì¢…ë£Œ' í›„ ë‹¤ì‹œ ì‹œì‘í•  ë•Œ íƒ€ì´ë¨¸ë¥¼ ìƒˆë¡œ ì¡ëŠ”ë‹¤
    if(!state.timers.startedAt || (forceNew && state.timers.endedAt)){
      state.timers.startedAt = now();
      state.timers.endedAt = null;
      state.timers.currentExId = null;
      state.timers.currentExStartedAt = null;
      saveState();
    }
  }
  function stopCurrentExerciseSegment(){
    const curId=state.timers.currentExId;
    const started=state.timers.currentExStartedAt;
    if(!curId || !started) return;
    const ex=state.exercises.find(e=>e.id===curId);
    if(ex && !ex.isDone && !ex.isCollapsed && !ex.timePaused){
      ex.activeMs = (ex.activeMs||0) + Math.max(0, now()-started);
    }
    state.timers.currentExStartedAt=null;
  }
  function setCurrentExercise(exId){
    ensureStarted();
    if(state.timers.currentExId===exId && state.timers.currentExStartedAt) return;
    stopCurrentExerciseSegment();
    state.timers.currentExId = exId;
    state.timers.currentExStartedAt = now();
    saveState();
  }

  // Set-based timing (2ì„¸íŠ¸ë¶€í„° ì‹œì‘ ë²„íŠ¼)
  function startSet(ex){
    if(!ex || ex.isDone || state.timers.endedAt) return;
    // ë‹¤ë¥¸ ì¢…ëª©ì´ ì§„í–‰ì¤‘ì´ë©´ ì •ì§€ ì²˜ë¦¬
    state.exercises.forEach(o=>{
      if(o && o.id!==ex.id && o.setPhase==="active") o.setPhase="idle";
    });
    stopCurrentExerciseSegment();
    ensureStarted();
    state.timers.currentExId = ex.id;
    state.timers.currentExStartedAt = now();
    ex.setPhase = "active";
    ex.isCollapsed = false;
    saveState();
    renderExercises();
  }

  function finishSet(ex){
    if(!ex || ex.isDone || state.timers.endedAt) return;
    if(state.timers.currentExId===ex.id) stopCurrentExerciseSegment();
    ex.setPhase = "entry"; // ì…ë ¥ ëŒ€ê¸°
    saveState();
    renderExercises();
    openSetEntry(ex);
  }
  function endWorkout(){
    stopCurrentExerciseSegment();

    // ì¢…ëª©ì™„ë£Œë¥¼ ì•ˆ ëˆŒë €ì–´ë„ 'ìš´ë™ ì¢…ë£Œ'ë©´ ì „ë¶€ ì¢…ë£Œ ì²˜ë¦¬
    const t = now();
    for(const ex of state.exercises){
      if(!ex.isDone){
        ex.isDone = true;
        ex.isCollapsed = true;
        ex.setPhase = "idle";
      }
    }
    state.timers.currentExId = null;
    state.timers.currentExStartedAt = null;

    state.timers.endedAt = t;
    saveState();
  }
  function totalMs(){
    if(!state.timers.startedAt) return 0;
    const end = state.timers.endedAt || now();
    return Math.max(0, end - state.timers.startedAt);
  }
// Clock UI
  const workTotal=qs('#workTotal');
  const workTrain=qs('#workTrain');

  function trainMs(){
    let ms = 0;
    for(const ex of state.exercises){
      ms += (ex.activeMs||0);
    }
    if(state.timers.currentExId && state.timers.currentExStartedAt && !state.timers.endedAt){
      ms += Math.max(0, now()-state.timers.currentExStartedAt);
    }
    return ms;
  }

  function renderClock(){
    const tTotal = fmtHMS(totalMs());
    const tTrain = fmtHMS(trainMs());
    if(workTotal) workTotal.textContent = tTotal;
    if(workTrain) workTrain.textContent = tTrain;
  }


  // --- Ticker ---
  const tickerWrap=qs('#tickerWrap');
  const tickerLine=qs('#tickerLine');
  function getTouchedParts(){ return [...new Set(state.exercises.map(e=>e.part).filter(Boolean))]; }
  function buildTickerItems(){
    const parts=getTouchedParts();
    const fallback=["í•˜ì²´","ê°€ìŠ´","ë“±"];
    const use=parts.length?parts:fallback;
    const region="ì„œìš¸";
    const gym="Olympic Gym";
    const users=["jaeyang","userB","userC","userD","userE","userF","userG","userH","userI","userJ"];
    const out=[];
    use.forEach((p,pi)=>{
      for(let i=0;i<4;i++){
        const rank=i+1;
        const user=users[(pi+i)%users.length];
        const vol=(9000 - (pi*520 + i*310));
        out.push({part:p, rank, region, gym, user, vol});
      }
    });
    return out.slice(0,32);
  }
  
  function computeMyTodayPartVolume(part){
    let sum=0;
    for(const ex of state.exercises){
      if(ex.part!==part) continue;
      if(ex.type && ex.type!=="weight") continue;
      if(ex.isDone!==true) continue;
      sum += totalVolume(ex);
    }
    return sum;
  }

function startTicker(){
  const line = document.getElementById('tickerLine');
  if(!line) return;
  // duration based on half-width (because we duplicate content)
  requestAnimationFrame(()=>{
    const w = line.scrollWidth || 0;
    const half = (w>0) ? (w/2) : 0;
    const pxPerSec = 70; // speed
    const dur = Math.max(10, Math.round(((half||w)/pxPerSec)*10)/10);
    line.style.animationDuration = dur + "s";
  });
}

function renderTicker(){
  const line = qs('#tickerLine');
  if(!line) return;
  if(!line) return;

  const region = state.profile?.region || "ì„œìš¸";
  const gym = state.profile?.gym || "í—¬ìŠ¤ì¥";
  const me = state.profile?.nick || "ë‚˜";

  const parts = ["ê°€ìŠ´","ë“±","í•˜ì²´","ì–´ê¹¨","íŒ”","ë³µê·¼","ìœ ì‚°ì†Œ"];
  const items=[];
  parts.forEach((p, i)=>{
    items.push({part:p, rank:1, nick:"ìµëª…1", region:"ì„œìš¸", gym:"Aì§", vol: 5200 - i*320});
    items.push({part:p, rank:2, nick:"ìµëª…2", region:"ë¶€ì‚°", gym:"Bì§", vol: 4400 - i*300});
    items.push({part:p, rank:3, nick:"ìµëª…3", region:"ëŒ€êµ¬", gym:"Cì§", vol: 3800 - i*260});
  });

  const myPart = state.selectedPart || "ê°€ìŠ´";
  const myVol = (myPart==="ìœ ì‚°ì†Œ") ? 0 : computeMyTodayPartVolume(myPart);
  items.push({part:myPart, rank:4, nick:me, region, gym, vol: Math.round(myVol)});

  const htmlItems = items.map(it=>{
    const volTxt = (it.part==="ìœ ì‚°ì†Œ") ? `${Math.round(it.vol)}km` : `${Math.round(it.vol).toLocaleString()}kg`;
    return `<span class="tick-item">`
      + (()=>{
          const medal = (it.rank===1) ? "ğŸ¥‡" : (it.rank===2) ? "ğŸ¥ˆ" : (it.rank===3) ? "ğŸ¥‰" : (it.nick===me ? "ğŸ…" : "");
          const loc = `${it.region}Â·${it.gym}`;
          const medalHtml = medal ? `<span class="tick-medal">${medal}</span>` : "";
          return `${medalHtml}<span class="tick-part">${it.part}</span> <span class="tick-rank">#${it.rank}</span> <span class="tick-loc">${loc}</span> <span class="tick-nick">${it.nick}</span> <span class="tick-vol">${volTxt}</span>`;
      })()
      + `</span>`;
  }).join('<span class="tick-sep">â€¢</span>');

  // 2ë²ˆ ì´ì–´ë¶™ì—¬ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ë³µ
  line.innerHTML = htmlItems + '<span class="tick-sep">â€¢</span>' + htmlItems;
  startTicker();
}

  // Top10 overlay
  const overlayTop10=qs('#overlayTop10');
  const closeTop10=qs('#closeTop10');
  const top10Body=qs('#top10Body');
  function openTop10(){
    if(tickerLine) tickerLine.classList.add('paused');
    overlayTop10.classList.add('show'); overlayTop10.setAttribute('aria-hidden','false');
    const items=buildTickerItems();
    const byPart={};
    items.forEach(it=>{ (byPart[it.part]=byPart[it.part]||[]).push(it); });
    const parts=Object.keys(byPart);
    top10Body.innerHTML = parts.map(p=>{
      const list=byPart[p].sort((a,b)=>a.rank-b.rank).slice(0,10);
      return `
        <div class="card" style="padding:12px;margin-bottom:10px">
          <div class="row between">
            <div style="font-weight:900">${p}</div>
            <div class="muted">Top10</div>
          </div>
          ${list.map(it=>`
            <div class="top10-item">
              <div class="a">
                <div style="font-weight:900">${it.rank===1?"ğŸ¥‡":it.rank===2?"ğŸ¥ˆ":it.rank===3?"ğŸ¥‰":"ğŸ…"} #${it.rank} Â· ${it.user}</div>
                <div style="font-weight:900">${it.vol.toLocaleString()}kg</div>
              </div>
              <div class="b">${it.region} Â· ${it.gym}</div>
            </div>
          `).join("")}
        </div>
      `;
    }).join("");
  }
  function closeTop10Fn(){
    overlayTop10.classList.remove('show'); overlayTop10.setAttribute('aria-hidden','true');
    if(tickerLine) tickerLine.classList.remove('paused');
  }
  closeTop10.addEventListener('click', closeTop10Fn);
  overlayTop10.addEventListener('click', e=>{ if(e.target===overlayTop10) closeTop10Fn(); });
  if(tickerWrap) tickerWrap.addEventListener('click', openTop10);

  // Navigation
  const partCard=qs('#partCard'), workCard=qs('#workCard');
  const calendarCard=qs('#calendarCard');
  const selectedPartEl=qs('#selectedPart'), todaySmall=qs('#todaySmall'), exerciseList=qs('#exerciseList');
  const backBtn=qs('#backBtn'), addExerciseBtn=qs('#addExerciseBtn');
  const endBtn=qs('#endBtn');

  const calTitle=qs('#calTitle');
  const calDow=qs('#calDow');
  const calGrid=qs('#calGrid');

  const calDetail=qs('#calDetail');
  const calDetailTitle=qs('#calDetailTitle');
  const calDetailChips=qs('#calDetailChips');
  let calSelectedDate = null;

  function renderCalDetail(ds){
    if(!calDetail || !calDetailTitle || !calDetailChips) return;
    if(!ds){
      calDetail.style.display="none";
      return;
    }
    const parts = (history.days[ds]?.parts)||[];
    calDetailTitle.textContent = ds + " ìš´ë™ë¶€ìœ„";
    calDetailChips.innerHTML = parts.length
      ? parts.map(p=>`<span class="chip">${p}</span>`).join("")
      : `<div class="muted">ê¸°ë¡ ì—†ìŒ</div>`;
    calDetail.style.display="";
  }

  if(calGrid){
    calGrid.addEventListener('click',(e)=>{
      const cell = e.target.closest('.cal-cell[data-cal-date]');
      if(!cell) return;
      calSelectedDate = cell.getAttribute('data-cal-date');
      renderCalendar();
      renderCalDetail(calSelectedDate);
    });
  }


  function syncHeaderVisibility(){
    const active = document.querySelector('.screen.active');
    const screenName = active ? (active.id||"").replace('screen-','') : "today";
    const inPicker = (screenName==="today" && partCard && workCard && partCard.style.display!=="none" && workCard.style.display==="none");
    const onSummary = (screenName==="summary");
    const hide = inPicker || onSummary;

    // optional elements (may not exist in some steps)
    const _tickerWrap = document.getElementById('tickerWrap');
    const _clockBox = document.getElementById('clockBox');
    if(_tickerWrap) _tickerWrap.classList.toggle('hidden', hide);
    if(_clockBox) _clockBox.classList.toggle('hidden', hide);
  }

  function renderCalendar(){
    if(!calendarCard || !calTitle || !calDow || !calGrid) return;
    const d = new Date();
    const y = d.getFullYear();
    const m = d.getMonth(); // 0-based
    calTitle.textContent = `${y}-${String(m+1).padStart(2,'0')}`;

    const dows = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
    calDow.innerHTML = dows.map(x=>`<div class="cal-cell">${x}</div>`).join("");

    const first = new Date(y, m, 1);
    const lastDay = new Date(y, m+1, 0).getDate();
    const start = first.getDay(); // Sunday=0

    const cells = [];
    for(let i=0;i<start;i++) cells.push('<div class="cal-cell blank"></div>');

    for(let day=1; day<=lastDay; day++){
      const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const parts = (history.days[ds]?.parts)||[];
      const shown = parts.slice(0,2);
      const more = parts.length - shown.length;
      const sub = parts.length ? (shown.join('Â·') + (more>0 ? " +"+more : "")) : "";
      const isToday = ds===todayStr();

      
      const isSel = (calSelectedDate && ds===calSelectedDate);
cells.push(
        `<div class="cal-cell ${isToday?"cal-today":""} ${isSel?"cal-selected":""}" data-cal-date="${ds}">`
        + `<div class="cal-day">${day}</div>`
        + `<div class="cal-sub ${parts.length? "":"muted"}">${sub}</div>`
        + `</div>`
      );
    }

    while(cells.length<42) cells.push('<div class="cal-cell blank"></div>');
    calGrid.innerHTML = cells.join("");
  
    if(calSelectedDate) renderCalDetail(calSelectedDate);
}


  function showPartPicker(){
    partCard.style.display="";
    if(calendarCard) calendarCard.style.display="";
    workCard.style.display="none";
    renderCalendar();
    syncHeaderVisibility();
  }
  function showWork(part, forceStart=false){
    // forceStart=true: ì‚¬ìš©ìê°€ ë¶€ìœ„ë¥¼ ìƒˆë¡œ ì„ íƒí•œ ì¼€ì´ìŠ¤(=ìš´ë™ ì‹œì‘/ì¬ì‹œì‘)
    // forceStart=false: ë¶€íŠ¸/ë³µì› í™”ë©´(ì¢…ë£Œëœ ì„¸ì…˜ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€)
    if(forceStart) ensureStarted(true);
    else ensureStarted(false);
    state.selectedPart=part; saveState();
    selectedPartEl.textContent=part;
    todaySmall.textContent=new Date().toISOString().slice(0,10);
    partCard.style.display="none";
    if(calendarCard) calendarCard.style.display="none";
    workCard.style.display="";
    syncHeaderVisibility();
    renderExercises();
    renderClock();
  }
  qsa('#partGrid .btn').forEach(b=>b.addEventListener('click',()=>showWork(b.dataset.part, true)));
  backBtn.addEventListener('click',showPartPicker);

  // Examples + previous workout (demo)
  const EXAMPLES={
    "ê°€ìŠ´":["ë²¤ì¹˜í”„ë ˆìŠ¤","ì¸í´ë¼ì¸ ë²¤ì¹˜í”„ë ˆìŠ¤","ì²´ìŠ¤íŠ¸í”„ë ˆìŠ¤","ë”¥ìŠ¤","í‘¸ì‰¬ì—…"],
    "ë“±":["ë«í’€ë‹¤ìš´","ì‹œí‹°ë“œë¡œìš°","ë°”ë²¨ë¡œìš°","í’€ì—…","í˜ì´ìŠ¤í’€"],
    "í•˜ì²´":["ìŠ¤ì¿¼íŠ¸","ë ˆê·¸í”„ë ˆìŠ¤","ëŸ°ì§€","í™ì“°ëŸ¬ìŠ¤íŠ¸","ë ˆê·¸ìµìŠ¤í…ì…˜","ë ˆê·¸ì»¬","ì¹´í”„ë ˆì´ì¦ˆ"],
    "ì–´ê¹¨":["ì˜¤ë²„í—¤ë“œí”„ë ˆìŠ¤","ì‚¬ì´ë“œë ˆí„°ëŸ´ë ˆì´ì¦ˆ","ìˆ„ë”í”„ë ˆìŠ¤","ë¦¬ì–´ë¸íŠ¸í”Œë¼ì´"],
    "íŒ”":["ë°”ë²¨ì»¬","ë¤ë²¨ì»¬","í•´ë¨¸ì»¬","í‘¸ì‹œë‹¤ìš´","ìŠ¤ì»¬í¬ëŸ¬ì…”"],
    "ë³µê·¼":["í¬ëŸ°ì¹˜","í–‰ì‰ ë ˆê·¸ë ˆì´ì¦ˆ","í”Œë­í¬","ì¼€ì´ë¸” í¬ëŸ°ì¹˜"],
    "ìœ ì‚°ì†Œ":["ëŸ¬ë‹","ì‚¬ì´í´","ê³„ë‹¨"]
  };
  function seedPrevWorkoutRecord(ex){
    if(ex.prevWorkoutRecord) return;
    const d=new Date(Date.now()-86400000*3);
    const ds=d.toISOString().slice(0,10);
    const base={"ìŠ¤ì¿¼íŠ¸":{w:60,r:8,sets:3},"ë ˆê·¸í”„ë ˆìŠ¤":{w:120,r:10,sets:4},"ë²¤ì¹˜í”„ë ˆìŠ¤":{w:40,r:10,sets:3},"ë«í’€ë‹¤ìš´":{w:50,r:10,sets:3},"ì˜¤ë²„í—¤ë“œí”„ë ˆìŠ¤":{w:25,r:8,sets:3}};
    const b=base[ex.name]||{w:20,r:10,sets:3};
    ex.prevWorkoutRecord={date:ds,w:b.w,r:b.r,sets:b.sets};
    ex.prevWorkoutVolume = Math.round(b.w*b.r*b.sets);
  }

  // Add exercise overlay
  const overlayPrompt=qs('#overlayPrompt'), closePrompt=qs('#closePrompt'), promptSub=qs('#promptSub');
  const exerciseName=qs('#exerciseName'), confirmAdd=qs('#confirmAdd'), exerciseChips=qs('#exerciseChips');
  function openPrompt(){
    if(!state.selectedPart) return;
    promptSub.textContent=`ì¶”ê°€í•  ë¶€ìœ„: ${state.selectedPart}`;
    exerciseName.value="";
    exerciseChips.innerHTML="";
    (EXAMPLES[state.selectedPart]||[]).forEach(n=>{
      const c=document.createElement('div');
      c.className="chip"; c.textContent=n;
      c.addEventListener('click',()=>{exerciseName.value=n; exerciseName.focus();});
      exerciseChips.appendChild(c);
    });
    overlayPrompt.classList.add('show'); overlayPrompt.setAttribute('aria-hidden','false');
    setTimeout(()=>exerciseName.focus(),50);
  }
  function closePromptFn(){ overlayPrompt.classList.remove('show'); overlayPrompt.setAttribute('aria-hidden','true'); }
  addExerciseBtn.addEventListener('click',openPrompt);
  closePrompt.addEventListener('click',closePromptFn);
  overlayPrompt.addEventListener('click',e=>{if(e.target===overlayPrompt) closePromptFn();});

  // Start overlay
  const overlayStart=qs('#overlayStart'), closeStart=qs('#closeStart'), startSub=qs('#startSub'), startCount=qs('#startCount');
  let startTimer=null;
  function openStart(ex){
    startSub.textContent=`${ex.part} Â· ${ex.name}`;
    overlayStart.classList.add('show'); overlayStart.setAttribute('aria-hidden','false');
    let left=10;
    startCount.textContent=`${left}ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.`;
    if(startTimer) clearInterval(startTimer);
    startTimer=setInterval(()=>{
      left-=1;
      if(left<=0) closeStartFn();
      else startCount.textContent=`${left}ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.`;
    },1000);
  }
  function closeStartFn(){
    if(startTimer){clearInterval(startTimer); startTimer=null;}
    overlayStart.classList.remove('show'); overlayStart.setAttribute('aria-hidden','true');
  }
  closeStart.addEventListener('click',closeStartFn);
  overlayStart.addEventListener('click',e=>{if(e.target===overlayStart) closeStartFn();});

  function addExercise(name){
    // ì¢…ë£Œëœ ì„¸ì…˜ì´ì—ˆìœ¼ë©´ ìƒˆ ìš´ë™ìœ¼ë¡œ ê°„ì£¼í•´ì„œ íƒ€ì´ë¨¸ë¥¼ ìƒˆë¡œ ì‹œì‘
    ensureStarted(!!state.timers.endedAt);
    const id=crypto.randomUUID?crypto.randomUUID():String(Date.now())+Math.random();
    const ex={
      id, part:state.selectedPart, name,
      weightKg:0.0, barUsed:false, weightHist:[],
      sets:[],
      prevWorkoutRecord:null,
      prevWorkoutVolume:null,
      isCollapsed:false,
      isDone:false,
      activeMs:0,
      setPhase:"active",
      timePaused:false,
      timePausedAt:null,
      timePausedMs:0
    };
    seedPrevWorkoutRecord(ex);
    state.exercises.push(ex);

    // ìº˜ë¦°ë”ìš©: ì˜¤ëŠ˜ ìš´ë™í•œ ë¶€ìœ„ ê¸°ë¡
    logPartsForToday(ex.part);

    // 1ì„¸íŠ¸ëŠ” ìë™ ì‹œì‘
    startSet(ex);

    saveState(); renderTicker();
    closePromptFn();
    renderExercises();
    openStart(ex);
  }
  confirmAdd.addEventListener('click',()=>{const n=(exerciseName.value||"").trim(); if(n) addExercise(n);});
  exerciseName.addEventListener('keydown',e=>{if(e.key==="Enter") confirmAdd.click();});

  // --- Set overlay (2-step) ---
  const overlaySet=qs('#overlaySet'), closeSet=qs('#closeSet'), setTitle=qs('#setTitle'), setSub=qs('#setSub');
  const stepWeight=qs('#stepWeight'), stepReps=qs('#stepReps');
  const setWeightVal=qs('#setWeightVal'), unitToggle=qs('#unitToggle');
  const incBtn=qs('#incBtn'), decBtn=qs('#decBtn');
  const kbdKg=qs('#kbdKg'), kbdLb=qs('#kbdLb');
  const barKey=qs('#barKey'), backKey=qs('#backKey');
  const lbBack=qs('#lbBack');
  const nextToReps=qs('#nextToReps'), backToWeight=qs('#backToWeight');
  const setRepsVal=qs('#setRepsVal'), repsClear=qs('#repsClear'), repsBack=qs('#repsBack'), saveSetBtn=qs('#saveSetBtn');

  let currentExId=null;
  let currentReps=0;
  let unit="kg";
  let tempKg=0;
  let lbStr="";
  let pressTimer=null, repsPress=null;

  function showStep(which){
    if(which==="weight"){ stepWeight.classList.remove('hidden'); stepReps.classList.add('hidden'); }
    else{ stepWeight.classList.add('hidden'); stepReps.classList.remove('hidden'); }
  }
  function updateWeightUI(){
    if(unit==="kg"){
      unitToggle.textContent="KG";
      kbdKg.classList.remove('hidden'); kbdLb.classList.add('hidden');
      setWeightVal.textContent=fmtKg(tempKg);
    }else{
      unitToggle.textContent="LB";
      kbdKg.classList.add('hidden'); kbdLb.classList.remove('hidden');
      const lb = lbStr==="" ? 0 : parseFloat(lbStr);
      const shown = isFinite(lb) ? lb : 0;
      setWeightVal.textContent = String(shown);
      tempKg = lbToKg(shown || 0);
    }
  }
  function setMode(mode){
    state.weightMode=mode; saveState();
    incBtn.style.borderColor=(mode==="inc")?"var(--accent)":"var(--line)";
    decBtn.style.borderColor=(mode==="dec")?"var(--accent)":"var(--line)";
    incBtn.style.color=(mode==="inc")?"var(--accent2)":"var(--txt)";
    decBtn.style.color=(mode==="dec")?"var(--accent2)":"var(--txt)";
  }
  setMode(state.weightMode);
  incBtn.addEventListener('click',()=>setMode("inc"));
  decBtn.addEventListener('click',()=>setMode("dec"));

  unitToggle.addEventListener('click',()=>{
    if(unit==="kg"){ unit="lb"; lbStr=(tempKg>0)?(kgToLb(tempKg).toFixed(1).replace(/\.0$/,"")):""; }
    else{ unit="kg"; lbStr=""; }
    updateWeightUI();
  });

  function openSetEntry(ex){
    ex.isCollapsed=false;
    saveState();

    currentExId=ex.id;
    const nextNo=(ex.sets?.length||0)+1;

    if(nextNo>=2){
      const last=ex.sets[ex.sets.length-1];
      if(last && typeof last.w==="number"){ ex.weightKg=last.w; ex.weightHist=[]; ex.barUsed=false; }
    }
    const lastRep = ex.sets?.length ? ex.sets[ex.sets.length-1].r : 0;

    setTitle.textContent=`${nextNo}ì„¸íŠ¸ ì…ë ¥`;
    setSub.textContent=`${ex.part} Â· ${ex.name}`;

    unit="kg"; lbStr=""; tempKg=+(ex.weightKg||0);
    currentReps = lastRep || 0;
    setRepsVal.textContent = String(currentReps);

    barKey.classList.toggle('disabled',!!ex.barUsed);

    showStep("weight"); updateWeightUI();
    overlaySet.classList.add('show'); overlaySet.setAttribute('aria-hidden','false');
    saveState();
  }
  function closeSetFn(){
    overlaySet.classList.remove('show'); overlaySet.setAttribute('aria-hidden','true');
    currentExId=null; unit="kg"; lbStr=""; tempKg=0;
    showStep("weight");
    renderExercises();
  }
  closeSet.addEventListener('click',closeSetFn);
  overlaySet.addEventListener('click',e=>{if(e.target===overlaySet) closeSetFn();});

  function applyDeltaKg(ex, delta){
    const signed=(state.weightMode==="inc")?delta:-delta;
    tempKg=Math.max(0, +(tempKg + signed).toFixed(2));
    ex.weightHist = ex.weightHist || [];
    ex.weightHist.push({delta:signed, bar:false});
    updateWeightUI();
    saveState();
  }
  qsa('#kbdKg .key[data-d]').forEach(k=>k.addEventListener('click',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    applyDeltaKg(ex, parseFloat(k.dataset.d));
  }));
  barKey.addEventListener('click',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex || ex.barUsed) return;
    const signed=(state.weightMode==="inc")?20:-20;
    tempKg=Math.max(0, +(tempKg + signed).toFixed(2));
    ex.weightHist = ex.weightHist || [];
    ex.weightHist.push({delta:signed, bar:true});
    ex.barUsed=true; barKey.classList.add('disabled');
    updateWeightUI(); saveState();
  });
  function undoLast(ex){
    ex.weightHist = ex.weightHist || [];
    const last=ex.weightHist.pop(); if(!last) return;
    tempKg=Math.max(0, +(tempKg - last.delta).toFixed(2));
    if(last.bar){ ex.barUsed=false; barKey.classList.remove('disabled'); }
    updateWeightUI(); saveState();
  }
  function clearAll(ex){
    tempKg=0; ex.weightHist=[]; ex.barUsed=false;
    barKey.classList.remove('disabled');
    unit="kg"; lbStr="";
    updateWeightUI(); saveState();
  }
  backKey.addEventListener('pointerdown',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    pressTimer=setTimeout(()=>clearAll(ex),650);
  });
  backKey.addEventListener('pointerup',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    if(pressTimer){clearTimeout(pressTimer); pressTimer=null; undoLast(ex);}
  });
  backKey.addEventListener('pointerleave',()=>{if(pressTimer){clearTimeout(pressTimer); pressTimer=null;}});

  function lbAppend(ch){
    if(ch==="." && lbStr.includes(".")) return;
    if(lbStr.length>=6) return;
    if(lbStr==="" && ch===".") lbStr="0.";
    else lbStr += ch;
    updateWeightUI();
  }
  qsa('#kbdLb .key[data-lb]').forEach(k=>k.addEventListener('click',()=>lbAppend(k.dataset.lb)));
  lbBack.addEventListener('click',()=>{
    if(lbStr.length<=1){lbStr="";} else {lbStr=lbStr.slice(0,-1);}
    updateWeightUI();
  });

  nextToReps.addEventListener('click',()=>{ showStep("reps"); });
  backToWeight.addEventListener('click',()=>{ showStep("weight"); });

  function setRepsFromDigit(d){
    const s=(String(currentReps)==="0")?"":String(currentReps);
    const next=(s+String(d)).slice(0,3);
    currentReps=next===""?0:parseInt(next,10);
    setRepsVal.textContent=String(currentReps);
  }
  qsa('#stepReps .key[data-n]').forEach(k=>k.addEventListener('click',()=>setRepsFromDigit(k.dataset.n)));
  repsClear.addEventListener('click',()=>{currentReps=0; setRepsVal.textContent="0";});
  function repsUndo(){
    const s=String(currentReps);
    if(s.length<=1){currentReps=0; setRepsVal.textContent="0"; return;}
    currentReps=parseInt(s.slice(0,-1),10);
    setRepsVal.textContent=String(currentReps);
  }
  function repsClearAll(){currentReps=0; setRepsVal.textContent="0";}
  repsBack.addEventListener('pointerdown',()=>{repsPress=setTimeout(()=>repsClearAll(),650);});
  repsBack.addEventListener('pointerup',()=>{if(repsPress){clearTimeout(repsPress); repsPress=null; repsUndo();}});
  repsBack.addEventListener('pointerleave',()=>{if(repsPress){clearTimeout(repsPress); repsPress=null;}});

  function saveOneSet(ex){
    if(currentReps<=0) return false;
    ex.weightKg = +(tempKg||0);
    ex.sets.push({w:ex.weightKg, r:currentReps, ts:Date.now()});
    ex.setPhase = "idle";
    saveState(); renderTicker();
    return true;
  }
  saveSetBtn.addEventListener('click',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    if(!saveOneSet(ex)) return;
    closeSetFn();
    renderExercises();
  });

  // Delete set/exercise
  function deleteSet(ex, idx){
    if(idx<0||idx>=ex.sets.length) return;
    ex.sets.splice(idx,1);
    saveState(); renderTicker(); renderExercises();
  }
  function deleteExercise(ex){
    const ok = confirm(`${ex.name} ì¢…ëª©ì„ ì‚­ì œí• ê¹Œ?`);
    if(!ok) return;
    if(state.timers.currentExId===ex.id){
      stopCurrentExerciseSegment();
      state.timers.currentExId=null;
      state.timers.currentExStartedAt=null;
    }
    state.exercises = state.exercises.filter(e=>e.id!==ex.id);
    saveState(); renderTicker(); renderExercises();
  }

  // Swipe
  const SWIPE_OPEN_X=-86;
  function closeAllSwipes(root){ qsa('.swipe.open', root||document).forEach(el=>el.classList.remove('open')); }
  function attachSwipeHandlers(container){
    const swipes=qsa('.swipe', container);
    swipes.forEach(el=>{
      let startX=0,startY=0,dragging=false,moved=false,openAtStart=false;
      const front=qs('.swipe-front', el);
      if(!front) return;

      el.addEventListener('pointerdown', (e)=>{
        if(e.pointerType==="mouse" && e.button!==0) return;
        startX=e.clientX; startY=e.clientY; dragging=true; moved=false;
        openAtStart=el.classList.contains('open');
        el.setPointerCapture(e.pointerId);
      });

      el.addEventListener('pointermove', (e)=>{
        if(!dragging) return;
        const dx=e.clientX-startX;
        const dy=e.clientY-startY;
        if(!moved && Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 8){
          dragging=false;
          front.style.transition="transform 140ms ease-out";
          front.style.transform=openAtStart?`translateX(${SWIPE_OPEN_X}px)`:"translateX(0px)";
          return;
        }
        if(Math.abs(dx)>6) moved=true;

        let x=dx;
        if(x>0) x=0;
        if(x<SWIPE_OPEN_X) x=SWIPE_OPEN_X;
        front.style.transition="none";
        front.style.transform=`translateX(${x}px)`;
        e.preventDefault();
      }, {passive:false});

      el.addEventListener('pointerup', ()=>{
        if(!dragging) return;
        dragging=false;
        front.style.transition="transform 140ms ease-out";
        const m=/translateX\((-?\d+(?:\.\d+)?)px\)/.exec(front.style.transform||"");
        const cur=m?parseFloat(m[1]):(el.classList.contains('open')?SWIPE_OPEN_X:0);
        const shouldOpen=cur<(SWIPE_OPEN_X/2);
        if(shouldOpen){
          closeAllSwipes(container);
          el.classList.add('open');
          front.style.transform=`translateX(${SWIPE_OPEN_X}px)`;
        }else{
          el.classList.remove('open');
          front.style.transform="translateX(0px)";
        }
      });

      el.addEventListener('pointercancel', ()=>{
        dragging=false;
        front.style.transition="transform 140ms ease-out";
        front.style.transform=el.classList.contains('open')?`translateX(${SWIPE_OPEN_X}px)`:"translateX(0px)";
      });
    });

    container.addEventListener('touchstart', (e)=>{
      if(!e.target.closest('.swipe')) closeAllSwipes(container);
    }, {passive:true});
  }

  // Accordion + done
  const totalVolume=ex=>(ex.sets||[]).reduce((a,s)=>a+(s.w*s.r),0);
  function toggleCollapse(ex){
    ex.isCollapsed = !ex.isCollapsed;
    saveState();
    renderExercises();
  }

  function toggleCollapseWithTimer(ex){ toggleCollapse(ex); }
  function markDone(ex){
    const ok = confirm(`${ex.name}ë¥¼ ì™„ë£Œí•˜ê² ìŠµë‹ˆê¹Œ?`);
    if(!ok) return;

    // ì¢…ëª© ì™„ë£Œ ìˆœê°„ íƒ€ì´ë¨¸ ì¢…ë£Œ
    if(state.timers.currentExId===ex.id){
      stopCurrentExerciseSegment();
      state.timers.currentExId=null;
      state.timers.currentExStartedAt=null;
    }
    ex.isDone=true;
    ex.setPhase="idle";
    ex.isCollapsed=true;
    saveState();
    renderExercises();
  }

  
  function toggleTimePause(ex){
    if(!ex) return;
    if(ex.isDone) return; // ì™„ë£Œëœ ì¢…ëª©ì€ ì¡°ì‘ ë¶ˆê°€
    if(state.timers.currentExId!==ex.id) return; // í˜„ì¬ ì§„í–‰ì¤‘ ì¢…ëª©ë§Œ ì¡°ì‘ (ë‹¤ë¥¸ ì¢…ëª©ì— ì˜í–¥ X)

    if(!ex.timePaused){
      // pause current exercise only
      stopCurrentExerciseSegment(); // í˜„ì¬ ì¢…ëª© ì„¸ê·¸ë¨¼íŠ¸ë§Œ ì •ë¦¬
      ex.timePaused = true;
      ex.timePausedAt = now();
      state.timers.currentExStartedAt = null;
      saveState();
      renderExercises();
      return;
    }
    // resume
    ex.timePaused = false;
    ex.timePausedAt = null;
    if(!ex.isCollapsed){
      state.timers.currentExStartedAt = now();
    }
    saveState();
    renderExercises();
  }


function updateExerciseTimeBadges(){
    qsa('[data-ex-time]').forEach(el=>{
      const id=el.getAttribute('data-ex-time');
      const ex=state.exercises.find(e=>e.id===id);
      if(!ex) return;
      let ms = ex.activeMs||0;
      if(state.timers.currentExId===id && state.timers.currentExStartedAt && !ex.isDone && !ex.isCollapsed ){
        ms += Math.max(0, now()-state.timers.currentExStartedAt);
      }
      el.textContent = fmtHMS(ms);
      el.classList.toggle("time-paused", !!ex.timePaused);
      if(ex.isDone){ el.title="ì™„ë£Œë¨"; }
      else if(ex.timePaused){ el.title="ì¼ì‹œì •ì§€ì¤‘ (í„°ì¹˜: ì¬ê°œ)"; }
      else { el.title="í„°ì¹˜: ì¼ì‹œì •ì§€/ì¬ê°œ"; }
    });
  }

  function renderExercises(){
    exerciseList.innerHTML="";
    if(state.exercises.length===0){
      const empty=document.createElement('div');
      empty.className="muted"; empty.style.padding="6px 2px";
      empty.textContent="ì¢…ëª©ì„ ì¶”ê°€í•´ì¤˜.";
      exerciseList.appendChild(empty);
      return;
    }

    const order=["ê°€ìŠ´","ë“±","í•˜ì²´","ì–´ê¹¨","íŒ”","ë³µê·¼","ìœ ì‚°ì†Œ"];
    const groups = {};
    state.exercises.forEach(e=>{ (groups[e.part]=groups[e.part]||[]).push(e); });

    order.filter(p=>groups[p]?.length).forEach(part=>{
      const label=document.createElement('div');
      label.className="part-label";
      label.innerHTML = `<strong>${part}</strong> Â· ${groups[part].length}ì¢…ëª©`;
      exerciseList.appendChild(label);

      groups[part].forEach(ex=>{
        const card=document.createElement('div');
        card.className="card ex-card";
        card.dataset.id=ex.id;

        const sets=ex.sets||[];
        const vol=totalVolume(ex);
        const prevVol = (typeof ex.prevWorkoutVolume==="number") ? ex.prevWorkoutVolume : null;
        const nextNo=sets.length+1;
        const phase = (state.timers.endedAt || ex.isDone) ? "idle" : (ex.setPhase||"idle");
        const isActive = (phase==="active");
        if(isActive) card.classList.add('active');
        if(ex.isCollapsed) card.classList.add('collapsed');
        const head = document.createElement('div');
        head.className="ex-head";
        head.innerHTML = `
          <div class="ex-x" data-action="x" title="ì¢…ëª©ì‚­ì œ">âœ•</div>
          <div class="ex-left">
            <div class="muted">${ex.part}</div>
            <div class="ex-title">${ex.name}</div>
            <div class="ex-sub">${
              ex.isDone ? "ì™„ë£Œë¨"
              : (phase==="active" ? "ì§„í–‰ì¤‘" : (phase==="entry" ? "ì…ë ¥ëŒ€ê¸°" : "ëŒ€ê¸°ì¤‘"))
            }</div>
          </div>
          <div class="ex-meta">
            <div class="ex-actions">
              <div class="btn small good" data-action="done" ${ex.isDone?'style=\'opacity:.45;pointer-events:none\'':''}>ì¢…ëª©ì™„ë£Œ</div>
            </div>
            <div class="ex-right">
              <div class="ex-vol">${ex.type==="cardio" ? ((ex.cardio?.distanceKm||0)+"km") : (vol.toLocaleString()+"kg")}</div>
              <div class="chev" aria-hidden="true">${ex.isCollapsed ? "â–¸" : "â–¾"}</div>
            </div>
          </div>
        `;
        head.addEventListener('click',(ev)=>{
          const a=ev.target.closest('[data-action]');
          if(a) return;
          toggleCollapse(ex);
        });

        const body=document.createElement('div');
        body.style.marginTop="10px";
        body.style.borderTop="1px dashed var(--line)";
        body.style.paddingTop="8px";
        if(ex.isCollapsed) body.classList.add('hidden');

        const setRows = sets.map((s,i)=>`
          <div class="swipe" data-idx="${i}">
            <div class="swipe-actions">
              <div class="btn danger small" data-action="del" data-idx="${i}">ì‚­ì œ</div>
            </div>
            <div class="swipe-front done">
              <div class="set-row done">
                <div class="set-left">
                  <div class="set-no"><span class="check">âœ“</span>${i+1}ì„¸íŠ¸</div>
                  <div class="set-val">${fmtKg(s.w)}kg Ã— ${s.r} reps</div>
                </div>
                <div class="set-vol">${(s.w*s.r).toLocaleString()}kg</div>
              </div>
            </div>
          </div>
        `).join("");

        const prev=ex.prevWorkoutRecord;
        const ghost = prev
          ? `<div class="prev-date">${prev.date}</div><div class="prev-val">${fmtKg(prev.w)}kg*${prev.r}reps</div>`
          : `<div class="prev-date">ì´ì „ ì—†ìŒ</div><div class="prev-val">-</div>`;

                const disabled = ex.isDone || !!state.timers.endedAt;
        let liveBtn = "";
        if(phase==="active"){
          liveBtn = `<div class="btn ghost small" data-action="finishset" ${disabled?"style='opacity:.45;pointer-events:none'":""}>ì™„ë£Œ</div>`;
        }else if(phase==="entry"){
          liveBtn = `<div class="btn ghost small" data-action="set" ${disabled?"style='opacity:.45;pointer-events:none'":""}>ì…ë ¥</div>`;
        }else{
          liveBtn = `<div class="btn ghost small" data-action="startset" ${disabled?"style='opacity:.45;pointer-events:none'":""}>ì‹œì‘</div>`;
        }

        const liveRow = `
          <div class="set-row live ${phase==="active" ? "live-active" : ""} ${phase==="entry" ? "live-entry" : ""}">
            <div class="set-left">
              <div class="set-no"><span class="live-dot"></span>${nextNo}ì„¸íŠ¸</div>
              <div class="set-val prev-box ghosttext">${ghost}</div>
            </div>
            ${liveBtn}
          </div>
        `;

        const prevNote = prev ? `(${prev.date})` : "(ì´ì „ ì—†ìŒ)";
        const prevLine = prevVol!=null ? `${Math.round(prevVol).toLocaleString()}kg` : "-";

        if(ex.type==="cardio"){
  const c=ex.cardio||{mode:"ì•¼ì™¸",distanceKm:0,minutes:0,seconds:0,paceSecPerKm:null};
  const dist=+(c.distanceKm||0);
  const durSec=(+(c.minutes||0)*60)+(+(c.seconds||0));
  const pace = (dist>0 && durSec>0) ? Math.round(durSec/dist) : null;
  const paceTxt = pace!=null ? `${Math.floor(pace/60)}m ${String(pace%60).padStart(2,'0')}s/km` : "-";
  const durTxt = `${c.minutes||0}m ${String(c.seconds||0).padStart(2,'0')}s`;
  body.innerHTML = `
    <div class="set-row" style="padding:10px 10px;border:1px dashed rgba(42,48,64,.7);border-radius:12px">
      <div class="set-left">
        <div class="set-no">ê¸°ë¡</div>
        <div class="set-val">${c.mode} Â· ${dist}km Â· ${durTxt}</div>
      </div>
      <div class="btn ghost small" data-action="cardio" ${ex.isDone?"style='opacity:.45;pointer-events:none'":""}>ì™„ë£Œ</div>
    </div>
    <div class="compare">
      <div class="box">
        <div class="k">í˜ì´ìŠ¤</div>
        <div class="v">${paceTxt}</div>
        <div class="s">Distance : ${dist}km</div>
      </div>
      <div class="box">
        <div class="k">í›ˆë ¨ì‹œê°„</div>
        <div class="v"><span data-ex-time="${ex.id}">00:00:00</span></div>
        <div class="s">${c.mode} Â· ì•¼ì™¸/ì‹¤ë‚´</div>
      </div>
    </div>
  `;
} else {
  body.innerHTML = `
    ${setRows}
    ${liveRow}
    <div class="compare">
      <div class="box">
        <div class="k">ì´ì „ ìš´ë™ ë³¼ë¥¨</div>
        <div class="v">${prevLine}</div>
        <div class="s">${prevNote} Â· ë°ëª¨</div>
      </div>
      <div class="box">
        <div class="k">ì˜¤ëŠ˜ ë³¼ë¥¨</div>
        <div class="v">${Math.round(vol).toLocaleString()}kg</div>
        <div class="s">${sets.length}ì„¸íŠ¸ Â· í›ˆë ¨ <span data-ex-time="${ex.id}">00:00:00</span></div>
      </div>
    </div>
  `;
}

        card.addEventListener('click',(ev)=>{
          const a=ev.target.closest('[data-action]');
          if(!a) return;
          ev.preventDefault(); ev.stopPropagation();
          const action=a.dataset.action;
          if(action==="startset") startSet(ex);
          if(action==="finishset") finishSet(ex);
          if(action==="set") openSetEntry(ex);
          if(action==="cardio") openCardioEntry(ex);
          if(action==="del") deleteSet(ex, parseInt(a.dataset.idx,10));
          if(action==="done") markDone(ex);
          if(action==="x") deleteExercise(ex);
        });

        card.appendChild(head);
        card.appendChild(body);
        exerciseList.appendChild(card);
        attachSwipeHandlers(card);

        const doneBtn = card.querySelector('[data-action="done"]');
        if(ex.isDone) { doneBtn.textContent="ì™„ë£Œë¨"; doneBtn.style.opacity=".55"; doneBtn.style.pointerEvents="none"; }
      });
    });
  }

// --- Cardio overlay ---
const overlayCardio=qs('#overlayCardio');
const closeCardio=qs('#closeCardio');
const cardioTitle=qs('#cardioTitle');
const cardioSub=qs('#cardioSub');
const cardioOutdoor=qs('#cardioOutdoor');
const cardioIndoor=qs('#cardioIndoor');
const cardioPace=qs('#cardioPace');
const distVal=qs('#distVal');
const minVal=qs('#minVal');
const secVal=qs('#secVal');
const cardioFocusDist=qs('#cardioFocusDist');
const cardioFocusTime=qs('#cardioFocusTime');
const cardioBack=qs('#cardioBack');
const cardioDot=qs('#cardioDot');
const saveCardio=qs('#saveCardio');

let cardioExId=null;
let cardioFocus="dist";
let distStr="", minStr="", secStr="";

function setPill(el,on){
  el.style.borderColor = on ? "var(--accent)" : "var(--line)";
  el.style.color = on ? "var(--accent2)" : "var(--txt)";
}
function paceText(dist, mins, secs){
  const d=dist, t=mins*60+secs;
  if(!(d>0 && t>0)) return "-";
  const p=Math.round(t/d);
  return `${Math.floor(p/60)}m ${String(p%60).padStart(2,'0')}s/km`;
}
function updateCardioUI(){
  distVal.textContent = distStr==="" ? "0" : distStr;
  const mins = parseInt(minStr||"0",10)||0;
  const secs = parseInt(secStr||"0",10)||0;
  minVal.textContent = String(mins);
  secVal.textContent = String(secs).padStart(2,'0');
  const dist = parseFloat(distStr||"0")||0;
  cardioPace.textContent = paceText(dist, mins, secs);

  setPill(cardioFocusDist, cardioFocus==="dist");
  setPill(cardioFocusTime, cardioFocus==="time");
}

function openCardioEntry(ex){
  ex.isCollapsed=false;
  saveState();
  // íƒ€ì´ë¨¸ëŠ” ì‹œê³„ê°€ ë©ˆì¶°ìˆìœ¼ë©´ ëŒì§€ ì•ŠìŒ
  setCurrentExercise(ex.id);

  cardioExId=ex.id;
  cardioTitle.textContent = ex.name || "ìœ ì‚°ì†Œ";
  cardioSub.textContent = `${ex.part} Â· ${ex.name}`;

  const c=ex.cardio||{mode:"ì•¼ì™¸",distanceKm:0,minutes:0,seconds:0};
  distStr = c.distanceKm ? String(c.distanceKm) : "";
  minStr  = c.minutes ? String(c.minutes) : "";
  secStr  = c.seconds ? String(c.seconds) : "";

  function applyMode(m){
    ex.cardio = ex.cardio || {};
    ex.cardio.mode = m;
    setPill(cardioOutdoor, m==="ì•¼ì™¸");
    setPill(cardioIndoor, m==="ì‹¤ë‚´");
    saveState();
  }
  cardioOutdoor.onclick = ()=>applyMode("ì•¼ì™¸");
  cardioIndoor.onclick = ()=>applyMode("ì‹¤ë‚´");
  applyMode(c.mode||"ì•¼ì™¸");

  cardioFocus="dist";
  updateCardioUI();

  overlayCardio.classList.add('show');
  overlayCardio.setAttribute('aria-hidden','false');
}
function closeCardioFn(){
  overlayCardio.classList.remove('show');
  overlayCardio.setAttribute('aria-hidden','true');
  cardioExId=null;
}
closeCardio.addEventListener('click', closeCardioFn);
overlayCardio.addEventListener('click', e=>{ if(e.target===overlayCardio) closeCardioFn(); });

cardioFocusDist.addEventListener('click', ()=>{cardioFocus="dist"; updateCardioUI();});
cardioFocusTime.addEventListener('click', ()=>{cardioFocus="time"; updateCardioUI();});

qsa('#cardioKbd .key[data-c]').forEach(k=>k.addEventListener('click', ()=>{
  const ch=k.dataset.c;
  if(cardioFocus==="dist"){
    if(distStr.length>=6) return;
    distStr += ch;
  }else{
    // time ì…ë ¥: mmss ëˆ„ì 
    const mm = (minStr||"").replace(/\D/g,"");
    const ss = (secStr||"").replace(/\D/g,"").padStart(2,"0");
    const combined = (mm+ss+ch).replace(/^0+/,"").slice(-4).padStart(4,"0");
    const mins = parseInt(combined.slice(0,2),10)||0;
    const secs = parseInt(combined.slice(2,4),10)||0;
    minStr = String(mins);
    secStr = String(secs);
  }
  updateCardioUI();
}));
cardioDot.addEventListener('click', ()=>{
  if(cardioFocus!=="dist") return;
  if(distStr.includes(".")) return;
  distStr = distStr==="" ? "0." : (distStr + ".");
  updateCardioUI();
});
cardioBack.addEventListener('click', ()=>{
  if(cardioFocus==="dist"){
    distStr = distStr.slice(0,-1);
  }else{
    const mm=(minStr||"").padStart(2,"0");
    const ss=(secStr||"").padStart(2,"0");
    const combined=(mm+ss).slice(0,-1).padStart(4,"0");
    minStr=String(parseInt(combined.slice(0,2),10)||0);
    secStr=String(parseInt(combined.slice(2,4),10)||0);
  }
  updateCardioUI();
});

saveCardio.addEventListener('click', ()=>{
  const ex=state.exercises.find(e=>e.id===cardioExId);
  if(!ex) return;
  const dist=parseFloat(distStr||"0")||0;
  const mins=parseInt(minStr||"0",10)||0;
  const secs=parseInt(secStr||"0",10)||0;
  ex.cardio = ex.cardio || {};
  ex.cardio.distanceKm=dist;
  ex.cardio.minutes=mins;
  ex.cardio.seconds=secs;
  const dur=mins*60+secs;
  ex.cardio.paceSecPerKm = (dist>0 && dur>0) ? Math.round(dur/dist) : null;
  saveState();
  closeCardioFn();
  renderExercises();
});

  // Summary screen (page)
  const sumDate=qs('#sumDate');
  const sumTotalVol2=qs('#sumTotalVol2');
  const sumTotalTime2=qs('#sumTotalTime2');
  const sumParts2=qs('#sumParts2');
  const sumPartTimes2=qs('#sumPartTimes2');
  const addMoreToday=qs('#addMoreToday');

  function computeSummary(){
    stopCurrentExerciseSegment();
    const byPartVol={}, byPartTime={};
    let total=0;
    let trainMs=0;
    state.exercises.forEach(e=>{
      const p=e.part||"-";
      const v=totalVolume(e);
      total += v;
      byPartVol[p]=(byPartVol[p]||0)+v;
      const ms=(e.activeMs||0);
      trainMs += ms;
      byPartTime[p]=(byPartTime[p]||0)+ms;
    });
    return {ds:todayStr(), total, totalTimeTxt:fmtHMS(totalMs()), byPartVol, byPartTime, trainMs};
  }

  function renderSummaryScreen(){
    const s=computeSummary();
    if(sumDate) sumDate.textContent = s.ds;
    if(sumTotalVol2) sumTotalVol2.textContent = Math.round(s.total).toLocaleString()+"kg";
    if(sumTotalTime2) sumTotalTime2.textContent = s.totalTimeTxt;

    if(sumParts2){
      const parts=Object.entries(s.byPartVol).sort((a,b)=>b[1]-a[1]);
      sumParts2.innerHTML = parts.length
        ? parts.map(([p,v])=>`<div class="sum-item"><div class="k">${p}</div><div class="v">${Math.round(v).toLocaleString()}kg</div></div>`).join("")
        : `<div class="muted" style="padding:8px 0">-</div>`;
    }
    if(sumPartTimes2){
      const partsT=Object.entries(s.byPartTime).sort((a,b)=>b[1]-a[1]);
      sumPartTimes2.innerHTML = partsT.length
        ? partsT.map(([p,ms])=>`<div class="sum-item"><div class="k">${p}</div><div class="v">${fmtHMS(ms)}</div></div>`).join("")
        : `<div class="muted" style="padding:8px 0">-</div>`;
    }
  }

  function closeAllOverlays(){
    [overlayPrompt, overlayStart, overlaySet, overlayCardio, overlayTop10].forEach(o=>{
      if(o && o.classList.contains('show')){
        o.classList.remove('show');
        o.setAttribute('aria-hidden','true');
      }
    });
  }

  endBtn.addEventListener('click',()=>{
    const pending = state.exercises.filter(ex=>!ex.isDone);
    let msg = "ì˜¤ëŠ˜ ìš´ë™ì„ ì¢…ë£Œí• ê¹Œ?";
    if(pending.length){
      const lines = pending.map(ex=>{
        const sets = Array.isArray(ex.sets) ? ex.sets : [];
        const doneSets = sets.filter(s=>typeof s.w==="number" && typeof s.r==="number" && s.w>0 && s.r>0).length;
        const label = `${ex.part||""}${ex.part?"-":""}${ex.name}`;
        return `${label} ${doneSets}ì„¸íŠ¸(ë³¼ë¥¨ì…ë ¥ëœì„¸íŠ¸)ê¹Œì§€ë§Œ ì§„í–‰ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
      });
      msg = lines.join("\n") + "\n\nì¢…ëª©ì„ ì™„ë£Œí•˜ê³  ìš´ë™ì„ ì¢…ë£Œí• ê¹Œìš”?";
    }
    if(!confirm(msg)) return;

    closeAllOverlays();
    endWorkout();

    // ìº˜ë¦°ë”ìš© ê¸°ë¡(ë¶€ìœ„)
    const touched=getTouchedParts();
    if(touched.length) logPartsForToday(touched);

    renderSummaryScreen();
    showScreen('summary');
    syncHeaderVisibility();
  });

  if(addMoreToday){
    addMoreToday.addEventListener('click',()=>{
      state.selectedPart=null;
      saveState();
      showScreen('today');
      showPartPicker();
      renderCalendar();
      syncHeaderVisibility();
    });
  }


  // Periodic UI refresh
  setInterval(()=>{
    renderClock();
    updateExerciseTimeBadges();
    // save occasionally
    if((now()%3000)<80) saveState();
  }, 250);

  // Boot
  if(state.selectedPart) showWork(state.selectedPart, false);
  else showPartPicker();
  renderTicker();
  renderExercises();
  renderClock();
  renderCalendar();
  syncHeaderVisibility();
</script>

<div class="bottom-nav" id="bottomNav">
  <div class="wrap">
    <div class="navbtn active" data-screen="today"><div class="dot"></div><div>ì˜¤ëŠ˜</div></div>
    <div class="navbtn" data-screen="rank"><div class="dot"></div><div>ë­í‚¹</div></div>
    <div class="navbtn" data-screen="more"><div class="dot"></div><div>ë”ë³´ê¸°</div></div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', ()=>{

  // ---------- Error banner ----------
  const eb = document.getElementById('errBanner');
  function showErr(msg){
    if(!eb) return;
    eb.style.display = 'block';
    eb.textContent = 'JS ì˜¤ë¥˜: ' + msg;
  }
  window.addEventListener('error', (e)=>{ showErr(e.message || 'unknown'); });
  window.addEventListener('unhandledrejection', (e)=>{ 
    const r = e.reason;
    showErr((r && r.message) ? r.message : String(r));
  });

  // ---------- Screen routing ----------
  const bottomNav = document.getElementById('bottomNav');

  window.showScreen = function(name){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById('screen-'+name);
    if(el) el.classList.add('active');

    document.querySelectorAll('.navbtn').forEach(b=>b.classList.toggle('active', b.dataset.screen===name));

    // auth í™”ë©´ì—ì„œëŠ” ë„¤ë¹„ ìˆ¨ê¹€
    if(bottomNav) bottomNav.style.display = (name === 'auth') ? 'none' : '';

    // í•„ìš”í•œ í™”ë©´ë§Œ ìƒˆë¡œ ê·¸ë¦¼
    if(name === 'today' && typeof window.renderCalendar === 'function') window.renderCalendar();
    if(typeof window.syncHeaderVisibility === 'function') window.syncHeaderVisibility();
  };

  // nav buttons
  document.querySelectorAll('.navbtn').forEach(b=>{
    b.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      window.showScreen(b.dataset.screen);
    }, {passive:false});
  });

  // ---------- Supabase Auth (Step1) ----------
  const SUPABASE_URL = "https://plwtafeydntllgqmufhc.supabase.co";
  const SUPABASE_KEY = "sb_publishable_Famg4_KKiWfrVznxdsZ0-g_M59PKT4k";
  const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;
  window.sb = sb;

  const authCard = document.getElementById('authCard');
  const profileCard = document.getElementById('profileCard');

  const authId = document.getElementById('authId');
  const authPw = document.getElementById('authPw');
  const authMsg = document.getElementById('authMsg');
  const btnLogin = document.getElementById('btnLogin');
  const btnSignup = document.getElementById('btnSignup');

  const profNick = document.getElementById('profNick');
  const profWeight = document.getElementById('profWeight');
  const profHeight = document.getElementById('profHeight');
  const profRegion = document.getElementById('profRegion');
  const btnRegionAuto = document.getElementById('btnRegionAuto');
  const profMsg = document.getElementById('profMsg');
  const btnSaveProfile = document.getElementById('btnSaveProfile');
  const profSexWrap = document.getElementById('profSex');

  let chosenSex = null;

  function setAuthMsg(t){ if(authMsg) authMsg.textContent = t || ""; }
  function setProfMsg(t){ if(profMsg) profMsg.textContent = t || ""; }

  function toEmail(loginId){
    const id = (loginId||"").trim().toLowerCase().replace(/\s+/g,'');
    return id.includes('@') ? id : (id + "@id.local");
  }

  function calcWeightClass(kg){
    const n = Number(kg);
    if(!isFinite(n) || n<=0) return null;
    const base = Math.floor(n/5)*5;
    const hi = base + 4.9;
    return `${base}-${hi.toFixed(1)}kg`;
  }

  function showProfileStep(show){
    if(profileCard) profileCard.style.display = show ? '' : 'none';
    if(authCard) authCard.style.display = show ? 'none' : '';
  }

  async function getSession(){
    if(!sb) return null;
    const { data } = await sb.auth.getSession();
    return data.session || null;
  }

  async function getUser(){
    if(!sb) return null;
    const { data } = await sb.auth.getUser();
    return data.user || null;
  }

  async function loadMyProfile(userId){
    if(!sb) return null;
    const { data, error } = await sb
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .maybeSingle();
    if(error) throw error;
    return data; // null ê°€ëŠ¥
  }

  async function upsertMyProfile(user, loginId){
    const nick = (profNick?.value||"").trim();
    const weight = Number((profWeight?.value||"").trim());
    const height = Number((profHeight?.value||"").trim());
    const region = (profRegion?.value||"").trim();

    if(!nick){ setProfMsg("ë‹‰ë„¤ì„ì€ í•„ìˆ˜ì•¼."); return false; }
    if(!chosenSex){ setProfMsg("ì„±ë³„ ì„ íƒí•´ì¤˜."); return false; }
    if(!isFinite(weight) || weight<=0){ setProfMsg("ëª¸ë¬´ê²Œ(kg) ìˆ«ìë¡œ ì ì–´ì¤˜."); return false; }

    const payload = {
      id: user.id,
      nick,
      sex: chosenSex,
      height_cm: isFinite(height)&&height>0 ? Math.round(height) : null,
      bodyweight_kg: weight,
      weight_class: calcWeightClass(weight),
      region: region || null
    };

    const { error } = await sb.from('profiles').upsert(payload, { onConflict: 'id' });
    if(error) throw error;
    return true;
  }

  // ì„±ë³„ ì¹© (ì‹œê°ì ìœ¼ë¡œë„ ì„ íƒ í‘œì‹œ)
  if(profSexWrap){
    profSexWrap.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        profSexWrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        chosenSex = ch.dataset.sex || null;
        setProfMsg("");
      });
    });
  }

  function normalizeCityName(s){
    if(!s) return "";
    let x = String(s).trim();
    // ê³µë°±ì´ ì„ì—¬ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ í† í°ì„ ìš°ì„ (ì˜ˆ: "ê²½ê¸°ë„ ìˆ˜ì›ì‹œ" -> "ìˆ˜ì›ì‹œ")
    const parts = x.split(/\s+/);
    x = parts[parts.length-1] || x;

    // "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ" ê°™ì€ ì ‘ë¯¸ ì œê±°
    x = x.replace(/(íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ìì¹˜ì‹œ|ì‹œ|êµ°|êµ¬)$/,'');
    return x.trim();
  }

  async function fillRegionFromLocation(){
    if(!profRegion){ setProfMsg("ì§€ì—­ ì…ë ¥ì¹¸ì´ ì—†ì–´."); return; }
    if(!navigator.geolocation){ setProfMsg("ì´ ê¸°ê¸°ì—ì„œ ìœ„ì¹˜ë¥¼ ëª» ì¨."); return; }

    setProfMsg("ìœ„ì¹˜ í—ˆìš©í•˜ë©´ ì§€ì—­ ìë™ìœ¼ë¡œ ë„£ì–´ì¤„ê²Œ.");
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      try{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        setProfMsg("ì§€ì—­ ì°¾ëŠ” ì¤‘...");
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=ko`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if(!res.ok) throw new Error("ìœ„ì¹˜ ë³€í™˜ ì‹¤íŒ¨");
        const j = await res.json();
        const addr = j.address || {};
        const raw = addr.city || addr.town || addr.municipality || addr.county || addr.state || "";
        const city = normalizeCityName(raw);

        if(city){
          profRegion.value = city;
          setProfMsg(`ì§€ì—­ ìë™ì…ë ¥: ${city}`);
        }else{
          setProfMsg("ì§€ì—­ì„ ëª» ì°¾ê² ì–´. ì§ì ‘ ì ì–´ì¤˜.");
        }
      }catch(err){
        setProfMsg(err?.message || String(err));
      }
    }, (err)=>{
      setProfMsg("ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•´. (í—ˆìš© ëˆŒëŸ¬ì¤˜)");
    }, { enableHighAccuracy:false, timeout:8000, maximumAge:600000 });
  }

  if(btnRegionAuto){
    btnRegionAuto.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      fillRegionFromLocation();
    });
  }

  async function routeByAuth(){
    // ê¸°ë³¸: ë¡œê·¸ì¸ í™”ë©´
    window.showScreen('auth');
    if(!sb){
      setAuthMsg("Supabase ë¡œë”© ì‹¤íŒ¨(ìŠ¤í¬ë¦½íŠ¸ í™•ì¸).");
      showProfileStep(false);
      return;
    }

    const sess = await getSession();
    if(!sess){
      showProfileStep(false);
      setAuthMsg("");
      return;
    }

    try{
      const user = await getUser();
      const prof = await loadMyProfile(user.id);

      if(!prof){
        showProfileStep(true);
        setAuthMsg("");
        // í”„ë¡œí•„ í™”ë©´ì—ì„œë§Œ 'ìœ„ì¹˜ ìë™ì…ë ¥' ëˆ„ë¥´ê²Œ
        return;
      }

      showProfileStep(false);
      window.showScreen('today');
    }catch(err){
      // profiles í…Œì´ë¸”/RLS ë¯¸ì„¤ì •
      showProfileStep(false);
      setAuthMsg("profiles í…Œì´ë¸”/RLSê°€ ì•„ì§ì´ì•¼. (SQL ë¨¼ì € ì‹¤í–‰í•´ì¤˜)");
      window.showScreen('today');
    }
  }

  if(btnLogin){
    btnLogin.addEventListener('click', async ()=>{
      try{
        setAuthMsg("");
        const id = (authId?.value||"").trim();
        const pw = (authPw?.value||"");
        if(!id || !pw){ setAuthMsg("ì•„ì´ë””/ë¹„ë²ˆ ë‘˜ ë‹¤ ì ì–´."); return; }

        const { error } = await sb.auth.signInWithPassword({ email: toEmail(id), password: pw });
        if(error) throw error;

        setAuthMsg("ë¡œê·¸ì¸ ëë‹¤.");
        await routeByAuth();
      }catch(err){
        setAuthMsg(err?.message || String(err));
      }
    });
  }

  if(btnSignup){
    btnSignup.addEventListener('click', async ()=>{
      try{
        setAuthMsg("");
        const id = (authId?.value||"").trim();
        const pw = (authPw?.value||"");
        if(!id || !pw){ setAuthMsg("ì•„ì´ë””/ë¹„ë²ˆ ë‘˜ ë‹¤ ì ì–´."); return; }
        if(pw.length < 6){ setAuthMsg("ë¹„ë²ˆ 6ì ì´ìƒìœ¼ë¡œ í•´ì¤˜."); return; }

        const { data, error } = await sb.auth.signUp({ email: toEmail(id), password: pw });
        if(error) throw error;

        if(!data.session){
          setAuthMsg("íšŒì›ê°€ì…ì€ ëëŠ”ë°, ë©”ì¼í™•ì¸ ì„¤ì • ë•Œë¬¸ì— ë¡œê·¸ì¸ ì•ˆ ë  ìˆ˜ ìˆì–´. (Confirm email OFF ì¶”ì²œ)");
          return;
        }

        setAuthMsg("íšŒì›ê°€ì… ì™„ë£Œ.");
        await routeByAuth();
      }catch(err){
        setAuthMsg(err?.message || String(err));
      }
    });
  }

  if(btnSaveProfile){
    btnSaveProfile.addEventListener('click', async ()=>{
      try{
        setProfMsg("");
        const user = await getUser();
        if(!user){ setProfMsg("ë¡œê·¸ì¸ë¶€í„° í•´ì•¼ ë¼."); return; }

        const loginId = (authId?.value||"").trim();
        const ok = await upsertMyProfile(user, loginId);
        if(!ok) return;

        setProfMsg("ì €ì¥ ì™„ë£Œ.");
        showProfileStep(false);
        window.showScreen('today');
      }catch(err){
        setProfMsg(err?.message || String(err));
      }
    });
  }

  if(sb){
    sb.auth.onAuthStateChange(()=>{ routeByAuth(); });
  }

  routeByAuth();
});
</script>
</body>
</html>
