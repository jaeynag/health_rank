<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Health Rank - Today (Step2.3)</title>
<style>
  :root{
    --bg:#0f1115; --card:#141826; --card2:#1b1f2a; --line:#2a3040;
    --txt:#eaeaf0; --mut:#8e93b5; --accent:#4c5cff; --accent2:#cfd3ff;
    --danger:#ff4c6a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--txt)}
  .page{max-width:480px;margin:0 auto;padding:12px 12px 24px}
  .header{position:sticky;top:0;background:var(--bg);padding:6px 0;border-bottom:1px solid #1f2430;z-index:20}

  /* Ticker */
  .ticker-wrap{overflow:hidden;white-space:nowrap;border-radius:10px}
  .ticker-touch{cursor:pointer}
  .ticker{display:inline-block;padding-left:100%;animation: marquee 18s linear infinite;will-change:transform}
  .ticker span{display:inline-block;margin-right:24px;color:var(--accent2);animation:pulse 1.6s ease-in-out infinite}
  .paused .ticker{animation-play-state:paused}
  .paused .ticker span{animation-play-state:paused}
  @keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  @keyframes pulse{0%,100%{opacity:.85;text-shadow:none}50%{opacity:1;text-shadow:0 0 6px rgba(120,140,255,.6)}}

  /* UI */
  .section{margin:12px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .row.between{justify-content:space-between}
  .muted{color:var(--mut);font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .btn{background:var(--card2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px;text-align:center;user-select:none}
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.ghost{background:var(--card);border-color:var(--line)}
  .btn.small{padding:8px 10px;border-radius:12px}
  .btn.danger{background:rgba(255,76,106,.14);border-color:rgba(255,76,106,.40);color:#ffd0d8}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);user-select:none}
  .pill.tap{cursor:pointer}
  .divider{height:1px;background:var(--line);margin:10px 0;opacity:.8}

  /* Exercise */
  .ex-title{font-weight:800}
  .timer{font-variant-numeric:tabular-nums;letter-spacing:.06em}
  .timer.paused{opacity:.85}
  .ex-card.completed .details{display:none}
  .ex-card.completed .collapse{display:block}
  .collapse{display:none}

  .sets{margin-top:10px;border-top:1px dashed var(--line);padding-top:8px}

  /* Swipe row */
  .swipe{
    position:relative;
    overflow:hidden;
    border-bottom:1px dashed rgba(42,48,64,.7);
    border-radius:12px;
    margin:6px 0;
    background:rgba(0,0,0,.0);
    touch-action: pan-y;
  }
  .swipe-actions{
    position:absolute;
    top:0; right:0; bottom:0;
    width:86px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    background:rgba(255,76,106,.12);
    border-left:1px solid rgba(255,76,106,.25);
  }
  .swipe-front{
    position:relative;
    transform:translateX(0px);
    transition:transform 140ms ease-out;
    will-change:transform;
    background:transparent;
    padding:8px 6px;
  }
  .swipe.open .swipe-front{
    transform:translateX(-86px);
  }
  .set-row{
    display:flex;justify-content:space-between;align-items:center;gap:8px;
  }
  .set-left{display:flex;gap:10px;align-items:center;min-width:0;flex:1}
  .set-no{color:var(--mut);width:52px;flex:0 0 auto}
  .set-val{font-variant-numeric:tabular-nums;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .set-vol{color:var(--mut);font-size:12px;flex:0 0 auto}
  .ghosttext{color:rgba(142,147,181,.85)}

  .chipline{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:var(--card2);color:#fff;user-select:none;cursor:pointer;font-size:13px}

  /* Overlays */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:center;padding:12px;z-index:60}
  .overlay.show{display:flex}
  .drawer{width:min(480px,100%);margin-top:56px;background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
  .drawer-title{font-weight:900}
  .drawer-sub{color:var(--mut);font-size:12px;margin-top:2px}
  .drawer-body{max-height:82vh;overflow:auto;padding:12px}

  .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .key{padding:14px;border-radius:12px;background:var(--card2);border:1px solid var(--line);text-align:center;user-select:none}
  .key.disabled{opacity:.4;pointer-events:none}
  .big{font-size:28px;letter-spacing:.08em;font-variant-numeric:tabular-nums}
  .center{text-align:center}

  input[type="text"]{
    width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
    background:#0c0e13;color:var(--txt);outline:none;font-size:16px;
  }
</style>
</head>
<body>
<div class="page" id="app">
  <div class="header">
    <div class="ticker-wrap ticker-touch" id="tickerWrap" title="ëˆ„ë¥´ë©´ Top10">
      <div class="ticker">
        <span>í•˜ì²´ ğŸ¥‡ jaeyang 8,420kg</span>
        <span>í•˜ì²´ ğŸ¥ˆ userB 7,980kg</span>
        <span>í•˜ì²´ ğŸ¥‰ userC 7,450kg</span>
      </div>
    </div>
  </div>

  <div class="section card" id="partCard">
    <div class="row between">
      <div>
        <div class="muted">ì˜¤ëŠ˜ ìš´ë™</div>
        <div style="font-weight:900;margin-top:2px">ë¶€ìœ„ ì„ íƒ</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="grid" id="partGrid">
      <div class="btn" data-part="ê°€ìŠ´">ê°€ìŠ´</div>
      <div class="btn" data-part="ë“±">ë“±</div>
      <div class="btn" data-part="í•˜ì²´">í•˜ì²´</div>
      <div class="btn" data-part="ì–´ê¹¨">ì–´ê¹¨</div>
      <div class="btn" data-part="íŒ”">íŒ”</div>
      <div class="btn" data-part="ë³µê·¼">ë³µê·¼</div>
      <div class="btn primary" data-part="ìœ ì‚°ì†Œ">ìœ ì‚°ì†Œ</div>
    </div>
  </div>

  <div class="section card" id="workCard" style="display:none">
    <div class="row between">
      <div class="row" style="gap:10px">
        <div class="btn small ghost" id="backBtn" title="ë¶€ìœ„ ë‹¤ì‹œ ì„ íƒ">â†</div>
        <div>
          <div class="muted">ì„ íƒ ë¶€ìœ„</div>
          <div style="font-weight:900" id="selectedPart">-</div>
        </div>
      </div>
      <div class="muted" id="todaySmall"></div>
    </div>

    <div id="exerciseList" style="margin-top:10px"></div>

    <div class="divider"></div>
    <div class="row">
      <div class="btn ghost" style="flex:0.38" id="addPartBtn">ë¶€ìœ„ ì¶”ê°€</div>
      <div class="btn ghost" style="flex:0.62" id="addExerciseBtn">ì¢…ëª© ì¶”ê°€</div>
    </div>
  </div>

  <div class="section">
    <div class="btn" id="endBtn">ìš´ë™ ì¢…ë£Œ</div>
  </div>
</div>

<!-- Top10 overlay -->
<div class="overlay" id="overlayTop10" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="Top10">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="top10Title">Top 10 Â· í•˜ì²´(ì˜¤ëŠ˜)</div>
        <div class="drawer-sub">ê°™ì€ ì²´ê¸‰ Â· ì„±ë³„ Â· ë¶€ìœ„ ê¸°ì¤€</div>
      </div>
      <div class="btn ghost small" id="closeTop10">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body" id="top10Body" style="padding:0"></div>
  </div>
</div>

<!-- Add exercise overlay -->
<div class="overlay" id="overlayPrompt" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ì¢…ëª© ì¶”ê°€">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">ì¢…ëª© ì¶”ê°€</div>
        <div class="drawer-sub" id="promptSub">-</div>
      </div>
      <div class="btn ghost small" id="closePrompt">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <input type="text" id="exerciseName" placeholder="ì˜ˆ) ìŠ¤ì¿¼íŠ¸"/>
      <div class="chipline" id="exerciseChips"></div>
      <div class="row" style="margin-top:12px">
        <div class="btn primary" style="flex:1" id="confirmAdd">ì¶”ê°€</div>
      </div>
    </div>
  </div>
</div>

<!-- Start overlay -->
<div class="overlay" id="overlayStart" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ìš´ë™ ì‹œì‘ ì•ˆë‚´">
    <div class="drawer-head">
      <div>
        <div class="drawer-title">ë°”ë¡œ ìš´ë™ ì‹œì‘</div>
        <div class="drawer-sub" id="startSub">-</div>
      </div>
      <div class="btn ghost small" id="closeStart">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <div class="card" style="padding:12px">
        <div style="font-weight:900" id="startCount">10ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</div>
        <div class="muted" style="margin-top:8px">ë°”ë¡œ ìš´ë™ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
        <div class="muted" style="margin-top:6px">- ë¬´ê²Œ ë° ë©ìŠ¤ëŠ” ì§„í–‰ ì™„ë£Œ í›„ ì…ë ¥ -</div>
      </div>
    </div>
  </div>
</div>

<!-- Set entry overlay -->
<div class="overlay" id="overlaySet" aria-hidden="true">
  <div class="drawer" role="dialog" aria-modal="true" aria-label="ì„¸íŠ¸ ì…ë ¥">
    <div class="drawer-head">
      <div>
        <div class="drawer-title" id="setTitle">1ì„¸íŠ¸ ì…ë ¥</div>
        <div class="drawer-sub" id="setSub">-</div>
      </div>
      <div class="btn ghost small" id="closeSet">ë‹«ê¸°</div>
    </div>
    <div class="drawer-body">
      <div class="center">
        <div class="muted">ë¬´ê²Œ</div>
        <div class="big"><span id="setWeightVal">0.0</span> <span class="pill">KG</span></div>
      </div>
      <div class="row" style="justify-content:center;margin:10px 0">
        <div class="pill tap" id="incBtn">ì¦</div>
        <div class="pill tap" id="decBtn">ê°</div>
      </div>
      <div class="kbd">
        <div class="key" id="barKey">BAR</div>
        <div class="key" data-d="0.25">0.25</div>
        <div class="key" data-d="0.5">0.5</div>
        <div class="key" data-d="1">1</div>
        <div class="key" data-d="2.5">2.5</div>
        <div class="key" data-d="5">5</div>
        <div class="key" data-d="10">10</div>
        <div class="key" data-d="20">20</div>
        <div class="key" id="backKey">â†</div>
      </div>

      <div class="divider"></div>

      <div class="center">
        <div class="muted">íšŸìˆ˜</div>
        <div class="big"><span id="setRepsVal">0</span> reps</div>
      </div>
      <div class="kbd" style="margin-top:10px">
        <div class="key" data-n="1">1</div><div class="key" data-n="2">2</div><div class="key" data-n="3">3</div>
        <div class="key" data-n="4">4</div><div class="key" data-n="5">5</div><div class="key" data-n="6">6</div>
        <div class="key" data-n="7">7</div><div class="key" data-n="8">8</div><div class="key" data-n="9">9</div>
        <div class="key" id="repsClear">C</div><div class="key" data-n="0">0</div><div class="key" id="repsBack">â†</div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="btn primary" style="flex:1;padding:16px" id="saveSetBtn">ì…ë ¥</div>
      </div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY="health_rank_today_v5";
  const qs=(s,el=document)=>el.querySelector(s);
  const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
  const pad=n=>String(n).padStart(2,'0');
  const safeParse=s=>{try{return JSON.parse(s)}catch{return null}};
  const fmtHMS=ms=>{
    ms=Math.max(0,ms);
    const s=Math.floor(ms/1000);
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
    return `${pad(h)}:${pad(m)}:${pad(ss)}`;
  };
  const fmtKg=x=>{
    const v=(+x||0);
    return v.toFixed(2).replace(/\.00$/,".0");
  };

  const state={ selectedPart:null, exercises:[], weightMode:"inc" };

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      selectedPart:state.selectedPart,
      exercises:state.exercises,
      weightMode:state.weightMode
    }));
  }
  function loadState(){
    const snap=safeParse(localStorage.getItem(STORAGE_KEY));
    if(!snap) return;
    if(typeof snap.selectedPart==="string") state.selectedPart=snap.selectedPart;
    if(Array.isArray(snap.exercises)) state.exercises=snap.exercises;
    if(snap.weightMode==="inc"||snap.weightMode==="dec") state.weightMode=snap.weightMode;
  }
  loadState();

  // Top10
  const app=qs('#app');
  const tickerWrap=qs('#tickerWrap');
  const overlayTop10=qs('#overlayTop10');
  const closeTop10=qs('#closeTop10');
  const top10Body=qs('#top10Body');
  const top10Title=qs('#top10Title');
  const sampleTop10=Array.from({length:10},(_,i)=>({rank:i+1,name:`user${String.fromCharCode(65+i)}`,vol:(8420-i*240).toLocaleString()+"kg"}));
  function renderTop10(){
    top10Body.innerHTML="";
    sampleTop10.forEach(r=>{
      const row=document.createElement('div');
      row.className="set-row";
      row.style.padding="10px 12px";
      row.innerHTML=`<div class="set-left"><div class="set-no">${r.rank}</div><div class="set-val">${r.name}</div></div><div class="set-vol">${r.vol}</div>`;
      top10Body.appendChild(row);
    });
  }
  function openTop10(){
    top10Title.textContent=`Top 10 Â· ${(state.selectedPart||"í•˜ì²´")}(ì˜¤ëŠ˜)`;
    renderTop10();
    overlayTop10.classList.add('show'); overlayTop10.setAttribute('aria-hidden','false');
  }
  function closeTop10Fn(){
    overlayTop10.classList.remove('show'); overlayTop10.setAttribute('aria-hidden','true');
  }
  tickerWrap.addEventListener('click',openTop10);
  closeTop10.addEventListener('click',closeTop10Fn);
  overlayTop10.addEventListener('click',e=>{if(e.target===overlayTop10) closeTop10Fn();});

  // Navigation
  const partCard=qs('#partCard'), workCard=qs('#workCard');
  const selectedPartEl=qs('#selectedPart'), todaySmall=qs('#todaySmall'), exerciseList=qs('#exerciseList');
  const backBtn=qs('#backBtn'), addPartBtn=qs('#addPartBtn'), addExerciseBtn=qs('#addExerciseBtn'), endBtn=qs('#endBtn');

  function showPartPicker(){
    state.selectedPart=null; saveState();
    partCard.style.display=""; workCard.style.display="none";
  }
  function showWork(part){
    state.selectedPart=part; saveState();
    selectedPartEl.textContent=part;
    todaySmall.textContent=new Date().toISOString().slice(0,10);
    partCard.style.display="none"; workCard.style.display="";
    renderExercises();
  }
  qsa('#partGrid .btn').forEach(b=>b.addEventListener('click',()=>showWork(b.dataset.part)));
  backBtn.addEventListener('click',showPartPicker);
  addPartBtn.addEventListener('click',showPartPicker);

  // Examples + last record seed
  const EXAMPLES={
    "ê°€ìŠ´":["ë²¤ì¹˜í”„ë ˆìŠ¤","ì¸í´ë¼ì¸ ë²¤ì¹˜í”„ë ˆìŠ¤","ì²´ìŠ¤íŠ¸í”„ë ˆìŠ¤","ë”¥ìŠ¤","í‘¸ì‰¬ì—…"],
    "ë“±":["ë«í’€ë‹¤ìš´","ì‹œí‹°ë“œë¡œìš°","ë°”ë²¨ë¡œìš°","í’€ì—…","í˜ì´ìŠ¤í’€"],
    "í•˜ì²´":["ìŠ¤ì¿¼íŠ¸","ë ˆê·¸í”„ë ˆìŠ¤","ëŸ°ì§€","í™ì“°ëŸ¬ìŠ¤íŠ¸","ë ˆê·¸ìµìŠ¤í…ì…˜","ë ˆê·¸ì»¬","ì¹´í”„ë ˆì´ì¦ˆ"],
    "ì–´ê¹¨":["ì˜¤ë²„í—¤ë“œí”„ë ˆìŠ¤","ì‚¬ì´ë“œë ˆí„°ëŸ´ë ˆì´ì¦ˆ","ìˆ„ë”í”„ë ˆìŠ¤","ë¦¬ì–´ë¸íŠ¸í”Œë¼ì´"],
    "íŒ”":["ë°”ë²¨ì»¬","ë¤ë²¨ì»¬","í•´ë¨¸ì»¬","í‘¸ì‹œë‹¤ìš´","ìŠ¤ì»¬í¬ëŸ¬ì…”"],
    "ë³µê·¼":["í¬ëŸ°ì¹˜","í–‰ì‰ ë ˆê·¸ë ˆì´ì¦ˆ","í”Œë­í¬","ì¼€ì´ë¸” í¬ëŸ°ì¹˜"],
    "ìœ ì‚°ì†Œ":["ëŸ¬ë‹","ì‚¬ì´í´","ê³„ë‹¨"]
  };
  function seedLastRecord(ex){
    if(ex.lastRecord) return;
    const d=new Date(Date.now()-86400000);
    const ds=d.toISOString().slice(0,10);
    const base={"ìŠ¤ì¿¼íŠ¸":{w:60,r:8},"ë ˆê·¸í”„ë ˆìŠ¤":{w:120,r:10},"ë²¤ì¹˜í”„ë ˆìŠ¤":{w:40,r:10},"ë«í’€ë‹¤ìš´":{w:50,r:10},"ì˜¤ë²„í—¤ë“œí”„ë ˆìŠ¤":{w:25,r:8}};
    const b=base[ex.name]||{w:20,r:10};
    ex.lastRecord={date:ds,w:b.w,r:b.r};
  }

  // Add exercise overlay
  const overlayPrompt=qs('#overlayPrompt'), closePrompt=qs('#closePrompt'), promptSub=qs('#promptSub');
  const exerciseName=qs('#exerciseName'), confirmAdd=qs('#confirmAdd'), exerciseChips=qs('#exerciseChips');
  function openPrompt(){
    if(!state.selectedPart) return;
    promptSub.textContent=`ì„ íƒ ë¶€ìœ„: ${state.selectedPart}`;
    exerciseName.value="";
    exerciseChips.innerHTML="";
    (EXAMPLES[state.selectedPart]||[]).forEach(n=>{
      const c=document.createElement('div');
      c.className="chip"; c.textContent=n;
      c.addEventListener('click',()=>{exerciseName.value=n; exerciseName.focus();});
      exerciseChips.appendChild(c);
    });
    overlayPrompt.classList.add('show'); overlayPrompt.setAttribute('aria-hidden','false');
    setTimeout(()=>exerciseName.focus(),50);
  }
  function closePromptFn(){ overlayPrompt.classList.remove('show'); overlayPrompt.setAttribute('aria-hidden','true'); }
  addExerciseBtn.addEventListener('click',openPrompt);
  closePrompt.addEventListener('click',closePromptFn);
  overlayPrompt.addEventListener('click',e=>{if(e.target===overlayPrompt) closePromptFn();});

  // Start overlay
  const overlayStart=qs('#overlayStart'), closeStart=qs('#closeStart'), startSub=qs('#startSub'), startCount=qs('#startCount');
  let startTimer=null;
  function openStart(ex){
    startSub.textContent=`${ex.part} Â· ${ex.name}`;
    overlayStart.classList.add('show'); overlayStart.setAttribute('aria-hidden','false');
    let left=10;
    startCount.textContent=`${left}ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.`;
    if(startTimer) clearInterval(startTimer);
    startTimer=setInterval(()=>{
      left-=1;
      if(left<=0) closeStartFn();
      else startCount.textContent=`${left}ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.`;
    },1000);
  }
  function closeStartFn(){
    if(startTimer){clearInterval(startTimer); startTimer=null;}
    overlayStart.classList.remove('show'); overlayStart.setAttribute('aria-hidden','true');
  }
  closeStart.addEventListener('click',closeStartFn);
  overlayStart.addEventListener('click',e=>{if(e.target===overlayStart) closeStartFn();});

  function addExercise(name){
    const id=crypto.randomUUID?crypto.randomUUID():String(Date.now())+Math.random();
    const ex={
      id, part:state.selectedPart, name,
      createdAt:Date.now(), paused:false, pauseAt:null, pausedMs:0,
      completed:false, activeMs:0,
      weightKg:0.0, barUsed:false, weightHist:[],
      sets:[], lastRecord:null
    };
    seedLastRecord(ex);
    state.exercises.push(ex);
    saveState();
    closePromptFn();
    renderExercises();
    openStart(ex);
  }
  confirmAdd.addEventListener('click',()=>{const n=(exerciseName.value||"").trim(); if(n) addExercise(n);});
  exerciseName.addEventListener('keydown',e=>{if(e.key==="Enter") confirmAdd.click();});

  // Timers + volume
  function getActiveMs(ex){
    if(ex.completed) return ex.activeMs;
    const now=Date.now();
    const pausedNow=ex.paused ? (now - ex.pauseAt) : 0;
    return (now - ex.createdAt) - ex.pausedMs - pausedNow;
  }
  const totalVolume=ex=>(ex.sets||[]).reduce((a,s)=>a+(s.w*s.r),0);

  // Set overlay
  const overlaySet=qs('#overlaySet'), closeSet=qs('#closeSet'), setTitle=qs('#setTitle'), setSub=qs('#setSub');
  const setWeightVal=qs('#setWeightVal'), setRepsVal=qs('#setRepsVal'), incBtn=qs('#incBtn'), decBtn=qs('#decBtn');
  const barKey=qs('#barKey'), backKey=qs('#backKey'), repsClear=qs('#repsClear'), repsBack=qs('#repsBack'), saveSetBtn=qs('#saveSetBtn');

  let currentExId=null, currentReps=0, targetSetIndex=1;
  let pressTimer=null, repsPress=null;

  function setMode(mode){
    state.weightMode=mode; saveState();
    incBtn.style.borderColor=(mode==="inc")?"var(--accent)":"var(--line)";
    decBtn.style.borderColor=(mode==="dec")?"var(--accent)":"var(--line)";
    incBtn.style.color=(mode==="inc")?"var(--accent2)":"var(--txt)";
    decBtn.style.color=(mode==="dec")?"var(--accent2)":"var(--txt)";
  }
  setMode(state.weightMode);
  incBtn.addEventListener('click',()=>setMode("inc"));
  decBtn.addEventListener('click',()=>setMode("dec"));

  function openSetEntry(ex){
    currentExId=ex.id;
    const nextNo=(ex.sets?.length||0)+1;
    targetSetIndex=nextNo;
    if(nextNo>=2){
      const last=ex.sets[ex.sets.length-1];
      if(last && typeof last.w==="number"){
        ex.weightKg=last.w; ex.weightHist=[]; ex.barUsed=false;
      }
    }
    setTitle.textContent=`${nextNo}ì„¸íŠ¸ ì…ë ¥`;
    setSub.textContent=`${ex.part} Â· ${ex.name}`;
    setWeightVal.textContent=fmtKg(ex.weightKg);
    currentReps=0; setRepsVal.textContent="0";
    barKey.classList.toggle('disabled',!!ex.barUsed);
    overlaySet.classList.add('show'); overlaySet.setAttribute('aria-hidden','false');
    saveState();
  }
  function closeSetFn(){
    overlaySet.classList.remove('show'); overlaySet.setAttribute('aria-hidden','true');
    currentExId=null; currentReps=0; targetSetIndex=1;
  }
  closeSet.addEventListener('click',closeSetFn);
  overlaySet.addEventListener('click',e=>{if(e.target===overlaySet) closeSetFn();});

  function applyDelta(ex, delta, meta={bar:false}){
    const signed=(state.weightMode==="inc")?delta:-delta;
    ex.weightKg=Math.max(0, +(ex.weightKg + signed).toFixed(2));
    ex.weightHist.push({delta:signed, bar:!!meta.bar});
    setWeightVal.textContent=fmtKg(ex.weightKg);
    saveState();
  }
  qsa('#overlaySet .key[data-d]').forEach(k=>k.addEventListener('click',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    applyDelta(ex, parseFloat(k.dataset.d));
  }));
  barKey.addEventListener('click',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex||ex.barUsed) return;
    applyDelta(ex,20,{bar:true}); ex.barUsed=true; barKey.classList.add('disabled'); saveState();
  });
  function undoLast(ex){
    const last=ex.weightHist.pop(); if(!last) return;
    ex.weightKg=Math.max(0, +(ex.weightKg - last.delta).toFixed(2));
    if(last.bar){ex.barUsed=false; barKey.classList.remove('disabled');}
    setWeightVal.textContent=fmtKg(ex.weightKg); saveState();
  }
  function clearAll(ex){
    ex.weightKg=0; ex.weightHist=[]; ex.barUsed=false;
    setWeightVal.textContent="0.0"; barKey.classList.remove('disabled'); saveState();
  }
  backKey.addEventListener('pointerdown',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    pressTimer=setTimeout(()=>clearAll(ex),650);
  });
  backKey.addEventListener('pointerup',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    if(pressTimer){clearTimeout(pressTimer); pressTimer=null; undoLast(ex);}
  });
  backKey.addEventListener('pointerleave',()=>{if(pressTimer){clearTimeout(pressTimer); pressTimer=null;}});

  function setRepsFromDigit(d){
    const s=(String(currentReps)==="0")?"":String(currentReps);
    const next=(s+String(d)).slice(0,3);
    currentReps=next===""?0:parseInt(next,10);
    setRepsVal.textContent=String(currentReps);
  }
  qsa('#overlaySet .key[data-n]').forEach(k=>k.addEventListener('click',()=>setRepsFromDigit(k.dataset.n)));
  repsClear.addEventListener('click',()=>{currentReps=0; setRepsVal.textContent="0";});
  function repsUndo(){
    const s=String(currentReps);
    if(s.length<=1){currentReps=0; setRepsVal.textContent="0"; return;}
    currentReps=parseInt(s.slice(0,-1),10);
    setRepsVal.textContent=String(currentReps);
  }
  function repsClearAll(){currentReps=0; setRepsVal.textContent="0";}
  repsBack.addEventListener('pointerdown',()=>{repsPress=setTimeout(()=>repsClearAll(),650);});
  repsBack.addEventListener('pointerup',()=>{if(repsPress){clearTimeout(repsPress); repsPress=null; repsUndo();}});
  repsBack.addEventListener('pointerleave',()=>{if(repsPress){clearTimeout(repsPress); repsPress=null;}});

  function saveOneSet(ex){
    if(currentReps<=0) return false;
    const w=+ex.weightKg||0;
    ex.sets.push({w,r:currentReps,ts:Date.now()});
    const ds=new Date().toISOString().slice(0,10);
    ex.lastRecord={date:ds,w,r:currentReps};
    saveState();
    return true;
  }
  saveSetBtn.addEventListener('click',()=>{
    const ex=state.exercises.find(e=>e.id===currentExId); if(!ex) return;
    if(!saveOneSet(ex)) return;
    closeSetFn();
    renderExercises();
  });

  // Delete set
  function deleteSet(ex, idx){
    if(idx<0||idx>=ex.sets.length) return;
    ex.sets.splice(idx,1);
    saveState();
    renderExercises();
  }

  // Swipe handling
  const SWIPE_OPEN_X = -86;
  function closeAllSwipes(root){
    qsa('.swipe.open', root||document).forEach(el=>el.classList.remove('open'));
  }
  function attachSwipeHandlers(container){
    const swipes = qsa('.swipe', container);
    swipes.forEach(el=>{
      let startX=0, startY=0, dragging=false, moved=false, openAtStart=false;
      const front = qs('.swipe-front', el);
      if(!front) return;

      el.addEventListener('pointerdown', (e)=>{
        if(e.pointerType === "mouse" && e.button !== 0) return;
        startX = e.clientX; startY = e.clientY;
        dragging = true; moved=false;
        openAtStart = el.classList.contains('open');
        el.setPointerCapture(e.pointerId);
      });

      el.addEventListener('pointermove', (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        // if vertical scroll dominates, abort swipe
        if(!moved && Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 8){
          dragging=false;
          front.style.transition="transform 140ms ease-out";
          front.style.transform = openAtStart ? `translateX(${SWIPE_OPEN_X}px)` : "translateX(0px)";
          return;
        }

        if(Math.abs(dx) > 6) moved=true;

        // Only left swipe
        let x = dx;
        if(x > 0) x = 0;
        if(x < SWIPE_OPEN_X) x = SWIPE_OPEN_X;
        front.style.transition="none";
        front.style.transform = `translateX(${x}px)`;
        e.preventDefault();
      }, {passive:false});

      el.addEventListener('pointerup', (e)=>{
        if(!dragging) return;
        dragging=false;
        front.style.transition="transform 140ms ease-out";
        const m = /translateX\((-?\d+(?:\.\d+)?)px\)/.exec(front.style.transform||"");
        const cur = m ? parseFloat(m[1]) : (el.classList.contains('open')?SWIPE_OPEN_X:0);
        const shouldOpen = cur < (SWIPE_OPEN_X/2); // more than half open
        if(shouldOpen){
          closeAllSwipes(container); // only one open at a time
          el.classList.add('open');
          front.style.transform = `translateX(${SWIPE_OPEN_X}px)`;
        }else{
          el.classList.remove('open');
          front.style.transform = "translateX(0px)";
        }
      });

      el.addEventListener('pointercancel', ()=>{
        dragging=false;
        front.style.transition="transform 140ms ease-out";
        front.style.transform = el.classList.contains('open')?`translateX(${SWIPE_OPEN_X}px)`:"translateX(0px)";
      });

      // Tap outside to close others
      el.addEventListener('click', (e)=>{
        const delBtn = e.target.closest('[data-action="del"]');
        if(delBtn) return;
        const setBtn = e.target.closest('[data-action="set"]');
        if(setBtn) return;
        // if open and user taps row, close it
        if(el.classList.contains('open')){
          el.classList.remove('open');
          front.style.transition="transform 140ms ease-out";
          front.style.transform="translateX(0px)";
          e.stopPropagation();
        }else{
          closeAllSwipes(container);
        }
      }, true);
    });

    // close swipes when scrolling / touching elsewhere
    container.addEventListener('touchstart', (e)=>{
      const inside = e.target.closest('.swipe');
      if(!inside) closeAllSwipes(container);
    }, {passive:true});
  }

  // Render exercises
  function renderExercises(full=true){
    const list=state.exercises.filter(e=>e.part===state.selectedPart);
    if(full) exerciseList.innerHTML="";

    if(state.selectedPart==="ìœ ì‚°ì†Œ"){
      if(full){
        const box=document.createElement('div');
        box.className="card";
        box.innerHTML=`<div class="row between"><div class="ex-title">ìœ ì‚°ì†Œ</div><div class="pill">ì•¼ì™¸ Â· ì‹¤ë‚´ (ì¶”í›„)</div></div>
          <div class="divider"></div><div class="muted">ìœ ì‚°ì†Œ ì…ë ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ.</div>`;
        exerciseList.appendChild(box);
      }
      return;
    }
    if(full && list.length===0){
      const empty=document.createElement('div');
      empty.className="muted"; empty.style.padding="6px 2px";
      empty.textContent="ì¢…ëª©ì„ ì¶”ê°€í•´ì¤˜.";
      exerciseList.appendChild(empty);
      return;
    }
    if(!full) return;

    list.forEach(ex=>{
      const card=document.createElement('div');
      card.className="card ex-card"+(ex.completed?" completed":"");
      card.dataset.id=ex.id;

      const t=fmtHMS(ex.completed?ex.activeMs:getActiveMs(ex));
      const sets=ex.sets||[];
      const vol=totalVolume(ex);
      const nextNo=sets.length+1;

      const setRows = sets.map((s,i)=>`
        <div class="swipe" data-idx="${i}">
          <div class="swipe-actions">
            <div class="btn danger small" data-action="del" data-idx="${i}">ì‚­ì œ</div>
          </div>
          <div class="swipe-front">
            <div class="set-row">
              <div class="set-left">
                <div class="set-no">${i+1}ì„¸íŠ¸</div>
                <div class="set-val">${fmtKg(s.w)}kg Ã— ${s.r} reps</div>
              </div>
              <div class="set-vol">${(s.w*s.r).toLocaleString()}kg</div>
            </div>
          </div>
        </div>
      `).join("");

      const last=ex.lastRecord;
      const ghost=last?`${last.date}  ${fmtKg(last.w)}kg Ã— ${last.r} reps`:`ì´ì „ ê¸°ë¡ ì—†ìŒ`;
      const liveRow = `
        <div class="set-row" style="padding:8px 6px;border-bottom:1px dashed rgba(42,48,64,.7)">
          <div class="set-left">
            <div class="set-no">${nextNo}ì„¸íŠ¸</div>
            <div class="set-val ghosttext">${ghost}</div>
          </div>
          <div class="btn ghost small" data-action="set">ì™„ë£Œ</div>
        </div>
      `;

      card.innerHTML=`
        <div class="row between">
          <div>
            <div class="muted">${ex.part}</div>
            <div class="ex-title">${ex.name}</div>
          </div>
          <div class="pill tap timer ${ex.paused?"paused":""}" data-action="timer">
            â± <span class="timer-val">${t}</span> ${ex.paused?"â¸":""}
          </div>
        </div>

        <div class="details">
          <div class="sets">
            ${setRows}
            ${liveRow}
            <div class="row between" style="padding-top:10px">
              <div class="muted">ì¢…ëª© ë³¼ë¥¨</div>
              <div class="muted">${vol.toLocaleString()}kg</div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="btn ghost" style="flex:1" data-action="complete">ì¢…ëª© ì™„ë£Œ</div>
          </div>
        </div>

        <div class="collapse">
          <div class="divider"></div>
          <div class="row between">
            <div class="muted">ìš”ì•½</div>
            <div class="muted">íƒ­í•˜ë©´ í¼ì³ì§</div>
          </div>
          <div style="margin-top:6px">
            <div class="row between"><div>í›ˆë ¨ì‹œê°„</div><div class="timer">${fmtHMS(ex.activeMs)}</div></div>
            <div class="row between" style="margin-top:4px"><div>ì„¸íŠ¸</div><div class="timer">${sets.length}</div></div>
            <div class="row between" style="margin-top:4px"><div>ì´ ë³¼ë¥¨</div><div class="timer">${vol.toLocaleString()}kg</div></div>
          </div>
        </div>
      `;

      card.addEventListener('click',(ev)=>{
        const a=ev.target.closest('[data-action]');
        if(a){
          ev.preventDefault(); ev.stopPropagation();
          const action=a.dataset.action;

          if(action==="timer"){
            if(ex.completed) return;
            if(!ex.paused){ ex.paused=true; ex.pauseAt=Date.now(); }
            else { ex.paused=false; ex.pausedMs += (Date.now()-ex.pauseAt); ex.pauseAt=null; }
            saveState(); renderExercises();
          }

          if(action==="set"){
            openSetEntry(ex);
          }

          if(action==="del"){
            const idx=parseInt(a.dataset.idx,10);
            deleteSet(ex, idx);
          }

          if(action==="complete"){
            if(ex.completed) return;
            const now=Date.now();
            const pausedExtra=ex.paused?(now-ex.pauseAt):0;
            ex.activeMs=(now-ex.createdAt)-ex.pausedMs-pausedExtra;
            ex.completed=true; ex.paused=false; ex.pauseAt=null;
            saveState(); renderExercises();
          }
          return;
        }

        if(ex.completed){
          ex.completed=false;
          const now=Date.now();
          ex.createdAt = now - ex.activeMs;
          ex.pausedMs=0; ex.activeMs=0;
          saveState(); renderExercises();
        }
      });

      exerciseList.appendChild(card);

      // attach swipe gestures inside this card
      attachSwipeHandlers(card);
    });
  }

  // timer tick update
  setInterval(()=>{
    if(!state.selectedPart) return;
    const list=state.exercises.filter(e=>e.part===state.selectedPart && !e.completed);
    if(list.length===0) return;
    for(const ex of list){
      const card=qs(`.ex-card[data-id="${ex.id}"]`, exerciseList);
      if(!card) continue;
      const v=qs('.timer-val', card);
      if(v) v.textContent=fmtHMS(getActiveMs(ex));
    }
  }, 250);

  endBtn.addEventListener('click',()=>{
    if(!confirm("ì˜¤ëŠ˜ ìš´ë™ì„ ì¢…ë£Œí• ê¹Œ? (ìš”ì•½ì€ ë‹¤ìŒ ë‹¨ê³„)")) return;
    alert("ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì˜¤ëŠ˜ ìš”ì•½ í™”ë©´ ë¶™ì¼ê²Œ.");
  });

  if(state.selectedPart) showWork(state.selectedPart);
  else showPartPicker();
  renderExercises();
</script>
</body>
</html>
