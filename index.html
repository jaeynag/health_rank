<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Health Rank - Updated Flow</title>
<style>
  :root{
    --bg:#0f1115; --card:#141826; --card2:#1b1f2a; --line:#2a3040;
    --txt:#eaeaf0; --mut:#8e93b5; --accent:#4c5cff; --accent2:#cfd3ff;
    --danger:#ff4c6a; --good:#36d399;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui, -apple-system, sans-serif;background:var(--bg);color:var(--txt);overscroll-behavior:none}
  .page{max-width:480px;margin:0 auto;padding:12px 12px 100px}
  
  /* UI Components */
  .section{margin:12px 0}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .row{display:flex;gap:8px;align-items:center}
  .row.between{justify-content:space-between}
  .muted{color:var(--mut);font-size:12px}
  .btn{background:var(--card2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px;text-align:center;cursor:pointer;user-select:none}
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.small{padding:6px 10px;font-size:13px}
  .input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,0.03);color:#fff;outline:none}

  /* Tier Card Custom */
  .tier-score-area{text-align:center;padding:10px 0}
  .start-workout-btn{margin-top:16px;width:100%;font-weight:900;font-size:16px;box-shadow: 0 4px 15px rgba(76, 92, 255, 0.3)}

  /* Calendar */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  .cal-cell{
    border:1px solid var(--line);background:rgba(255,255,255,0.02);border-radius:8px;
    min-height:50px;padding:4px;display:flex;flex-direction:column;align-items:center;cursor:pointer;
  }
  .cal-cell.today{border-color:var(--accent);background:rgba(76,92,255,0.1)}
  .cal-cell .day-num{font-size:12px;font-weight:700}
  .cal-cell .top-part{font-size:10px;color:var(--accent2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  
  /* Calendar Detail Overlay (Fixed to prevent scrolling issues) */
  .cal-detail-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
    display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .cal-detail-overlay.active { display: flex; }
  .cal-detail-card { 
    background: var(--card); border: 1px solid var(--line); border-radius: 20px; 
    width: 100%; max-width: 340px; padding: 20px; 
  }

  /* Vertical Part List for Exercise Addition */
  .part-list-v { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .part-item-v { 
    padding: 14px; border-radius: 12px; border: 1px solid var(--line); 
    background: var(--card2); text-align: center; font-weight: 700;
  }
  .part-item-v.selected { border-color: var(--accent); background: rgba(76, 92, 255, 0.15); color: var(--accent2); }

  /* Tiers */
  .pill{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;background:var(--line)}
  .screen { display: none; }
  .screen.active { display: block; }

  /* Overlay System */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2000;display:none;align-items:flex-end}
  .overlay.active{display:flex}
  .drawer{width:100%;background:var(--card);border-radius:20px 20px 0 0;padding:20px;max-height:85vh;overflow-y:auto}
</style>
</head>
<body>

<div id="app">
  <div id="screen-auth" class="screen active">
    <div class="page" style="margin-top:100px">
      <div class="card">
        <h2>로그인</h2>
        <input type="text" id="authId" class="input" placeholder="아이디" value="user123" style="margin-bottom:10px">
        <input type="password" id="authPw" class="input" placeholder="비밀번호" value="****">
        <div class="btn primary" id="btnLogin" style="margin-top:20px">로그인 시작</div>
      </div>
    </div>
  </div>

  <div id="screen-main" class="screen">
    <div class="page">
      <div class="section card">
        <div class="row between">
          <div class="muted">내 현재 등급</div>
          <div class="pill" style="background:#ffd700;color:#000">GOLD III</div>
        </div>
        <div class="tier-score-area">
          <div style="font-size:32px;font-weight:900">1,250 <span style="font-size:14px;color:var(--mut)">pt</span></div>
          <div class="muted" style="margin-top:4px">어제보다 +45pt 상승</div>
        </div>
        <div class="btn primary start-workout-btn" id="btnGoWorkout">운동 시작</div>
      </div>

      <div class="section card">
        <div class="row between" style="margin-bottom:15px">
          <div style="font-weight:800">운동 달력</div>
          <div class="row">
            <div class="btn small" id="calPrev"><</div>
            <div id="calMonth" style="font-variant-numeric:tabular-nums;font-weight:700">2023.12</div>
            <div class="btn small" id="calNext">></div>
          </div>
        </div>
        <div class="cal-grid" id="calGrid">
          </div>
      </div>
    </div>
  </div>

  <div id="screen-workout" class="screen">
    <div class="page">
      <div class="row" style="margin-bottom:20px">
        <div class="btn small" id="btnBackHome">← 돌아가기</div>
        <div style="font-weight:800;font-size:18px;margin-left:10px">오늘의 운동 기록</div>
      </div>

      <div id="exerciseList">
        <div class="muted" id="emptyMsg" style="text-align:center;padding:40px 0">추가된 운동이 없습니다.</div>
      </div>

      <div class="btn" id="btnAddExercise" style="margin-top:20px;border-style:dashed;background:transparent">
        + 운동 추가
      </div>
    </div>
  </div>
</div>

<div class="cal-detail-overlay" id="calDetailOverlay">
  <div class="cal-detail-card">
    <div class="row between" style="margin-bottom:15px">
      <div id="detailDate" style="font-weight:800">2023-12-20</div>
      <div class="btn small" onclick="closeDetail()">닫기</div>
    </div>
    <div id="detailContent">
      </div>
  </div>
</div>

<div class="overlay" id="addExOverlay">
  <div class="drawer">
    <div class="row between" style="margin-bottom:20px">
      <div style="font-weight:800;font-size:18px">운동 추가</div>
      <div class="btn small" onclick="closeAddEx()">취소</div>
    </div>
    
    <div class="muted" style="margin-bottom:8px">부위 선택</div>
    <div class="part-list-v" id="partListV">
      <div class="part-item-v" data-part="가슴">가슴</div>
      <div class="part-item-v" data-part="등">등</div>
      <div class="part-item-v" data-part="하체">하체</div>
      <div class="part-item-v" data-part="어깨">어깨</div>
      <div class="part-item-v" data-part="팔">팔</div>
      <div class="part-item-v" data-part="복근">복근</div>
    </div>

    <div class="muted" style="margin-bottom:8px">종목 이름</div>
    <input type="text" id="exNameInput" class="input" placeholder="예: 벤치프레스">
    
    <div class="btn primary" id="btnConfirmAdd" style="margin-top:20px;width:100%">추가하기</div>
  </div>
</div>

<script>
/**
 * Core Data & State
 */
let currentUser = { nick: "재양" };
let lastSelectedPart = "가슴"; // Sticky selection
let workoutHistory = {
  "2025-12-18": { "등": 5000, "팔": 1200 },
  "2025-12-19": { "가슴": 6000, "어깨": 2000, "삼두": 800 },
  "2025-12-20": { "하체": 12000, "복근": 500 }
};

const screens = {
  auth: document.getElementById('screen-auth'),
  main: document.getElementById('screen-main'),
  workout: document.getElementById('screen-workout')
};

function showScreen(key) {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[key].classList.add('active');
}

/**
 * 1. Auto Login Logic
 */
window.onload = () => {
  // 실제 앱이라면 localStorage 체크
  const savedId = "user123"; 
  if(savedId) {
    alert(`이전 로그인한 '${currentUser.nick}'님으로 자동 로그인 됐습니다.`);
    showScreen('main');
    renderCalendar();
  }
};

document.getElementById('btnLogin').onclick = () => {
  showScreen('main');
  renderCalendar();
};

/**
 * 2. Navigation
 */
document.getElementById('btnGoWorkout').onclick = () => showScreen('workout');
document.getElementById('btnBackHome').onclick = () => showScreen('main');

/**
 * 3. Calendar Logic
 */
function renderCalendar() {
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  const now = new Date();
  const year = 2025, month = 11; // 12월 기준 예시

  // 1일부터 31일까지 생성 (단순화)
  for(let i=1; i<=31; i++) {
    const dateStr = `2025-12-${String(i).padStart(2,'0')}`;
    const data = workoutHistory[dateStr];
    
    const cell = document.createElement('div');
    cell.className = 'cal-cell';
    if(i === 20) cell.classList.add('today');
    
    // 볼륨 최대 부위 찾기
    let topPart = '';
    if(data) {
      topPart = Object.entries(data).sort((a,b) => b[1] - a[1])[0][0];
    }

    cell.innerHTML = `
      <div class="day-num">${i}</div>
      <div class="top-part">${topPart}</div>
    `;
    
    cell.onclick = () => openDetail(dateStr);
    grid.appendChild(cell);
  }
}

function openDetail(date) {
  const overlay = document.getElementById('calDetailOverlay');
  const content = document.getElementById('detailContent');
  const dateTitle = document.getElementById('detailDate');
  
  dateTitle.innerText = date;
  content.innerHTML = '';
  
  const data = workoutHistory[date];
  if(!data) {
    content.innerHTML = '<div class="muted">기록이 없습니다.</div>';
  } else {
    // 볼륨순 정렬
    const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]);
    sorted.forEach(([part, vol]) => {
      const row = document.createElement('div');
      row.className = 'row between';
      row.style.padding = '10px 0';
      row.style.borderBottom = '1px solid var(--line)';
      row.innerHTML = `
        <div style="font-weight:700">${part}</div>
        <div class="muted">${vol.toLocaleString()} kg</div>
      `;
      content.appendChild(row);
    });
  }
  
  overlay.classList.add('active');
}

function closeDetail() {
  document.getElementById('calDetailOverlay').classList.remove('active');
}

/**
 * 4. Workout Entry & Exercise Add (New Mechanism)
 */
const addExOverlay = document.getElementById('addExOverlay');
const partItems = document.querySelectorAll('.part-item-v');

document.getElementById('btnAddExercise').onclick = () => {
  addExOverlay.classList.add('active');
  // Sticky 부위 적용
  selectPart(lastSelectedPart);
};

function selectPart(partName) {
  lastSelectedPart = partName;
  partItems.forEach(item => {
    item.classList.toggle('selected', item.dataset.part === partName);
  });
}

partItems.forEach(item => {
  item.onclick = () => selectPart(item.dataset.part);
});

function closeAddEx() {
  addExOverlay.classList.remove('active');
  document.getElementById('exNameInput').value = '';
}

document.getElementById('btnConfirmAdd').onclick = () => {
  const name = document.getElementById('exNameInput').value;
  if(!name) return alert('운동 이름을 입력하세요.');
  
  addExerciseToList(lastSelectedPart, name);
  closeAddEx();
};

function addExerciseToList(part, name) {
  const list = document.getElementById('exerciseList');
  const emptyMsg = document.getElementById('emptyMsg');
  if(emptyMsg) emptyMsg.remove();
  
  const div = document.createElement('div');
  div.className = 'card';
  div.style.marginBottom = '10px';
  div.innerHTML = `
    <div class="row between">
      <div>
        <span class="muted">[${part}]</span>
        <div style="font-weight:800;font-size:16px">${name}</div>
      </div>
      <div class="btn small">세트 추가</div>
    </div>
  `;
  list.appendChild(div);
}

</script>
</body>
</html>
