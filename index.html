<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Health Rank - App (Step42)</title>
<style>
  :root{
    --bg:#0f1115; --card:#141826; --card2:#1b1f2a; --line:#2a3040;
    --txt:#eaeaf0; --mut:#8e93b5; --accent:#4c5cff; --accent2:#cfd3ff;
    --danger:#ff4c6a; --good:#36d399;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--txt)}
  .page{max-width:480px;margin:0 auto;padding:12px 12px 24px}
  
  /* UI Helpers */
  .section{margin:12px 0}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .row.between{justify-content:space-between}
  .muted{color:var(--mut);font-size:12px}
  .btn{background:var(--card2);border:1px solid var(--line);color:#fff;border-radius:10px;padding:12px;text-align:center;user-select:none;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.ghost{background:var(--card);border-color:var(--line)}
  .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}
  .btn.danger{background:rgba(255,76,106,.14);border-color:rgba(255,76,106,.40);color:#ffd0d8}
  .input{width:100%;padding:12px;border-radius:12px;border:1px solid #23283a;background:rgba(255,255,255,.03);color:var(--txt);outline:none;font-size:16px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);user-select:none;font-size:12px}
  .divider{height:1px;background:var(--line);margin:10px 0;opacity:.8}
  .hidden{display:none !important}

  /* Tier Colors */
  .tier-pill{font-weight:900}
  .tier-bronze{background:rgba(205,127,50,.18);border-color:rgba(205,127,50,.35)}
  .tier-silver{background:rgba(192,192,192,.12);border-color:rgba(192,192,192,.28)}
  .tier-gold{background:rgba(255,215,0,.12);border-color:rgba(255,215,0,.30)}
  .tier-platinum{background:rgba(120,225,255,.10);border-color:rgba(120,225,255,.28)}
  
  /* Exercise List & Cards */
  .ex-card{position:relative; transition: background 0.2s;}
  .ex-card.active{border-color:rgba(255,214,102,.24);box-shadow:0 0 0 1px rgba(255,214,102,.14) inset}
  .ex-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;cursor:pointer}
  .ex-title{font-weight:900;font-size:15px}
  .ex-sub{color:var(--mut);font-size:12px;margin-top:2px}
  .ex-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .ex-vol{font-weight:700;font-size:13px;color:var(--accent2)}
  
  /* Sets & Swipe */
  .swipe{position:relative;overflow:hidden;border-radius:12px;margin:6px 0;background:var(--card);border:1px dashed rgba(42,48,64,.7);touch-action:pan-y}
  .swipe-actions{position:absolute;top:0;right:0;bottom:0;width:86px;display:flex;align-items:center;justify-content:center;background:rgba(255,76,106,.12);z-index:0;color:var(--danger);font-weight:bold}
  .swipe-front{position:relative;z-index:1;background:var(--card);padding:10px;transition:transform 140ms ease-out}
  .swipe.open .swipe-front{transform:translateX(-86px)}
  .swipe-front.done{background:rgba(54,211,153,.08);border:1px solid rgba(54,211,153,.2)}
  .set-row{display:flex;justify-content:space-between;align-items:center}
  .check{display:inline-flex;width:16px;height:16px;border-radius:9px;background:rgba(54,211,153,.2);color:#c9ffe9;font-size:10px;align-items:center;justify-content:center;margin-right:6px}

  /* Calendar */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-cell{border:1px solid rgba(42,48,64,.7);background:rgba(255,255,255,.02);border-radius:12px;padding:8px 4px;min-height:54px;display:flex;flex-direction:column;align-items:center;gap:2px}
  .cal-day{font-weight:900;font-size:13px}
  .cal-sub{font-size:10px;color:var(--mut);white-space:nowrap;overflow:hidden;width:100%;text-align:center}
  .cal-today{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
  .cal-pop{position:fixed;z-index:9998;max-width:300px;padding:12px;border-radius:14px;background:rgba(18,20,29,.98);border:1px solid var(--line);box-shadow:0 10px 40px #000}
  
  /* Overlays */
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:100;align-items:center;justify-content:center;padding:16px}
  .overlay.show{display:flex}
  .drawer{width:100%;max-width:460px;background:var(--card);border-radius:16px;border:1px solid var(--line);overflow:hidden;max-height:85vh;display:flex;flex-direction:column}
  .drawer-head{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;background:var(--card2)}
  .drawer-body{padding:16px;overflow-y:auto}

  /* Popup specific: Add Exercise */
  .part-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:12px}
  .part-scroll::-webkit-scrollbar{height:4px}
  .part-scroll::-webkit-scrollbar-thumb{background:var(--line);border-radius:4px}
  .part-chip{flex:0 0 auto;padding:8px 14px;border-radius:20px;border:1px solid var(--line);background:var(--card2);font-size:13px;color:var(--mut);transition:all .2s}
  .part-chip.active{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:bold}
  
  .rec-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
  .rec-card{padding:12px;border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.02);text-align:center;font-size:13px;font-weight:700;color:var(--txt);cursor:pointer}
  .rec-card:active{background:rgba(255,255,255,.08)}

  /* Toast */
  #toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(76,92,255,.95);color:#fff;padding:10px 20px;border-radius:24px;font-size:13px;font-weight:800;z-index:9999;opacity:0;transition:all .3s ease;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,.3)}
  #toast.show{transform:translateX(-50%) translateY(0);opacity:1}

  /* Navigation */
  .bottom-nav{position:fixed;bottom:12px;left:12px;right:12px;background:rgba(15,17,21,.9);backdrop-filter:blur(10px);border:1px solid var(--line);border-radius:16px;padding:10px;z-index:50;display:flex;justify-content:space-around}
  .navbtn{background:none;border:none;padding:8px;color:var(--mut);display:flex;flex-direction:column;align-items:center;gap:4px}
  .navbtn.active{color:var(--accent2)}
  .navbtn svg{width:22px;height:22px}

  /* Keypad */
  .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
  .key{background:var(--card2);border:1px solid var(--line);padding:14px;text-align:center;border-radius:10px;font-size:18px;font-weight:bold}

  /* Screens */
  .screen{display:none}
  .screen.active{display:block}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="toast"></div>

<div id="screen-auth" class="screen active">
  <div class="page" style="padding-top:60px">
    <div class="card">
      <div class="h2" style="font-weight:900;font-size:20px;margin-bottom:6px">로그인</div>
      <div class="muted" style="margin-bottom:20px">Health Rank 시작하기</div>
      
      <div class="muted">아이디</div>
      <input type="text" id="authId" class="input" style="margin-bottom:12px">
      <div class="muted">비밀번호</div>
      <input type="password" id="authPw" class="input" style="margin-bottom:20px">
      
      <div class="row">
        <div class="btn primary" id="btnLogin" style="flex:1">로그인</div>
        <div class="btn ghost" id="btnSignup" style="flex:1">회원가입</div>
      </div>
      <div id="authMsg" class="muted" style="margin-top:12px;text-align:center;min-height:16px"></div>
    </div>
  </div>
</div>

<div id="screen-today" class="screen">
  <div class="page">
    <div class="row between" style="margin-bottom:12px">
      <div style="font-weight:900;font-size:18px">오늘</div>
      <div class="card" style="padding:6px 12px;display:flex;align-items:center;gap:10px">
        <div class="muted" style="font-size:11px">TIME</div>
        <div style="font-weight:900;font-variant-numeric:tabular-nums" id="clock">00:00</div>
      </div>
    </div>

    <div class="section card" id="tierCard">
      <div class="row between">
        <div>
          <div class="muted">내 티어</div>
          <div style="font-weight:900;font-size:24px;margin-top:2px" id="tierName">언랭크</div>
          <div class="muted" id="tierSub" style="margin-top:4px">시즌 초기화: 0/5</div>
        </div>
        <div style="text-align:right">
          <div class="pill tier-bronze" id="tierBadge">0 pt</div>
          <div class="muted" id="tierDelta" style="margin-top:6px"></div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="btn primary" id="btnStartWorkMain">운동 시작하기</div>
    </div>

    <div class="section card" id="calendarCard">
      <div class="row between">
        <div>
          <div class="muted">달력</div>
          <div style="font-weight:900;margin-top:2px" id="calTitle">-</div>
        </div>
        <div class="row">
          <div class="btn small ghost" id="calPrev">←</div>
          <div class="btn small ghost" id="calNext">→</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="cal-grid" id="calDow" style="margin-bottom:6px"></div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
    
    <div id="calPop" class="cal-pop hidden"></div>
  </div>
</div>

<div id="screen-work" class="screen">
  <div class="page">
    <div class="card" style="position:sticky;top:10px;z-index:10;border:1px solid var(--accent)">
      <div class="row between">
        <div style="font-weight:900">운동 기록 중</div>
        <div style="text-align:right">
          <div class="muted" id="workTimer">00:00:00</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <div class="btn ghost" id="btnAddExBtn" style="flex:1">+ 종목 추가</div>
        <div class="btn danger" id="btnEndWork" style="width:80px">종료</div>
      </div>
    </div>

    <div id="exerciseList" style="margin-top:16px">
      </div>
  </div>
</div>

<div id="screen-summary" class="screen">
  <div class="page">
    <div class="card">
      <div class="h2" style="font-weight:900;margin-bottom:4px">운동 요약</div>
      <div class="muted" id="sumDate">-</div>
      <div class="divider"></div>
      
      <div class="row between">
        <div>
          <div class="muted">총 볼륨</div>
          <div style="font-weight:900;font-size:22px" id="sumVol">0kg</div>
        </div>
        <div style="text-align:right">
          <div class="muted">시간</div>
          <div style="font-weight:900;font-size:22px" id="sumTime">00:00</div>
        </div>
      </div>
      <div class="divider"></div>
      
      <div class="muted" style="margin-bottom:8px">부위별 기록</div>
      <div id="sumPartsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>

      <div class="divider"></div>
      <div class="btn primary" id="btnAddMoreToday">오늘 운동 더하기</div>
    </div>
  </div>
</div>

<div id="screen-more" class="screen">
  <div class="page">
    <div class="card">
      <div class="h2" style="font-weight:900">더보기</div>
      <div class="divider"></div>
      <div class="row between">
        <div style="font-weight:900" id="myNickDisplay">-</div>
        <div class="btn small ghost">프로필 수정</div>
      </div>
      <div class="divider"></div>
      <div class="btn danger" id="btnResetAll">데이터 초기화</div>
    </div>
  </div>
</div>

<div class="bottom-nav" id="bottomNav" style="display:none">
  <div class="navbtn active" data-target="today">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    <span style="font-size:10px;font-weight:700">홈</span>
  </div>
  <div class="navbtn" data-target="summary">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
    <span style="font-size:10px;font-weight:700">기록</span>
  </div>
  <div class="navbtn" data-target="more">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
    <span style="font-size:10px;font-weight:700">더보기</span>
  </div>
</div>

<div class="overlay" id="overlayAddEx">
  <div class="drawer">
    <div class="drawer-head">
      <div style="font-weight:900">운동 추가</div>
      <div class="btn small ghost" id="closeAddEx">닫기</div>
    </div>
    <div class="drawer-body">
      <div class="part-scroll" id="addExParts">
        </div>
      
      <div class="muted" style="margin:10px 0 6px" id="recLabel">추천 종목</div>
      <div class="rec-grid" id="recGrid"></div>
      
      <div class="divider"></div>
      
      <div class="muted" style="margin-bottom:6px">직접 검색/입력</div>
      <div class="row">
        <input type="text" class="input" id="exNameInput" placeholder="운동 이름">
        <div class="btn primary small" id="exAddConfirm">추가</div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="overlaySet">
  <div class="drawer">
    <div class="drawer-head">
      <div>
        <div style="font-weight:900" id="setTitle">1세트</div>
        <div class="muted" id="setSub" style="font-size:11px">-</div>
      </div>
      <div class="btn small ghost" id="closeSet">닫기</div>
    </div>
    <div class="drawer-body">
      <div id="stepWeight">
        <div style="text-align:center;margin:10px 0">
          <div class="muted">무게 (kg)</div>
          <div style="font-size:32px;font-weight:900"><span id="valWeight">20</span></div>
        </div>
        <div class="kbd" id="kbdWeight"></div>
        <div class="btn primary" style="margin-top:16px" id="btnNextReps">다음 (횟수)</div>
      </div>
      <div id="stepReps" class="hidden">
        <div style="text-align:center;margin:10px 0">
          <div class="muted">횟수</div>
          <div style="font-size:32px;font-weight:900"><span id="valReps">10</span></div>
        </div>
        <div class="kbd" id="kbdReps"></div>
        <div class="row" style="margin-top:16px">
          <div class="btn ghost" style="flex:1" id="btnPrevWeight">이전</div>
          <div class="btn primary" style="flex:2;margin-left:8px" id="btnSaveSet">저장</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// --- Configuration & Data ---
const STORAGE_KEY = "hr_data_v2";
const DB_EXERCISES = {
  "가슴": ["벤치프레스", "인클라인 벤치", "덤벨 프레스", "딥스", "푸쉬업", "케이블 크로스오버", "체스트 프레스", "팩덱 플라이"],
  "등": ["랫풀다운", "풀업", "시티드 로우", "바벨 로우", "데드리프트", "원암 덤벨 로우", "티바 로우"],
  "하체": ["스쿼트", "레그 프레스", "런지", "레그 익스텐션", "레그 컬", "힙 쓰러스트", "카프 레이즈"],
  "어깨": ["오버헤드 프레스", "사이드 레터럴 레이즈", "숄더 프레스", "페이스 풀", "프론트 레이즈"],
  "팔": ["바벨 컬", "덤벨 컬", "트라이셉스 익스텐션", "해머 컬", "푸쉬다운", "스컬 크러셔"],
  "복근": ["크런치", "레그 레이즈", "플랭크", "행잉 레그레이즈", "러시안 트위스트"]
};
const PARTS = Object.keys(DB_EXERCISES);

// --- State ---
let state = {
  user: null,
  exercises: [], // {id, part, name, sets:[], isDone, isCollapsed}
  startTime: null,
  endTime: null,
  selectedPartForAdd: "가슴" // For popup
};

// --- Helpers ---
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

function showToast(msg) {
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function saveState() {
  const saveObj = {
    exercises: state.exercises,
    startTime: state.startTime,
    endTime: state.endTime
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(saveObj));
}

function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    const p = JSON.parse(saved);
    state.exercises = p.exercises || [];
    state.startTime = p.startTime;
    state.endTime = p.endTime;
  }
}

// --- Navigation & Auth ---
function switchScreen(id) {
  $$('.screen').forEach(el => el.classList.remove('active'));
  $(`#screen-${id}`).classList.add('active');
  
  // Req 4: Hide Nav on Main(Today) Screen
  const nav = $('#bottomNav');
  if(id === 'today') {
    nav.style.display = 'none';
    renderCalendar();
  } else if (id === 'auth') {
    nav.style.display = 'none';
  } else {
    nav.style.display = 'flex';
  }
  
  // Tab active state
  $$('.navbtn').forEach(b => b.classList.remove('active'));
  const targetBtn = $(`.navbtn[data-target="${id}"]`);
  if(targetBtn) targetBtn.classList.add('active');
}

// Auth Logic (Mock for demo, similar to provided code)
$('#btnLogin').onclick = () => {
  const id = $('#authId').value;
  if(id) {
    const user = {id: 'u1', nick: id};
    localStorage.setItem('hr_user', JSON.stringify(user));
    loginSuccess(user, false);
  }
};

function checkSession() {
  const u = localStorage.getItem('hr_user');
  if(u) loginSuccess(JSON.parse(u), true);
  else switchScreen('auth');
}

function loginSuccess(user, isAuto) {
  state.user = user;
  $('#myNickDisplay').textContent = user.nick;
  
  // Req 1: Auto Login Toast
  if(isAuto) {
    showToast(`${user.nick}님으로 자동 로그인 됐습니다.`);
  }
  
  loadState();
  if(state.exercises.length > 0 && !state.endTime) {
    // Resume workout
    switchScreen('work');
    renderWorkout();
  } else {
    switchScreen('today');
  }
}

// --- Main Screen Logic ---
// Req 2: Start Button
$('#btnStartWorkMain').onclick = () => {
  if(!state.startTime || state.endTime) {
    // New Workout
    state.exercises = [];
    state.startTime = Date.now();
    state.endTime = null;
    saveState();
  }
  renderWorkout();
  switchScreen('work');
};

// Calendar (Simple Render)
function renderCalendar() {
  const y = new Date().getFullYear();
  const m = new Date().getMonth() + 1;
  $('#calTitle').textContent = `${y}. ${String(m).padStart(2,'0')}`;
  
  // Headers
  const dow = $('#calDow');
  dow.innerHTML = '일월화수목금토'.split('').map(d=>`<div class="cal-cell" style="min-height:auto;border:none">${d}</div>`).join('');
  
  const grid = $('#calGrid');
  grid.innerHTML = '';
  const firstDay = new Date(y, m-1, 1).getDay();
  const lastDate = new Date(y, m, 0).getDate();
  
  for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
  for(let d=1; d<=lastDate; d++) {
    // Mock Data logic for "Max Volume Part"
    const isToday = d === new Date().getDate();
    const cell = document.createElement('div');
    cell.className = `cal-cell ${isToday ? 'cal-today' : ''}`;
    cell.innerHTML = `<div class="cal-day">${d}</div><div class="cal-sub">-</div>`;
    
    // Req: Show Max Volume Part (Logic would go here to fetch history)
    // For demo, just leave blank or random
    if(Math.random() > 0.7) {
       cell.querySelector('.cal-sub').textContent = PARTS[Math.floor(Math.random()*PARTS.length)];
       cell.style.borderColor = 'rgba(76,92,255,.3)';
    }
    
    // Popup logic (Briefly included from Step41)
    cell.onclick = (e) => {
       const pop = $('#calPop');
       pop.classList.remove('hidden');
       pop.style.left = e.clientX + 'px';
       pop.style.top = e.clientY + 'px';
       pop.innerHTML = `<div style="font-weight:900">${y}-${m}-${d}</div><div class="muted">운동 상세 기록 없음 (데모)</div>`;
       setTimeout(()=>pop.classList.add('hidden'), 2000);
    };
    grid.appendChild(cell);
  }
}

// --- Workout Screen Logic ---
function renderWorkout() {
  const list = $('#exerciseList');
  list.innerHTML = '';
  
  if(state.exercises.length === 0) {
    list.innerHTML = `<div class="muted" style="text-align:center;padding:40px 0">운동을 추가해주세요.</div>`;
    return;
  }
  
  state.exercises.forEach((ex, idx) => {
    const el = document.createElement('div');
    el.className = `card ex-card ${ex.isCollapsed ? 'collapsed' : ''} ${!ex.isDone ? 'active' : ''}`;
    
    const totalVol = ex.sets.reduce((a,c) => a + (c.kg*c.reps), 0);
    const setsDone = ex.sets.filter(s=>s.done).length;
    
    // Header
    const header = document.createElement('div');
    header.className = 'ex-head';
    header.onclick = (e) => {
        if(e.target.closest('.btn')) return; // ignore buttons
        ex.isCollapsed = !ex.isCollapsed;
        saveState();
        renderWorkout();
    };
    
    header.innerHTML = `
      <div>
        <div class="muted">${ex.part}</div>
        <div class="ex-title">${ex.name}</div>
        <div class="ex-sub">${ex.sets.length}세트 · ${setsDone}완료</div>
      </div>
      <div class="ex-meta">
         <div class="ex-vol">${totalVol.toLocaleString()}kg</div>
         <div class="btn small ${ex.isDone?'ghost':'good'}" data-action="done">${ex.isDone?'완료됨':'종목 완료'}</div>
      </div>
    `;
    
    // Body (Sets)
    const body = document.createElement('div');
    body.style.marginTop = '10px';
    if(ex.isCollapsed) body.style.display = 'none';
    
    // Sets List
    ex.sets.forEach((s, sIdx) => {
        const row = document.createElement('div');
        row.className = `swipe ${s.done ? 'done' : ''}`;
        // Swipe delete layer
        row.innerHTML = `
           <div class="swipe-actions" onclick="deleteSet(${idx}, ${sIdx})">삭제</div>
           <div class="swipe-front ${s.done ? 'done' : ''}" onclick="toggleSetDone(${idx}, ${sIdx})">
             <div class="set-row">
               <div style="display:flex;align-items:center">
                 <div class="check">${sIdx+1}</div>
                 <div style="font-weight:700;font-variant-numeric:tabular-nums">${s.kg}kg × ${s.reps}</div>
               </div>
               <div class="muted" style="font-size:12px">${s.kg*s.reps}</div>
             </div>
           </div>
        `;
        // Attach Swipe Logic (Simplified)
        let startX=0;
        const front = row.querySelector('.swipe-front');
        front.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        front.addEventListener('touchmove', e => {
            if(startX - e.touches[0].clientX > 50) row.classList.add('open');
            else row.classList.remove('open');
        });
        
        body.appendChild(row);
    });
    
    // Add Set Button
    const addSetBtn = document.createElement('div');
    addSetBtn.className = 'btn ghost small';
    addSetBtn.style.marginTop = '8px';
    addSetBtn.textContent = '+ 세트 추가';
    addSetBtn.onclick = () => openSetModal(idx);
    body.appendChild(addSetBtn);
    
    el.appendChild(header);
    el.appendChild(body);
    
    // Header Actions
    header.querySelector('[data-action="done"]').onclick = (e) => {
        e.stopPropagation(); // prevent collapse toggle
        toggleExerciseDone(idx);
    };
    
    list.appendChild(el);
  });
}

// Req 7: Mark Done -> No Collapse
function toggleExerciseDone(idx) {
  const ex = state.exercises[idx];
  ex.isDone = !ex.isDone;
  // ex.isCollapsed = true; // REMOVED as per Req 7
  saveState();
  renderWorkout();
}

// Req 6: End Workout Check
$('#btnEndWork').onclick = () => {
  const pending = state.exercises.filter(e => !e.isDone);
  if(pending.length > 0) {
    if(!confirm('아직 완료되지 않은 종목이 있습니다.\n운동을 종료하시겠습니까?')) return;
  }
  finishWorkout();
};

function finishWorkout() {
  state.endTime = Date.now();
  state.exercises.forEach(e => { e.isDone = true; e.isCollapsed = true; });
  saveState();
  renderSummary();
  switchScreen('summary');
}

// --- Add Exercise Overlay (Req 5) ---
$('#btnAddExBtn').onclick = () => {
  renderAddExPopup();
  $('#overlayAddEx').classList.add('show');
};
$('#closeAddEx').onclick = () => $('#overlayAddEx').classList.remove('show');

function renderAddExPopup() {
  // 1. Part Chips (Single Row)
  const scroll = $('#addExParts');
  scroll.innerHTML = '';
  PARTS.forEach(p => {
     const chip = document.createElement('div');
     chip.className = `part-chip ${p === state.selectedPartForAdd ? 'active' : ''}`;
     chip.textContent = p;
     chip.onclick = () => {
       state.selectedPartForAdd = p;
       renderAddExPopup(); // Re-render to update selection and recs
     };
     scroll.appendChild(chip);
  });
  
  // 2. Recommendations
  const recGrid = $('#recGrid');
  recGrid.innerHTML = '';
  const recs = DB_EXERCISES[state.selectedPartForAdd] || [];
  // Show top 6
  recs.slice(0, 6).forEach(name => {
      const c = document.createElement('div');
      c.className = 'rec-card';
      c.textContent = name;
      c.onclick = () => confirmAddExercise(name);
      recGrid.appendChild(c);
  });
  
  $('#exNameInput').value = '';
}

$('#exAddConfirm').onclick = () => {
  const name = $('#exNameInput').value.trim();
  if(name) confirmAddExercise(name);
};

function confirmAddExercise(name) {
  state.exercises.push({
    id: Date.now(),
    part: state.selectedPartForAdd,
    name: name,
    sets: [],
    isDone: false,
    isCollapsed: false
  });
  saveState();
  $('#overlayAddEx').classList.remove('show');
  renderWorkout();
}

// --- Set Input Overlay ---
let currentExIdx = null;
let tempSet = {kg: 20, reps: 10};

function openSetModal(idx) {
  currentExIdx = idx;
  const ex = state.exercises[idx];
  // Inherit last set
  if(ex.sets.length > 0) {
      tempSet = {...ex.sets[ex.sets.length-1], done: false};
  }
  
  $('#setTitle').textContent = `${ex.sets.length + 1}세트`;
  $('#setSub').textContent = `${ex.part} · ${ex.name}`;
  
  $('#stepWeight').classList.remove('hidden');
  $('#stepReps').classList.add('hidden');
  updateSetDisplay();
  $('#overlaySet').classList.add('show');
}

$('#closeSet').onclick = () => $('#overlaySet').classList.remove('show');

function updateSetDisplay() {
  $('#valWeight').textContent = tempSet.kg;
  $('#valReps').textContent = tempSet.reps;
}

// Keypads
function renderKeypad(id, keys, action) {
  const kbd = $(id);
  kbd.innerHTML = '';
  keys.forEach(k => {
      const key = document.createElement('div');
      key.className = 'key';
      key.textContent = k;
      key.onclick = () => action(k);
      kbd.appendChild(key);
  });
}

renderKeypad('#kbdWeight', ['-5','-1','+1','+5','C','OK'], (k)=>{
    if(k==='OK') $('#btnNextReps').click();
    else if(k==='C') tempSet.kg = 0;
    else {
        tempSet.kg += parseInt(k);
        if(tempSet.kg < 0) tempSet.kg = 0;
    }
    updateSetDisplay();
});

renderKeypad('#kbdReps', ['-5','-1','+1','+5','10','12'], (k)=>{
    tempSet.reps += parseInt(k);
    if(tempSet.reps < 1) tempSet.reps = 1;
    updateSetDisplay();
});

$('#btnNextReps').onclick = () => {
    $('#stepWeight').classList.add('hidden');
    $('#stepReps').classList.remove('hidden');
};
$('#btnPrevWeight').onclick = () => {
    $('#stepReps').classList.add('hidden');
    $('#stepWeight').classList.remove('hidden');
};
$('#btnSaveSet').onclick = () => {
    if(currentExIdx !== null) {
        state.exercises[currentExIdx].sets.push({...tempSet});
        saveState();
        renderWorkout();
        $('#overlaySet').classList.remove('show');
    }
};

function deleteSet(exIdx, sIdx) {
    if(confirm('세트를 삭제할까요?')) {
        state.exercises[exIdx].sets.splice(sIdx, 1);
        saveState();
        renderWorkout();
    }
}
function toggleSetDone(exIdx, sIdx) {
    const s = state.exercises[exIdx].sets[sIdx];
    s.done = !s.done;
    saveState();
    renderWorkout();
}

// --- Summary & Logic ---
function renderSummary() {
    const totalVol = state.exercises.reduce((acc, ex) => acc + ex.sets.reduce((a,s)=>a+(s.kg*s.reps),0), 0);
    const duration = state.endTime && state.startTime ? Math.floor((state.endTime - state.startTime)/1000) : 0;
    const h = Math.floor(duration/3600);
    const m = Math.floor((duration%3600)/60);
    
    $('#sumDate').textContent = new Date().toLocaleDateString();
    $('#sumVol').textContent = totalVol.toLocaleString() + 'kg';
    $('#sumTime').textContent = `${h}:${String(m).padStart(2,'0')}`;
    
    // Parts
    const parts = {};
    state.exercises.forEach(ex => {
        const v = ex.sets.reduce((a,s)=>a+(s.kg*s.reps),0);
        parts[ex.part] = (parts[ex.part] || 0) + v;
    });
    
    const grid = $('#sumPartsGrid');
    grid.innerHTML = '';
    Object.entries(parts).sort((a,b)=>b[1]-a[1]).forEach(([p,v]) => {
        grid.innerHTML += `<div class="card" style="padding:10px;background:rgba(255,255,255,.05)">
            <div class="muted">${p}</div>
            <div style="font-weight:900">${v.toLocaleString()}</div>
        </div>`;
    });
}

// Req 8: Add More -> Go back to Work
$('#btnAddMoreToday').onclick = () => {
    state.endTime = null;
    saveState();
    switchScreen('work');
    renderWorkout();
};

// Reset
$('#btnResetAll').onclick = () => {
    if(confirm('정말 초기화하시겠습니까?')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
};

// Nav Listeners
$$('.navbtn').forEach(btn => {
    btn.onclick = () => switchScreen(btn.dataset.target);
});

// Clock
setInterval(() => {
    const d = new Date();
    $('#clock').textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    if(state.startTime && !state.endTime) {
        const diff = Math.floor((Date.now() - state.startTime)/1000);
        const h = Math.floor(diff/3600);
        const m = Math.floor((diff%3600)/60);
        const s = diff%60;
        $('#workTimer').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
}, 1000);

// Init
checkSession();

</script>
</body>
</html>
